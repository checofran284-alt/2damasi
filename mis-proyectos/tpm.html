<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Aforo con Ambiente Sonoro Mejorado</title>
    <!-- Tailwind CSS CDN para un diseño rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <!-- Incluir Tone.js para la generación de audio -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    
    <style>
        /* Variables CSS para la paleta: Verde Menta (Primary) y Azul Acero (Texto/Fondo) */
        :root {
            --color-primary: #10b981; /* Emerald 500 (Verde Menta Suave/Éxito) */
            --color-secondary: #475569; /* Slate 600 (Azul Acero Profundo para Textos) */
            --color-accent: #f97316; /* Orange 600 (Naranja para Warning) */
            --color-background: #f0fdf4; /* Emerald 50 (Fondo muy ligero y limpio) */
            --color-text: #1e293b; /* Slate 900 (Gris oscuro para máximo contraste) */
            --color-success: #059669; /* Verde oscuro (Entrada) */
            --color-danger: #ef4444; /* Rojo (Salida/Error) */
        }

        /* Configuración de Tailwind para usar la fuente Inter */
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: 'var(--color-primary)',
                        secondary: 'var(--color-secondary)',
                        accent: 'var(--color-accent)',
                        success: 'var(--color-success)',
                        danger: 'var(--color-danger)',
                        background: 'var(--color-background)',
                    }
                }
            }
        }
        
        body {
            font-family: var(--font-main);
            background-color: var(--color-background);
            color: var(--color-text);
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        /* Estilo general de la tarjeta contenedora */
        .main-card {
            background-color: white;
            max-width: 960px; 
            width: 100%;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            overflow: hidden; 
        }
        
        /* Estilos de Fachada */
        #facade-visual {
            width: 100%;
            height: 200px; 
            background-color: #ecfdf5; /* Verde Menta muy claro */
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--color-secondary); 
        }
        
        #facade-visual::before {
            content: "CAFETERÍA EL GRANO DORADO";
            position: absolute;
            top: 25px; 
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 18px; 
            background-color: var(--color-primary);
            color: white;
            font-weight: 900;
            font-size: 1.4rem; 
            border-radius: 6px;
            letter-spacing: 2px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4); 
            z-index: 10;
        }

        #door-status {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 150px;
            background-color: #78350f; /* Marrón para la puerta */
            border-top: 5px solid #573319;
            border-radius: 5px 5px 0 0;
            transition: background-color 0.5s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .door-full {
            background-color: var(--color-danger) !important;
            animation: pulse-danger 1s infinite alternate;
        }

        @keyframes pulse-danger {
            from { opacity: 1; }
            to { opacity: 0.8; }
        }
        
        /* Animación para baja ocupación */
        @keyframes pulse-low {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        .low-pulse {
            animation: pulse-low 3s infinite ease-in-out;
        }

        .window {
            position: absolute;
            top: 70px;
            width: 70px;
            height: 70px;
            background-color: #ccfbf1; /* Tono de vidrio menta suave */
            border: 4px solid var(--color-secondary);
            border-radius: 5px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        #window-left { left: 10%; }
        #window-right { right: 10%; }

        /* Estilos para la animación de la fachada */
        #client-animation {
            position: absolute;
            font-size: 2.2rem;
            bottom: 0px; 
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out; 
            left: -10%; 
        }
        
        .move-in {
            animation: client-in 1s forwards ease-out;
        }

        .move-out {
            animation: client-out 1s forwards ease-in;
        }

        @keyframes client-in {
            0% { left: -10%; opacity: 1; }
            40% { left: 45%; opacity: 1; } 
            100% { left: 55%; opacity: 0; } 
        }
        
        @keyframes client-out {
            0% { left: 45%; opacity: 1; }
            60% { left: 55%; opacity: 1; } 
            100% { left: 110%; opacity: 0; } 
        }


        /* Contador principal */
        #total-display {
            font-size: 6.5rem;
            font-weight: 900;
            line-height: 1;
            text-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: color 0.5s ease; 
        }

        /* Estilos menores */
        .log-area {
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.85rem;
        }
        .log-list-item {
            padding: 3px 0;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .btn-action {
            padding: 1rem 0.5rem;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease; 
        }
        
        /* Estilo para el slider de volumen */
        #volume-slider {
            background-color: var(--color-primary); 
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="main-card">
        
        <!-- PANTALLA DE BIENVENIDA (Inicialmente visible) -->
        <div id="welcome-screen" class="text-center p-12 bg-gray-50">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">Monitor de Aforo y Ambiente Sonoro</h1>
            <p class="text-gray-600 mb-8">Pulsa **Entrar al Local** para activar el control de aforo y el ambiente de sonido de **gente hablando** (requerido por el navegador).</p>
            <button id="enter-button" class="bg-primary hover:bg-success text-white font-semibold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-primary/50">
                🎧 Entrar al Local y Activar
            </button>
        </div>

        <!-- CONTENIDO PRINCIPAL DE LA APP (Inicialmente oculto) -->
        <div id="aforo-app-content" class="hidden">
            
            <!-- SIMULACIÓN DE FACHADA (Encabezado Visual) -->
            <div id="facade-visual">
                <div id="window-left" class="window"></div>
                <div id="door-status" title="Estado de la Puerta (Aforo)"></div>
                <div id="window-right" class="window"></div>
                <div id="client-animation">🚶</div> 
            </div>

            <!-- PANEL DE CONTROL CENTRAL -->
            <div class="p-6 sm:p-8 lg:p-10">

                <header class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-secondary">Monitor de Aforo en Vivo</h1>
                    <p class="text-gray-500 mt-1">Gestión de Tráfico Demográfico y Ventas</p>
                </header>
                
                <!-- SECCIÓN 1: ESTADO EN TIEMPO REAL -->
                <div class="text-center mb-8 p-6 border border-secondary/10 rounded-xl bg-gray-50">
                    <p class="text-sm font-semibold text-secondary uppercase tracking-wider mb-2">Clientes en la Cafetería</p>
                    <span id="total-display" class="block text-primary">0</span>
                    <span id="status-message" class="block text-lg font-semibold h-6 mt-2 text-secondary"></span>

                    <div class="grid grid-cols-2 gap-4 mt-6 pt-4 border-t border-gray-200">
                        <div class="p-3 bg-accent/10 border border-accent/60 rounded-lg shadow-md">
                            <p class="text-xs text-gray-700 font-medium">Ocupación</p>
                            <span id="percentage-display" class="text-2xl font-black text-accent">0%</span>
                        </div>
                        <div class="p-3 bg-secondary/10 border border-secondary/60 rounded-lg shadow-md">
                            <p class="text-xs text-gray-700 font-medium">Máximo Alcanzado</p>
                            <span id="max-reached-display" class="text-2xl font-black text-secondary">0</span>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 2: CONTROLES DE ACCIÓN (Entrada/Salida/Venta/VIP) -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-secondary mb-3">Registrar Flujo y Venta</h3>
                    
                    <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
                        <button class="btn-action bg-success text-white hover:bg-success/80 focus:ring-4 focus:ring-success/50" data-type="child">👦 Niño ENTRA</button>
                        <button class="btn-action bg-success text-white hover:bg-success/80 focus:ring-4 focus:ring-success/50" data-type="youth">🧑 Joven ENTRA</button>
                        <button class="btn-action bg-success text-white hover:bg-success/80 focus:ring-4 focus:ring-success/50" data-type="adult">👨 Adulto ENTRA</button>
                        <button class="btn-action bg-success text-white hover:bg-success/80 focus:ring-4 focus:ring-success/50" data-type="elderly">🧓 Anciano ENTRA</button>
                        <button class="btn-action bg-purple-600 text-white hover:bg-purple-700 focus:ring-4 focus:ring-purple-500/50" id="btn-vip-entry">
                            ⭐ VIP ENTRA
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button class="btn-action bg-danger text-white hover:bg-danger/80 focus:ring-4 focus:ring-danger/50" id="btn-out">
                            <span style="font-size: 1.2em;">−</span> Cliente SALE
                        </button>
                        <button class="btn-action bg-blue-600 text-white hover:bg-blue-700 focus:ring-4 focus:ring-blue-500/50" id="btn-sale">
                            💰 VENTA Registrada
                        </button>
                    </div>
                </div>

                <!-- SECCIÓN 3: CONFIGURACIÓN, ANÁLISIS Y HERRAMIENTAS -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <!-- Columna 1: Configuración Rápida (Aforo, Sonido, Borrado) -->
                    <div class="p-4 bg-primary/10 rounded-xl border border-primary/20">
                        <h4 class="text-sm font-semibold text-secondary mb-3 border-b border-primary/30 pb-2">Configuración Rápida</h4>
                        
                        <!-- AFORO MÁXIMO (EL ELEMENTO QUE DESEABAS CONFIGURAR) -->
                        <div class="flex items-center justify-between mb-4">
                            <label for="max-capacity-input" class="text-sm text-secondary font-medium">Aforo Máximo:</label>
                            <div class="flex space-x-2">
                                <input type="number" id="max-capacity-input" value="50" min="1" max="99" 
                                    class="w-16 p-1.5 text-center border border-gray-300 rounded-lg focus:ring-primary focus:border-primary"
                                    title="Introduce el nuevo límite de aforo (1-99)">
                                
                                <!-- BOTÓN OK CON ESTILO AZUL VIBRANTE Y VISTOSO -->
                                <button class="px-3 py-1 bg-blue-600 text-white font-bold rounded-lg text-sm hover:bg-blue-700 transition shadow-md focus:ring-2 focus:ring-blue-400" id="set-capacity-btn">
                                    OK
                                </button>
                                <!-- FIN DEL BOTÓN DE AFORO ACTUALIZADO -->
                            </div>
                        </div>

                        <!-- CONTROL DE VOLUMEN AMBIENTAL (Integrado) -->
                        <div class="space-y-2 mb-4 pt-2 border-t border-primary/30">
                            <h5 class="text-sm font-semibold text-secondary">Control de Audio</h5>
                            
                            <!-- Selector de Ambiente -->
                            <div class="flex items-center justify-between">
                                <label for="ambience-type-select" class="text-xs font-medium text-gray-700">Tipo de Ambiente:</label>
                                <select id="ambience-type-select" class="p-1 text-sm border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                                    <option value="cafeteria">Cafetería (Murmullo)</option>
                                    <option value="fair">Feria (Sonora)</option>
                                </select>
                            </div>

                            <div class="flex items-center justify-between">
                                <label for="volume-slider" class="text-xs font-medium text-gray-700">Volumen Ambiente:</label>
                                <span id="volume-display" class="text-xs font-bold text-primary">50%</span>
                            </div>
                            <input type="range" id="volume-slider" min="0" max="100" value="50" class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer range-lg">
                            
                            <div class="flex items-center justify-between pt-2">
                                <span class="text-xs font-medium text-gray-700">Audio Activado:</span>
                                <button id="toggle-button" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded-full transition duration-300">
                                    OFF
                                </button>
                            </div>
                        </div>
                        
                        <!-- BOTÓN DE CIERRE/VACÍO TOTAL -->
                        <button class="w-full p-2 mt-2 bg-red-600 text-white font-semibold rounded-lg text-sm hover:bg-red-700 transition focus:ring-4 focus:ring-red-500/50" id="btn-clear-local" title="Borra todos los datos guardados en el navegador.">
                            🔥 VACÍO TOTAL (Cierre)
                        </button>

                    </div>

                    <!-- Columna 2: Totales de Tráfico y Análisis (lg:col-span-2) -->
                    <div class="lg:col-span-2 p-4 bg-gray-50 rounded-xl border border-gray-200">
                        <h4 class="text-sm font-semibold text-secondary mb-3 border-b border-gray-300 pb-2">Análisis de Tráfico Diario</h4>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-4">
                            <div class="p-3 bg-green-50 border-l-4 border-success rounded-lg">
                                <p class="text-xs text-gray-500 font-semibold">Total ENTRADAS</p>
                                <span id="total-entries-display" class="text-xl font-bold text-success">0</span>
                            </div>
                            <div class="p-3 bg-red-50 border-l-4 border-danger rounded-lg">
                                <p class="text-xs text-gray-500 font-semibold">Total SALIDAS</p>
                                <span id="total-exits-display" class="text-xl font-bold text-danger">0</span>
                            </div>
                            <div class="p-3 bg-yellow-50 border-l-4 border-accent rounded-lg">
                                <p class="text-xs text-gray-500 font-semibold">Hora Pico (Entradas)</p>
                                <span id="peak-hour-display" class="text-xl font-bold text-accent">N/A</span>
                            </div>
                            
                            <div class="p-3 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
                                <p class="text-xs text-gray-500 font-semibold">Total VENTAS</p>
                                <span id="total-sales-display" class="text-xl font-bold text-blue-600">0</span>
                            </div>
                            
                            <div class="p-3 bg-purple-50 border-l-4 border-purple-600 rounded-lg">
                                <p class="text-xs text-gray-500 font-semibold">Clientes VIP</p>
                                <span id="vip-entries-display" class="text-xl font-bold text-purple-600">0</span>
                            </div>
                            <div class="hidden sm:block"></div> 
                        </div>
                        
                        <div class="flex justify-between mt-4">
                            <button class="px-4 py-2 bg-accent text-white font-semibold rounded-lg text-sm hover:bg-accent/90 transition" id="btn-reset">
                                Reiniciar Contadores (Turno)
                            </button>
                            <button class="px-4 py-2 bg-secondary text-white font-semibold rounded-lg text-sm hover:bg-secondary/90 transition" id="btn-show-demographics">
                                Mostrar Detalle Demográfico
                            </button>
                        </div>

                        <!-- Detalle Demográfico (Inicialmente oculto) -->
                        <div id="demographic-detail" class="mt-4 p-3 bg-white rounded-lg border border-gray-200 hidden">
                            <p class="text-xs font-semibold text-secondary mb-2">Detalle de Entradas por Grupo:</p>
                            <div class="grid grid-cols-4 gap-2 text-center text-xs">
                                <div class="p-1 bg-gray-50 rounded-md">Niños<span id="entries-child-display" class="block font-bold">0</span></div>
                                <div class="p-1 bg-gray-50 rounded-md">Jóvenes<span id="entries-youth-display" class="block font-bold">0</span></div>
                                <div class="p-1 bg-gray-50 rounded-md">Adultos<span id="entries-adult-display" class="block font-bold">0</span></div>
                                <div class="p-1 bg-gray-50 rounded-md">Ancianos<span id="entries-elderly-display" class="block font-bold">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Columna 3: Registro de Acciones (Log) - Abajo de todo -->
                    <div class="lg:col-span-3 p-4 bg-gray-50 rounded-xl border border-gray-200">
                        <h4 class="text-sm font-semibold text-secondary mb-1 border-b border-gray-300 pb-1">Registro de Acciones Recientes</h4>
                        <div class="log-area">
                            <ul id="log-list" class="list-none p-0 text-left space-y-1">
                                <li class="log-list-item">(Inicial) Sistema cargado.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL PERSONALIZADO (Reemplazo de alert/confirm) -->
    <div id="custom-modal-container" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-60 justify-center items-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center">
            <p id="modal-message" class="text-lg font-medium text-gray-700"></p>
            <div class="modal-buttons flex justify-end space-x-3 mt-5">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-danger text-white font-semibold rounded-lg hover:bg-danger/90 transition">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        // ===================================================
        // JAVASCRIPT VANILLA - Lógica del Contador y Aforo
        // ===================================================
        
        // 1. Variables de Estado de Aforo
        let totalPeople = 0;
        let maxCapacity = 50; 
        let maxCountReached = 0; 
        let totalExits = 0;   
        let totalSales = 0; 
        let totalVIPEntries = 0; 
        let entriesByType = { child: 0, youth: 0, adult: 0, elderly: 0 };
        let hourlyEntryLog = {}; 
        let peakHourData = { count: 0, time: 'N/A' };
        const demographicTypes = ['child', 'youth', 'adult', 'elderly'];
        const maxLogEntries = 6;
        
        // 2. Variables de Estado de Audio (Nuevas y refactorizadas)
        let appInitialized = false;
        let isCrowdPlaying = false; 
        let crowdVolumeDB = -30; 
        let ambienceType = 'cafeteria'; // Nuevo estado: 'cafeteria' o 'fair'
        
        // Componentes de Tone.js
        let noise;          // Fuente principal de ruido (Pink/Brown)
        let ambienceNoise;  // Fuente secundaria de ruido (White Noise para Feria)
        let filter;         // Filtro principal (Lowpass/Bandpass)
        let reverb;         // Reverberación
        let limiter;        // Limitador de picos
        let volume;         // Control de volumen
        let autoFilter;     // Modulador lento (Cafetería)
        let panner;         // AutoPanner (Feria)
        let entrySynth, maxCapacitySynth; // Sintetizadores de feedback

        // 3. Referencias a Elementos del DOM
        const enterButton = document.getElementById('enter-button');
        const welcomeScreen = document.getElementById('welcome-screen');
        const aforoAppContent = document.getElementById('aforo-app-content');
        
        const totalDisplay = document.getElementById('total-display');
        const statusMessage = document.getElementById('status-message');
        const logList = document.getElementById('log-list');

        const btnOut = document.getElementById('btn-out');
        const btnReset = document.getElementById('btn-reset');
        const btnShowDemographics = document.getElementById('btn-show-demographics');
        const demographicDetail = document.getElementById('demographic-detail');
        
        const maxCapacityInput = document.getElementById('max-capacity-input');
        const setCapacityBtn = document.getElementById('set-capacity-btn');
        const btnClearLocal = document.getElementById('btn-clear-local'); 
        
        const doorStatus = document.getElementById('door-status');
        const clientAnimation = document.getElementById('client-animation');
        
        const modalContainer = document.getElementById('custom-modal-container');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm-btn');
        const modalCancel = document.getElementById('modal-cancel-btn');
        
        // Referencias de Audio/Volumen
        const volumeSlider = document.getElementById('volume-slider');
        const volumeDisplay = document.getElementById('volume-display');
        const toggleButton = document.getElementById('toggle-button');
        const ambienceTypeSelect = document.getElementById('ambience-type-select'); // NUEVO
        
        // Referencias de Estadísticas
        const percentageDisplay = document.getElementById('percentage-display');
        const maxReachedDisplay = document.getElementById('max-reached-display');
        const totalEntriesDisplay = document.getElementById('total-entries-display'); 
        const totalExitsDisplay = document.getElementById('total-exits-display');   
        const peakHourDisplay = document.getElementById('peak-hour-display'); 
        const btnVipEntry = document.getElementById('btn-vip-entry'); 
        const btnSale = document.getElementById('btn-sale'); 
        const totalSalesDisplay = document.getElementById('total-sales-display'); 
        const vipEntriesDisplay = document.getElementById('vip-entries-display'); 

        const entriesDisplay = {};
        demographicTypes.forEach(type => {
            entriesDisplay[type] = document.getElementById(`entries-${type}-display`);
        });
        
        // 4. Funciones de Audio
        
        /**
         * Inicializa y conecta todos los nodos de Tone.js (Filtros, Volumen, Synths).
         */
        function setupToneComponents() {
            if (appInitialized) return;
            
            // 1. Efectos generales y volumen
            reverb = new Tone.Reverb({
                decay: 2, 
                preDelay: 0.01,
                wet: 0.4
            }).connect(Tone.Master);
            
            limiter = new Tone.Limiter(-6).connect(reverb);
            volume = new Tone.Volume(crowdVolumeDB).toDestination(); 
            
            filter = new Tone.Filter(); 
            autoFilter = new Tone.AutoFilter();
            panner = new Tone.AutoPanner(0.1);

            // Conexión final: Limiter -> Volume -> Master
            limiter.connect(volume);
            
            // 2. Fuentes de Ruido
            noise = new Tone.Noise("pink"); // Se reconfigura en setAmbience
            ambienceNoise = new Tone.Noise("white"); // Ruido Ambiental Feria
            
            // La fuente secundaria de ruido va directamente al limiter
            ambienceNoise.connect(limiter);
            ambienceNoise.volume.value = -100; // Inicialmente silenciado

            // 3. Feedback de Contador
            entrySynth = new Tone.MembraneSynth().toDestination();
            maxCapacitySynth = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.1, release: 0.5 }
            }).toDestination();
            
            appInitialized = true;
        }

        /**
         * Configura y conecta la cadena de audio para el ambiente seleccionado.
         */
        function setAmbience(newType) {
            if (!appInitialized) return;
            
            const oldType = ambienceType;
            ambienceType = newType;
            
            // Detener y desconectar temporalmente las fuentes principales
            noise.stop();
            autoFilter.stop();
            panner.stop();
            noise.disconnect();
            
            // Desconectar todos los efectos de la cadena (para reconectar limpiamente)
            filter.disconnect();
            autoFilter.disconnect();
            panner.disconnect();
            
            // Conexión base: Filtro/Reverb -> Limiter
            filter.connect(limiter);
            reverb.connect(limiter); 
            
            
            if (ambienceType === 'cafeteria') {
                noise.type = "pink";
                noise.volume.value = -18; 
                
                // Efectos de Cafetería: AutoFilter (movimiento lento), Filtro Lowpass (muffle)
                autoFilter.set({ baseFrequency: 450, octaves: 1.5, frequency: "0.2hz", depth: 0.2 }).start();
                filter.set({ frequency: 600, type: "lowpass" });
                
                // Cadena: Pink Noise -> AutoFilter -> Filter -> Reverb
                noise.connect(autoFilter);
                autoFilter.connect(filter);
                filter.connect(reverb);
                
                // Silenciar ruido secundario de Feria
                ambienceNoise.volume.value = -100;

            } else if (ambienceType === 'fair') {
                noise.type = "brown";
                noise.volume.value = -20; 

                // Efectos de Feria: AutoPanner (movimiento estéreo), Filtro Bandpass (voces caóticas)
                panner.set({ frequency: 0.1, depth: 0.8 }).start(); 
                filter.set({ frequency: 3000, type: "bandpass" });

                // Cadena: Brown Noise -> AutoPanner -> Filter -> Reverb
                noise.connect(panner);
                panner.connect(filter);
                filter.connect(reverb);
                
                // Activar ruido secundario (White Noise) para el caos ambiental
                ambienceNoise.volume.value = -30;
            }
            
            // Si el audio estaba sonando, reiniciarlo con la nueva configuración
            if (isCrowdPlaying) {
                noise.start();
                if(ambienceType === 'fair') ambienceNoise.start();
            } else {
                // Si no estaba sonando, asegurar que la UI muestre OFF
                toggleButton.textContent = 'OFF';
            }
            
            // Update UI y Log
            ambienceTypeSelect.value = newType;
            addLogEntry(`Ambiente cambiado a ${newType === 'fair' ? 'Feria Sonora' : 'Cafetería Murmullo'}.`);
            updateDisplay();
            localStorage.setItem('ambienceType', ambienceType);
        }

        /** Reproduce un sonido de "entrada exitosa". */
        function playEntrySound() {
            if (entrySynth && isCrowdPlaying) {
                entrySynth.triggerAttackRelease("C5", "8n");
            }
        }
        
        /** Reproduce un sonido de "aforo lleno/error". */
        function playMaxCapacitySound() {
            if (maxCapacitySynth && isCrowdPlaying) {
                maxCapacitySynth.triggerAttackRelease("G3", "16n", Tone.now());
                maxCapacitySynth.triggerAttackRelease("C3", "16n", Tone.now() + 0.15);
            }
        }
        
        /**
         * Manejador del botón "Entrar al Local". Inicia el contexto de audio y la reproducción.
         */
        enterButton.addEventListener('click', async () => {
            try {
                // 1. Iniciar el contexto de audio (obligatorio en navegadores)
                await Tone.start();
                
                // 2. Inicializar y conectar los componentes de audio
                setupToneComponents();
                
                // 3. Cargar el estado inicial de ambiente (desde localStorage o 'cafeteria')
                const initialType = localStorage.getItem('ambienceType') || 'cafeteria';
                setAmbience(initialType);
                
                // 4. Si el estado es 'playing', iniciamos los ruidos
                if (isCrowdPlaying) {
                     noise.start();
                     if (initialType === 'fair') ambienceNoise.start();
                }

                // 5. Mostrar la app principal
                welcomeScreen.classList.add('hidden');
                aforoAppContent.classList.remove('hidden');
                
                addLogEntry('Ambiente sonoro y monitor de aforo activados.');

            } catch (error) {
                console.error("Error al iniciar el audio:", error);
            }
        });

        // 5. Funciones de Interfaz de Usuario
        
        /**
         * Alterna el estado de reproducción del ruido de multitud.
         */
        function toggleCrowdAudio() {
            if (!appInitialized) return;

            if (isCrowdPlaying) {
                noise.stop();
                ambienceNoise.stop();
                isCrowdPlaying = false;
                addLogEntry('Murmullo de multitud SILENCIADO.');
            } else {
                noise.start();
                if (ambienceType === 'fair') ambienceNoise.start();
                
                isCrowdPlaying = true;
                addLogEntry(`Ambiente de ${ambienceType === 'fair' ? 'Feria' : 'Cafetería'} REACTIVADO.`);
            }
            updateDisplay();
        }

        /**
         * Actualiza el estado visual de los controles de audio.
         */
        function updateAudioControlsUI() {
            const percentage = volumeSlider.value;
            volumeDisplay.textContent = `${percentage}%`;
            
            if (isCrowdPlaying) {
                toggleButton.textContent = 'ON';
                toggleButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                toggleButton.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                toggleButton.textContent = 'OFF';
                toggleButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                toggleButton.classList.add('bg-red-500', 'hover:bg-red-600');
            }
            ambienceTypeSelect.value = ambienceType;
        }

        // --- Funciones de control de aforo --- 

        function animateCounter(targetValue) {
            const start = parseInt(totalDisplay.textContent, 10);
            const duration = 200; 
            let startTime = null;

            if (start === targetValue) return; 

            const step = (timestamp) => {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                const percentage = Math.min(progress / duration, 1);
                
                const currentValue = Math.floor(start + (targetValue - start) * percentage);

                totalDisplay.textContent = currentValue;

                if (percentage < 1) {
                    requestAnimationFrame(step);
                } else {
                    totalDisplay.textContent = targetValue; 
                }
            };

            requestAnimationFrame(step);
        }

        /** Muestra un modal personalizado, reemplazando alert() y confirm(). */
        function alertUser(message, type, callback = null) {
            modalMessage.textContent = message;
            modalContainer.classList.remove('hidden');
            modalContainer.style.display = 'flex'; 

            modalConfirm.style.display = 'none';
            modalConfirm.onclick = null;
            modalCancel.onclick = null; 

            const closeModal = () => {
                modalContainer.classList.add('hidden');
                modalContainer.style.display = 'none';
            };

            if (type === 'confirm') {
                modalConfirm.style.display = 'inline-block'; 
                modalConfirm.textContent = 'Aceptar'; 
                modalCancel.textContent = 'Cancelar'; 

                modalConfirm.onclick = () => {
                    closeModal();
                    if (callback) callback();
                };
                
                modalCancel.onclick = closeModal;

            } else {
                modalCancel.textContent = 'Cerrar'; 
                modalCancel.onclick = closeModal;
            }
            
            const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--color-text').trim();
            
            modalMessage.style.color = (type === 'error') ? dangerColor : textColor;
        }

        function calculatePeakHour() {
            let maxCount = 0;
            let peakTimeKey = 'N/A';

            for (const key in hourlyEntryLog) {
                if (hourlyEntryLog[key] > maxCount) {
                    maxCount = hourlyEntryLog[key];
                    peakTimeKey = key;
                }
            }

            if (peakTimeKey !== 'N/A') {
                const parts = peakTimeKey.split('-');
                const hour = parts[3];
                const hourInt = parseInt(hour, 10);
                const nextHourInt = (hourInt + 1) % 24;
                
                const formattedHour = `${String(hourInt).padStart(2, '0')}:00 - ${String(nextHourInt).padStart(2, '0')}:00 (${maxCount} Entradas)`;
                peakHourData = { count: maxCount, time: formattedHour };
            } else {
                peakHourData = { count: 0, time: 'N/A' };
            }

            peakHourDisplay.textContent = peakHourData.time;
        }

        /**
         * Actualiza todos los displays, estado visual y guarda en localStorage.
         */
        function updateDisplay() {
            // 1. Animamos el contador
            animateCounter(totalPeople);
            if (totalPeople < 0) { totalPeople = 0; }
            
            const totalEntries = demographicTypes.reduce((sum, type) => sum + entriesByType[type], 0);
            
            // 2. Guardar todos los estados en localStorage
            localStorage.setItem('cafeCounter', totalPeople);
            localStorage.setItem('cafeMaxCapacity', maxCapacity);
            localStorage.setItem('maxCountReached', maxCountReached); 
            localStorage.setItem('entriesByType', JSON.stringify(entriesByType));
            localStorage.setItem('totalExits', totalExits);     
            localStorage.setItem('hourlyEntryLog', JSON.stringify(hourlyEntryLog));
            localStorage.setItem('totalSales', totalSales); 
            localStorage.setItem('totalVIPEntries', totalVIPEntries); 
            localStorage.setItem('isCrowdPlaying', isCrowdPlaying);
            localStorage.setItem('crowdVolumeDB', crowdVolumeDB);
            localStorage.setItem('ambienceType', ambienceType);


            // 3. Actualizar el Máximo Histórico Alcanzado
            if (totalPeople > maxCountReached) { maxCountReached = totalPeople; }
            maxReachedDisplay.textContent = maxCountReached;

            // 4. Calcular y mostrar Porcentaje de Ocupación
            const percentage = maxCapacity > 0 ? ((totalPeople / maxCapacity) * 100).toFixed(0) : 0;
            percentageDisplay.textContent = `${percentage}%`;
            
            // 5. Actualizar contadores de tráfico, HORA PICO y MÉTRICAS
            totalEntriesDisplay.textContent = totalEntries;
            totalExitsDisplay.textContent = totalExits;
            totalSalesDisplay.textContent = totalSales; 
            vipEntriesDisplay.textContent = totalVIPEntries; 
            
            calculatePeakHour(); 

            demographicTypes.forEach(type => {
                entriesDisplay[type].textContent = entriesByType[type];
            });

            // 6. Actualización de Estado Visual (Puerta y Mensaje)
            const remaining = maxCapacity - totalPeople;
            
            totalDisplay.classList.remove('text-primary', 'text-accent', 'text-danger', 'animate-pulse', 'low-pulse');
            doorStatus.classList.remove('door-full');
            doorStatus.textContent = '';


            if (totalPeople >= maxCapacity) {
                totalDisplay.classList.add('text-danger', 'animate-pulse');
                statusMessage.textContent = `¡AFORO LLENO! Max: ${maxCapacity}`;
                doorStatus.classList.add('door-full');
                doorStatus.textContent = 'COMPLETO';
                playMaxCapacitySound(); 
            } else if (totalPeople >= maxCapacity * 0.8) {
                totalDisplay.classList.add('text-accent');
                statusMessage.textContent = `ATENCIÓN: Cerca del límite. Quedan ${remaining} cupos.`;
            } else {
                totalDisplay.classList.add('text-primary', 'low-pulse');
                statusMessage.textContent = `Disponible. Quedan ${remaining} cupos.`;
            }
            
            // 7. Actualizar controles de audio
            updateAudioControlsUI();
        }

        function addLogEntry(message, type = 'info') {
            const now = new Date();
            const dateString = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const timeString = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const li = document.createElement('li');
            li.textContent = `[${dateString} ${timeString}] ${message}`;
            li.classList.add('log-list-item');

            if (type === 'error') {
                li.classList.add('text-danger', 'font-semibold');
            } else if (type === 'info') {
                li.classList.add('text-gray-700');
            }
            
            logList.prepend(li); 
            
            while (logList.children.length > maxLogEntries) {
                logList.removeChild(logList.lastChild);
            }
        }

        function handleEntry(type) {
            const typeNames = { child: 'Niño', youth: 'Joven', adult: 'Adulto', elderly: 'Anciano' };
            const typeName = typeNames[type] || 'Cliente';

            if (totalPeople < maxCapacity) {
                totalPeople += 1;
                entriesByType[type] += 1;
                
                const now = new Date();
                const hourKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}`;
                
                hourlyEntryLog[hourKey] = (hourlyEntryLog[hourKey] || 0) + 1;
                
                updateDisplay();
                addLogEntry(`[+1] ${typeName} ENTRA. Total: ${totalPeople}`);
                playEntrySound();

                clientAnimation.style.opacity = '1';
                clientAnimation.classList.remove('move-out');
                clientAnimation.classList.add('move-in');
                
                setTimeout(() => {
                    clientAnimation.classList.remove('move-in');
                }, 1000); 

            } else {
                addLogEntry(`[ERROR] Aforo MÁXIMO (${maxCapacity}) alcanzado.`, 'error');
                updateDisplay();
                alertUser('¡Aforo Máximo Alcanzado! Por favor, espera a que salga un cliente.', 'error');
            }
        }
        
        function handleVIPEntry() {
            const type = 'adult'; 
            if (totalPeople < maxCapacity) {
                totalVIPEntries += 1; 
                totalPeople += 1;
                entriesByType[type] += 1; 
                
                const now = new Date();
                const hourKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}`;
                hourlyEntryLog[hourKey] = (hourlyEntryLog[hourKey] || 0) + 1;
                
                updateDisplay();
                addLogEntry(`[+1 VIP] Cliente VIP ENTRA. Total: ${totalPeople}.`, 'info');
                playEntrySound();
                
                clientAnimation.style.opacity = '1';
                clientAnimation.classList.remove('move-out');
                clientAnimation.classList.add('move-in');
                
                setTimeout(() => {
                    clientAnimation.classList.remove('move-in');
                }, 1000); 

            } else {
                addLogEntry(`[ERROR] Aforo MÁXIMO (${maxCapacity}) alcanzado. No entra VIP.`, 'error');
                updateDisplay();
                alertUser('¡Aforo Máximo Alcanzado! El cliente VIP debe esperar.', 'error');
            }
        }

        function handleSale() {
            totalSales += 1;
            updateDisplay();
            addLogEntry(`[+1 VENTA] Venta registrada. Total Ventas: ${totalSales}.`, 'info');
        }

        function handleOut() {
            if (totalPeople > 0) {
                totalPeople -= 1;
                totalExits += 1;
                updateDisplay();
                addLogEntry(`[-1] Cliente SALE. Total: ${totalPeople}`);
                
                clientAnimation.style.opacity = '1';
                clientAnimation.classList.remove('move-in');
                clientAnimation.classList.add('move-out');
                
                setTimeout(() => {
                    clientAnimation.classList.remove('move-out');
                    clientAnimation.style.left = '-10%';
                }, 1000); 
                
            } else {
                 addLogEntry(`[AVISO] Contador ya está en cero. No se puede restar.`, 'info');
            }
        }

        function handleReset() {
            alertUser('¿Estás seguro de que deseas reiniciar todos los contadores? Esto no se puede deshacer.', 'confirm', () => {
                
                const oldEntries = demographicTypes.reduce((sum, type) => sum + entriesByType[type], 0);
                const oldExits = totalExits;
                const oldSales = totalSales; 
                const oldVIPs = totalVIPEntries; 

                totalPeople = 0;
                maxCountReached = 0;
                totalExits = 0;
                totalSales = 0; 
                totalVIPEntries = 0; 
                
                demographicTypes.forEach(type => entriesByType[type] = 0);
                hourlyEntryLog = {};
                peakHourData = { count: 0, time: 'N/A' };
                
                updateDisplay();
                addLogEntry(`Contadores REINICIADOS. Tráfico anterior: E:${oldEntries}, S:${oldExits}, V:${oldSales}, VIP:${oldVIPs}.`);
            });
        }
        
        function handleClearLocal() {
            alertUser('⚠️ ADVERTENCIA: Esta acción BORRARÁ TODOS los datos guardados (aforo, contadores, logs) del navegador. ¿Deseas continuar con el Cierre?', 'confirm', () => {
                
                // Borrar todas las claves
                localStorage.clear();
                
                // Reinicializar las variables de estado
                totalPeople = 0;
                maxCapacity = 50; 
                maxCountReached = 0; 
                totalExits = 0;   
                isCrowdPlaying = true;
                crowdVolumeDB = -30;
                ambienceType = 'cafeteria'; // Reset al default
                totalSales = 0; 
                totalVIPEntries = 0; 
                demographicTypes.forEach(type => entriesByType[type] = 0);
                hourlyEntryLog = {};
                
                // Reinicializar audio si está activo
                if(appInitialized) {
                    // Dispose y reinicializar componentes para un estado limpio
                    noise.dispose(); ambienceNoise.dispose(); filter.dispose(); reverb.dispose(); limiter.dispose(); volume.dispose(); autoFilter.dispose(); panner.dispose();
                    entrySynth.dispose(); maxCapacitySynth.dispose();
                    appInitialized = false;
                    
                    setupToneComponents(); // Vuelve a inicializar nodos
                    setAmbience(ambienceType); // Carga la configuración 'cafeteria'
                } 
                
                logList.innerHTML = '<li class="log-list-item">(Inicial) Sistema cargado.</li>';
                addLogEntry('🔥 Borrado TOTAL de LocalStorage completado. Estado de fábrica restaurado.');
                loadInitialState(); // Recarga el estado visual
            });
        }
        
        /**
         * FUNCIÓN CLAVE: Lee el valor del input y actualiza el aforo máximo.
         */
        function setCapacity() {
            const newCapacity = parseInt(maxCapacityInput.value, 10);
            
            // Validación de la entrada
            if (!isNaN(newCapacity) && newCapacity > 0 && newCapacity <= 99) {
                // 1. Actualiza la variable de estado
                maxCapacity = newCapacity;
                
                // 2. Ajusta el máximo alcanzado si el nuevo aforo es menor que el máximo histórico.
                if (maxCountReached > maxCapacity) {
                    maxCountReached = maxCapacity;
                }

                // 3. Vuelve a dibujar la interfaz y guarda en localStorage
                updateDisplay();
                addLogEntry(`Aforo Máximo establecido en ${maxCapacity}.`);
                alertUser(`Aforo Máximo actualizado a ${maxCapacity}.`, 'info');
            } else {
                // 4. Si la entrada no es válida, restaurar el valor anterior en el input
                maxCapacityInput.value = maxCapacity; 
                alertUser('Por favor, introduce un número válido (1-99) para el Aforo Máximo.', 'error');
            }
        }

        function toggleDemographicDetail() {
            if (demographicDetail.classList.contains('hidden')) {
                demographicDetail.classList.remove('hidden');
                btnShowDemographics.textContent = 'Ocultar Detalle Demográfico';
            } else {
                demographicDetail.classList.add('hidden');
                btnShowDemographics.textContent = 'Mostrar Detalle Demográfico';
            }
        }


        function loadInitialState() {
            const savedCount = localStorage.getItem('cafeCounter');
            const savedCapacity = localStorage.getItem('cafeMaxCapacity');
            const savedMaxReached = localStorage.getItem('maxCountReached'); 
            const savedEntriesByType = localStorage.getItem('entriesByType'); 
            const savedExits = localStorage.getItem('totalExits');
            const savedHourlyLog = localStorage.getItem('hourlyEntryLog');
            const savedSales = localStorage.getItem('totalSales'); 
            const savedVIPEntries = localStorage.getItem('totalVIPEntries'); 
            const savedCrowdPlaying = localStorage.getItem('isCrowdPlaying');
            const savedCrowdVolumeDB = localStorage.getItem('crowdVolumeDB');
            const savedAmbienceType = localStorage.getItem('ambienceType');


            if (savedCount !== null && !isNaN(parseInt(savedCount))) { totalPeople = parseInt(savedCount, 10); }
            if (savedCapacity !== null && !isNaN(parseInt(savedCapacity))) { maxCapacity = parseInt(savedCapacity, 10); }
            if (savedMaxReached !== null && !isNaN(parseInt(savedMaxReached))) { maxCountReached = parseInt(savedMaxReached, 10); }
            if (savedSales !== null && !isNaN(parseInt(savedSales))) { totalSales = parseInt(savedSales, 10); }
            if (savedVIPEntries !== null && !isNaN(parseInt(savedVIPEntries))) { totalVIPEntries = parseInt(savedVIPEntries, 10); }
            if (savedExits !== null && !isNaN(parseInt(savedExits))) { totalExits = parseInt(savedExits, 10); }
            
            // Cargar estado de audio
            if (savedCrowdPlaying !== null) { isCrowdPlaying = savedCrowdPlaying === 'true'; }
            if (savedCrowdVolumeDB !== null && !isNaN(parseFloat(savedCrowdVolumeDB))) { crowdVolumeDB = parseFloat(savedCrowdVolumeDB); }
            if (savedAmbienceType !== null) { ambienceType = savedAmbienceType; }


            if (savedEntriesByType !== null) {
                try {
                    const parsedEntries = JSON.parse(savedEntriesByType);
                    demographicTypes.forEach(type => {
                        if (parsedEntries.hasOwnProperty(type) && !isNaN(parseInt(parsedEntries[type]))) {
                            entriesByType[type] = parseInt(parsedEntries[type], 10);
                        }
                    });
                } catch (e) { console.error("Error al parsear entriesByType:", e); }
            }
            
             if (savedHourlyLog !== null) {
                try {
                    hourlyEntryLog = JSON.parse(savedHourlyLog);
                } catch (e) { console.error("Error al parsear hourlyEntryLog:", e); hourlyEntryLog = {}; }
            }
            
            maxCapacityInput.value = maxCapacity; 
            ambienceTypeSelect.value = ambienceType;
            
            // Configurar slider de volumen
            const initialPercentage = Math.round(((crowdVolumeDB + 60) / 60) * 100);
            volumeSlider.value = initialPercentage;

            totalDisplay.textContent = totalPeople;
            updateDisplay();
            addLogEntry(`Sistema cargado. Aforo Máximo: ${maxCapacity}.`);
        }


        // 6. Asignación de Event Listeners
        
        document.querySelectorAll('.grid button[data-type]').forEach(button => {
            button.addEventListener('click', (event) => {
                const type = event.target.closest('button').dataset.type;
                handleEntry(type);
            });
        });

        btnOut.addEventListener('click', handleOut);
        btnVipEntry.addEventListener('click', handleVIPEntry); 
        btnSale.addEventListener('click', handleSale); 
        btnReset.addEventListener('click', handleReset);
        
        // Listener para el botón OK del Aforo Máximo
        setCapacityBtn.addEventListener('click', setCapacity); 
        
        btnShowDemographics.addEventListener('click', toggleDemographicDetail);
        btnClearLocal.addEventListener('click', handleClearLocal); 
        
        // Listeners de Audio
        volumeSlider.addEventListener('input', (event) => {
            const percentage = parseInt(event.target.value, 10);
            
            // Mapeamos 0-100 a -60dB (silencio) a 0dB (máx)
            const dbValue = (percentage / 100) * 60 - 60; 
            crowdVolumeDB = dbValue;
            
            if (appInitialized && volume) {
                volume.volume.value = dbValue;
                localStorage.setItem('crowdVolumeDB', crowdVolumeDB);
            }
            updateDisplay();
        });

        toggleButton.addEventListener('click', toggleCrowdAudio);
        
        ambienceTypeSelect.addEventListener('change', (event) => {
            const newType = event.target.value;
            if (appInitialized) {
                setAmbience(newType);
            } else {
                // Si no se ha inicializado Tone, solo guardamos el estado y actualizamos la UI
                ambienceType = newType;
                localStorage.setItem('ambienceType', ambienceType);
                updateAudioControlsUI();
                addLogEntry(`Ambiente de audio preseleccionado: ${newType === 'fair' ? 'Feria Sonora' : 'Cafetería Murmullo'}.`);
            }
        });

        // 7. Inicialización
        window.onload = () => {
            loadInitialState();
            
            // Si el estado de audio estaba como 'playing' o el contexto ya estaba running,
            // iniciamos la app directamente para evitar un segundo click.
            if (Tone.context.state === 'running' || localStorage.getItem('isCrowdPlaying') === 'true') {
                 // Usamos un pequeño timeout para asegurar que el DOM esté completamente listo
                 setTimeout(() => {
                    enterButton.click();
                 }, 100);
            }
        };

    </script>
</body>
</html>
