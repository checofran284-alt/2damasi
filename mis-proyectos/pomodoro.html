<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El reloj del Chua</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-from: #111827; --bg-via: #1e1b4b; --bg-to: #312e81;
            --orb1-color: #a855f7; --orb2-color: #6366f1;
            --accent-color: #8b5cf6; --accent-text-color: #c4b5fd;
            --title-color: #a78bfa; --button-bg-color: #7c3aed;
            --button-hover-bg-color: #6d28d9; --mascot-bg-color: #2e1065;
            --label-text-color: #d1d5db; --tab-inactive-color: #94a3b8;
        }
        .theme-medium {
            --bg-from: #0c4a6e; --bg-via: #164e63; --bg-to: #115e59;
            --orb1-color: #0ea5e9; --orb2-color: #14b8a6;
            --accent-color: #22d3ee; --accent-text-color: #67e8f9;
            --title-color: #2dd4bf; --button-bg-color: #0891b2;
            --button-hover-bg-color: #0e7490; --mascot-bg-color: #134e4a;
            --label-text-color: #e0f2fe; --tab-inactive-color: #bae6fd;
        }
        .theme-hard {
            --bg-from: #450a0a; --bg-via: #7f1d1d; --bg-to: #7f1d1d;
            --orb1-color: #f97316; --orb2-color: #ef4444;
            --accent-color: #f59e0b; --accent-text-color: #fbbf24;
            --title-color: #facc15; --button-bg-color: #ea580c;
            --button-hover-bg-color: #c2410c; --mascot-bg-color: #78350f;
            --label-text-color: #fef3c7; --tab-inactive-color: #fde68a;
        }
        .theme-custom {
            --bg-from: #0f172a; --bg-via: #581c87; --bg-to: #831843;
            --orb1-color: #be185d; --orb2-color: #7e22ce;
            --accent-color: #f472b6; --accent-text-color: #f9a8d4;
            --title-color: #e879f9; --button-bg-color: #db2777;
            --button-hover-bg-color: #be185d; --mascot-bg-color: #701a75;
            --label-text-color: #fbcfe8; --tab-inactive-color: #fce7f3;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(to bottom right, var(--bg-from), var(--bg-via), var(--bg-to));
            transition: background-image 0.5s ease-in-out;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }
        .main-container { height: 100vh; overflow-y: auto; overflow-x: hidden; scrollbar-width: none; }
        .main-container::-webkit-scrollbar { display: none; }
        .timer-knob { transform-origin: bottom center; }
        .progress-ring-circle { 
            transition: stroke-dashoffset 1s linear, color 0.5s; 
            transform: rotate(-90deg); transform-origin: 50% 50%; 
            color: var(--accent-color);
            filter: drop-shadow(0 0 5px var(--accent-color));
        }
        #settings-content label { color: var(--label-text-color); transition: color 0.5s; }
        #level-selector input:checked + label { background-color: var(--accent-color); color: #0f172a; font-weight: bold; }
        .title-font { font-family: 'Orbitron', sans-serif; text-transform: uppercase; text-shadow: 0 0 8px var(--accent-text-color), 0 0 2px var(--accent-text-color); color: var(--title-color); transition: color 0.5s, text-shadow 0.5s; }
        .bg-orb { position: absolute; z-index: -1; border-radius: 50%; filter: blur(120px); opacity: 0.3; transition: background-color 0.5s; }
        .orb1 { width: 450px; height: 450px; background: var(--orb1-color); top: -10%; left: -10%; animation: move-orb1 25s infinite alternate; }
        .orb2 { width: 400px; height: 400px; background: var(--orb2-color); bottom: -10%; right: -10%; animation: move-orb2 30s infinite alternate; }
        @keyframes move-orb1 { from { transform: translate(0, 0) scale(1); } to { transform: translate(50px, 80px) scale(1.1); } }
        @keyframes move-orb2 { from { transform: translate(0, 0) scale(1); } to { transform: translate(-80px, -40px) scale(1.1); } }
        .tab-btn { transition: color 0.5s, border-color 0.5s; color: var(--tab-inactive-color); }
        .tab-btn.active { color: var(--title-color) !important; border-color: var(--title-color) !important; border-bottom-width: 2px; }
        #focus-message { animation: focus-fade 2.5s ease-in-out forwards; }
        @keyframes focus-fade { 0% { transform: scale(0.8); opacity: 0; } 20% { transform: scale(1); opacity: 1; } 80% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.2); opacity: 0; } }
        
        #start-pause-btn:hover { box-shadow: 0 0 20px var(--button-bg-color), 0 0 5px var(--button-bg-color); }

        /* Kanban Styles */
        .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
        .kanban-column { background-color: rgba(255,255,255,0.05); border-radius: 0.5rem; padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .kanban-column h3 { font-size: 0.875rem; font-weight: 600; text-align: center; padding-bottom: 0.5rem; color: var(--accent-text-color); }
        .kanban-tasks { list-style: none; padding: 0; min-height: 100px; max-height: 150px; overflow-y: auto; }
        .kanban-tasks::-webkit-scrollbar { width: 4px; }
        .kanban-tasks::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        .task-item { background-color: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 0.375rem; margin-bottom: 0.5rem; cursor: pointer; user-select: none; border: 1px solid transparent; transition: all 0.2s; }
        .task-item:hover { background-color: rgba(0,0,0,0.5); border-color: var(--accent-color); transform: scale(1.03); }
        .task-item span { color: #e2e8f0; } /* slate-200 */
        .task-item .edit-btn, .task-item .delete-btn { opacity: 0; transition: opacity 0.2s; }
        .task-item:hover .edit-btn, .task-item:hover .delete-btn { opacity: 1; }
        #tasks-content .kanban-column[data-status="done"] .task-item span { text-decoration: line-through; color: #64748b; }
    </style>
</head>
<body class="theme-basic">

    <div class="bg-orb orb1"></div>
    <div class="bg-orb orb2"></div>
    
    <div class="main-container flex items-center justify-center p-4">
        <div class="relative w-full max-w-lg mx-auto">
            
             <div class="absolute top-0 right-0 p-4 z-20">
                <button id="mute-btn" class="w-10 h-10 flex items-center justify-center bg-slate-800/50 rounded-full text-slate-400 hover:text-white transition-colors backdrop-blur-sm">
                    <!-- SVG icon will be injected here -->
                </button>
            </div>

            <div id="focus-overlay" class="absolute inset-x-0 top-0 flex items-start justify-center pt-24 opacity-0 pointer-events-none z-50">
                <h2 id="focus-message" class="text-7xl font-bold text-white/80" style="text-shadow: 0 0 15px rgba(255,255,255,0.5);"></h2>
            </div>

            <h1 class="title-font text-3xl font-bold text-center mb-2">El reloj del Chua</h1>
            <p id="status-display" class="text-center text-slate-400 mb-4 text-lg">Gira la manilla para empezar</p>

            <div id="mascot-container" class="relative w-80 mx-auto">
                 <div id="speech-bubble" class="absolute top-8 -right-4 translate-x-full w-48 bg-slate-800/50 backdrop-blur-sm border border-slate-700/50 text-center rounded-lg p-3 text-sm opacity-0 transition-opacity duration-300 pointer-events-none shadow-lg" style="color: var(--accent-text-color)">
                    <p id="mascot-message"></p>
                    <div class="absolute left-0 top-4 -translate-x-full w-0 h-0 border-y-8 border-y-transparent border-r-8 border-r-slate-700/50"></div>
                </div>

                <div id="timer-container" class="relative w-72 h-72 cursor-pointer rounded-full bg-slate-800/60 backdrop-blur-xl border border-slate-700/50 shadow-2xl shadow-black/30 flex items-center justify-center">
                    <svg class="absolute w-full h-full" viewBox="0 0 100 100">
                        <defs><filter id="innershadow"><feFlood flood-color="black" result="flood"/><feComposite in="flood" in2="SourceGraphic" operator="in" result="composite1"/><feGaussianBlur in="composite1" stdDeviation="2" result="blur"/><feOffset dx="2" dy="2" result="offset"/><feComposite in="SourceGraphic" in2="offset" operator="out" result="composite2"/></filter></defs>
                        <circle class="text-slate-700/50" stroke-width="5" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" style="filter:url(#innershadow);"/>
                        <circle id="progress-ring" class="progress-ring-circle" stroke-width="5" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    </svg>
                    <div id="knob" class="timer-knob absolute bottom-1/2 left-1/2 -ml-1 w-2 h-1/2 rounded-t-full bg-slate-400">
                        <div class="w-4 h-4 rounded-full absolute -top-2 -left-1" style="background-color: var(--accent-color); transition: background-color 0.5s;"></div>
                    </div>
                    
                    <svg id="mascot" class="w-40 h-40 z-20 overflow-visible" viewBox="0 0 100 100">
                        <g id="mascot-body" class="transition-all duration-500">
                            <circle cx="50" cy="50" r="40" style="fill: var(--mascot-bg-color); transition: fill 0.5s;" />
                            <g id="mascot-eyes-group" class="transform-origin-center">
                                <circle cx="40" cy="45" r="6" fill="white" />
                                <circle cx="60" cy="45" r="6" fill="white" />
                                <circle cx="42" cy="46" r="2.5" fill="black" />
                                <circle cx="62" cy="46" r="2.5" fill="black" />
                            </g>
                            <path id="mascot-mouth" d="M 40 68 Q 50 73 60 68" stroke="#f1f5f9" stroke-width="3" fill="none" stroke-linecap="round" class="transition-all duration-300"/>
                        </g>
                    </svg>
                </div>
                <p class="text-center font-semibold mt-2 text-lg" style="color: var(--accent-text-color)">SR. CHUA</p>
            </div>
            
            <div class="text-center mt-1">
                <div id="time-display" class="text-6xl font-bold text-slate-100 tabular-nums">25:00</div>
            </div>
            
            <div class="flex flex-col items-center space-y-4 mt-4">
                <div class="flex space-x-4">
                    <button id="start-pause-btn" class="text-slate-100 font-bold py-3 px-8 rounded-full shadow-lg transition-all transform active:scale-95 disabled:bg-slate-700 disabled:cursor-not-allowed" style="background-color: var(--button-bg-color);">Iniciar</button>
                    <button id="reset-btn" class="bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold py-3 px-8 rounded-full shadow-lg transition-transform transform active:scale-95">Reset</button>
                </div>
            </div>

            <div class="w-full max-w-lg mx-auto mt-6 pb-8">
                 <div class="flex border-b border-slate-700">
                    <button data-tab="settings" class="tab-btn flex-1 py-2 text-center font-semibold active">Ajustes</button>
                    <button data-tab="tasks" class="tab-btn flex-1 py-2 text-center font-semibold">Tareas</button>
                    <button data-tab="music" class="tab-btn flex-1 py-2 text-center font-semibold">Música</button>
                </div>
                
                <div id="tab-content" class="pt-4 bg-slate-800/40 backdrop-blur-xl rounded-b-lg border border-slate-700/50 border-t-0 p-4 shadow-inner">
                    <div id="settings-content" class="tab-pane w-full max-w-xs mx-auto space-y-4"></div>
                    <div id="tasks-content" class="tab-pane hidden"></div>
                    <div id="music-content" class="tab-pane hidden space-y-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl border border-slate-700 w-full max-w-sm mx-4">
            <h3 class="text-lg font-bold text-slate-100 mb-2">Confirmar Acción</h3>
            <p class="text-slate-400 mb-6">¿Estás seguro de que quieres borrar todas las tareas?</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-reset" class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-md text-sm font-semibold transition-colors">Cancelar</button>
                <button id="confirm-reset" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-md text-sm font-semibold transition-colors">Borrar</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- HTML INJECTION ---
        document.getElementById('settings-content').innerHTML = `
            <div>
                <label class="block text-center text-sm font-medium mb-2">Nivel (tiempo máx.)</label>
                <div id="level-selector" class="grid grid-cols-4 gap-1 rounded-lg bg-slate-800 p-1 border border-slate-700">
                   <input type="radio" name="level" id="level-basic" value="60" class="sr-only peer" checked><label for="level-basic" class="text-center text-sm p-2 rounded-md transition-colors cursor-pointer hover:bg-slate-700">Básico</label>
                   <input type="radio" name="level" id="level-medium" value="120" class="sr-only peer"><label for="level-medium" class="text-center text-sm p-2 rounded-md transition-colors cursor-pointer hover:bg-slate-700">Medio</label>
                   <input type="radio" name="level" id="level-hard" value="240" class="sr-only peer"><label for="level-hard" class="text-center text-sm p-2 rounded-md transition-colors cursor-pointer hover:bg-slate-700">Difícil</label>
                   <input type="radio" name="level" id="level-custom" value="300" class="sr-only peer"><label for="level-custom" class="text-center text-sm p-2 rounded-md transition-colors cursor-pointer hover:bg-slate-700">Total</label>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="cycles-count" class="block text-center text-sm font-medium mb-2">Ciclos Trabajo</label>
                    <input type="number" id="cycles-count" value="3" min="1" class="bg-slate-800 border border-slate-700 text-slate-200 text-center text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5">
                </div>
                <div>
                    <label for="break-cycles-count" class="block text-center text-sm font-medium mb-2">Ciclos Descanso</label>
                    <input type="number" id="break-cycles-count" value="2" min="0" class="bg-slate-800 border border-slate-700 text-slate-200 text-center text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5">
                </div>
            </div>
             <div>
                <label for="break-duration" class="block text-center text-sm font-medium mb-2">Duración Descanso (min)</label>
                <input type="number" id="break-duration" value="5" min="1" class="bg-slate-800 border border-slate-700 text-slate-200 text-center text-sm rounded-lg focus:ring-violet-500 focus:border-violet-500 block w-full p-2.5">
            </div>`;
        document.getElementById('tasks-content').innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <div id="task-progress-container" class="space-y-1 flex-grow">
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>Progreso</span>
                        <span id="task-progress-text">0%</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2.5">
                        <div id="task-progress-bar" class="h-2.5 rounded-full transition-all duration-300" style="width: 0%; background-color: var(--accent-color);"></div>
                    </div>
                </div>
                <button id="reset-tasks-btn" class="ml-4 text-xs bg-red-800/50 text-red-300 hover:bg-red-800/80 rounded-md px-2 py-1 transition-colors">Resetear</button>
            </div>
            <form id="task-form" class="flex gap-2 mb-4">
                <input type="text" id="task-input" placeholder="Añadir nueva tarea..." class="flex-grow bg-slate-900/70 border border-slate-700 rounded-lg p-2.5 text-sm focus:ring-violet-500 focus:border-violet-500 placeholder-slate-400 text-slate-200">
                <button type="submit" class="text-slate-100 font-bold p-2.5 rounded-lg text-sm transition-colors" style="background-color: var(--button-bg-color);">Añadir</button>
            </form>
            <div class="kanban-board">
                <div class="kanban-column" data-status="todo">
                    <h3>Por Hacer</h3>
                    <ul class="kanban-tasks"></ul>
                </div>
                <div class="kanban-column" data-status="inprogress">
                    <h3>En Progreso</h3>
                    <ul class="kanban-tasks"></ul>
                </div>
                <div class="kanban-column" data-status="done">
                    <h3>Hecho</h3>
                    <ul class="kanban-tasks"></ul>
                </div>
            </div>`;
        document.getElementById('music-content').innerHTML = `
             <p class="text-sm text-center text-slate-500">Pega un enlace de YouTube o sube un archivo local.</p>
             <div class="flex gap-2">
                <input type="text" id="youtube-url" placeholder="URL de YouTube" class="flex-grow bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-sm focus:ring-violet-500 focus:border-violet-500 placeholder-slate-400 text-slate-200">
                <button id="load-youtube" class="bg-slate-700 hover:bg-slate-600 p-2.5 rounded-lg text-sm">Cargar</button>
             </div>
             <div class="text-center">
                 <label for="local-file" class="cursor-pointer bg-slate-700 hover:bg-slate-600 py-2 px-4 rounded-lg text-sm font-bold text-center inline-block">Subir archivo</label>
                 <input type="file" id="local-file" accept="audio/*" class="hidden">
             </div>
             <div id="player-ui" class="hidden mt-4 p-4 bg-slate-900/50 backdrop-blur-md border border-slate-700/50 rounded-lg space-y-3">
                <div id="youtube-player-container" class="w-full aspect-video rounded-lg overflow-hidden bg-slate-700 shadow-inner">
                   <div id="youtube-player"></div>
                </div>
                <p id="track-info" class="text-sm text-slate-400 truncate w-full text-center"></p>
                <div class="flex items-center justify-center gap-4 text-2xl">
                    <button id="music-rewind" class="transition-colors" style="color: var(--accent-text-color)">⏮</button>
                    <button id="music-play-pause" class="text-slate-100 font-bold w-12 h-12 rounded-full flex items-center justify-center text-3xl leading-none transition-colors" style="background-color: var(--button-bg-color);">▶</button>
                    <button id="music-forward" class="transition-colors" style="color: var(--accent-text-color)">⏭</button>
                </div>
                <div class="flex items-center gap-3 px-4">
                    <svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a1 1 0 00-2 0v12a1 1 0 102 0V4zM13 4a1 1 0 00-2 0v12a1 1 0 102 0V4z"/></svg>
                    <input type="range" id="volume-slider" min="0" max="100" value="100" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
             <audio id="audio-player" class="hidden"></audio>`;

        // --- DOM SELECTION & STATE ---
        const timerContainer = document.getElementById('timer-container');
        const mascotContainer = document.getElementById('mascot-container');
        const knob = document.getElementById('knob');
        const timeDisplay = document.getElementById('time-display');
        const statusDisplay = document.getElementById('status-display');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const breakDurationInput = document.getElementById('break-duration');
        const cyclesCountInput = document.getElementById('cycles-count');
        const breakCyclesCountInput = document.getElementById('break-cycles-count');
        const levelSelector = document.getElementById('level-selector');
        const progressRing = document.getElementById('progress-ring');
        const mascotMessageEl = document.getElementById('mascot-message');
        const speechBubble = document.getElementById('speech-bubble');
        const focusOverlay = document.getElementById('focus-overlay');
        const focusMessage = document.getElementById('focus-message');
        const mascotMouth = document.getElementById('mascot-mouth');
        const taskForm = document.getElementById('task-form'),
            taskInput = document.getElementById('task-input'),
            resetTasksBtn = document.getElementById('reset-tasks-btn');
        const taskProgressContainer = document.getElementById('task-progress-container');
        const taskProgressBar = document.getElementById('task-progress-bar');
        const taskProgressText = document.getElementById('task-progress-text');
        const youtubeUrlInput = document.getElementById('youtube-url'),
            loadYoutubeBtn = document.getElementById('load-youtube'),
            localFileInput = document.getElementById('local-file'),
            audioPlayer = document.getElementById('audio-player'),
            musicPlayPauseBtn = document.getElementById('music-play-pause'),
            musicRewindBtn = document.getElementById('music-rewind'),
            musicForwardBtn = document.getElementById('music-forward'),
            volumeSlider = document.getElementById('volume-slider'),
            playerUi = document.getElementById('player-ui'),
            trackInfoEl = document.getElementById('track-info'),
            youtubePlayerContainer = document.getElementById('youtube-player-container');
        const tabs = document.querySelectorAll('.tab-btn'),
            panes = document.querySelectorAll('.tab-pane');
        const confirmModal = document.getElementById('confirm-modal'),
            cancelResetBtn = document.getElementById('cancel-reset'),
            confirmResetBtn = document.getElementById('confirm-reset');
        const muteBtn = document.getElementById('mute-btn');
        
        const radius = progressRing.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        progressRing.style.strokeDasharray = `${circumference} ${circumference}`;

        let isRunning = false, isDragging = false, timerId = null, workDuration = 25 * 60;
        let currentTime = workDuration, currentCycle = 1, maxCycles = 3, maxBreakCycles = 2, maxWorkMinutes = 60, currentMode = 'work';
        let messageInterval = null, toneStarted = false, isMuted = false;
        let tasks = [];
        let ytPlayer, currentAudioSource = null;

        const synth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const motivationalQuotes = [ "La clave del éxito es empezar.", "Un pequeño progreso suma.", "Enfócate en el progreso.", "La disciplina es el puente.", "¡Sigue adelante!", "Cada minuto cuenta.", "La concentración es la raíz.", "Cree en ti y todo será posible.", "El futuro depende de lo que hagas hoy.", "No te detengas hasta que te sientas orgulloso.", "Hazlo ahora. A veces 'después' se convierte en 'nunca'." ];
        const focusMessages = ["Stay Focus", "Stay Hard", "Focus Time", "Let's Go!", "You Got This"];
        const volumeOnIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
        const volumeOffIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2 2m2-2l2 2" /></svg>`;

        // --- Core App Logic ---
        function startTimer() { if (isRunning || currentTime <= 0) return; isRunning = true; startPauseBtn.textContent = 'Pausa'; document.querySelectorAll('#settings-content input, #level-selector input').forEach(el => el.disabled = true); updateMascotState('work'); setMascotMessage(); showFocusMessage(); startInterval(); }
        function startInterval() { clearInterval(timerId); if (!isRunning) return; timerId = setInterval(() => { currentTime--; updateDisplay(); if (currentTime < 0) { clearInterval(timerId); playSound(); switchMode(); } }, 1000); }
        function pauseTimer() { if (!isRunning) return; isRunning = false; clearInterval(timerId); startPauseBtn.textContent = 'Continuar'; updateMascotState('idle'); clearMascotMessage(); }
        function resetTimer() { clearInterval(timerId); isRunning = false; updateSettings(); currentCycle = 1; currentMode = 'work'; const defaultMinutes = 25; currentTime = defaultMinutes * 60; workDuration = currentTime; const angle = (currentTime / (maxWorkMinutes * 60)) * 360; knob.style.transform = `rotate(${angle}deg)`; updateDisplay(); startPauseBtn.textContent = 'Iniciar'; startPauseBtn.disabled = false; document.querySelectorAll('#settings-content input, #level-selector input').forEach(el => el.disabled = false); updateStatus(); updateMascotState('idle'); clearMascotMessage(); }
        function switchMode() { if (currentMode === 'work') { if (currentCycle >= maxCycles) { statusDisplay.textContent = `¡Sesión completada!`; startPauseBtn.disabled = true; mascotMessageEl.textContent = "Se acabó el ChuaTime"; speechBubble.style.opacity = '1'; return; } if (currentCycle <= maxBreakCycles) { currentMode = 'break'; currentTime = parseInt(breakDurationInput.value, 10) * 60; updateMascotState('break'); clearMascotMessage(); setTimeout(() => { mascotMessageEl.textContent = "¡Buen trabajo! Hora de un descanso."; speechBubble.style.opacity = '1'; }, 500); } else { currentCycle++; currentTime = workDuration; updateMascotState('work'); setMascotMessage(); showFocusMessage(); } } else { currentMode = 'work'; currentCycle++; currentTime = workDuration; updateMascotState('work'); setMascotMessage(); showFocusMessage(); } updateStatus(); updateDisplay(); startInterval(); }
        
        // --- UI Update & Interaction ---
        function updateDisplay() { let totalDurationForMode = (currentMode === 'work') ? workDuration : parseInt(breakDurationInput.value, 10) * 60; progressRing.style.strokeDashoffset = totalDurationForMode <= 0 ? circumference : circumference - (currentTime / totalDurationForMode) * circumference; const displayTime = Math.max(0, currentTime); const minutes = Math.floor(displayTime / 60); const seconds = displayTime % 60; timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; document.title = `${timeDisplay.textContent} - El reloj del Chua`; }
        function updateKnob(angle, isSnapping = false) { if (currentMode !== 'work' && !isSnapping) return; if (isRunning && !isSnapping) return; angle = Math.max(0, Math.min(359.9, angle)); if (isSnapping) { knob.style.transition = 'transform 0.2s ease-out'; knob.style.transform = `rotate(${angle}deg)`; setTimeout(() => { knob.style.transition = ''; }, 200); } else { knob.style.transform = `rotate(${angle}deg)`; } let totalSeconds = Math.round((angle / 360) * (maxWorkMinutes * 60)); if (!isRunning) { currentTime = totalSeconds; workDuration = totalSeconds; } const displayTime = Math.max(0, totalSeconds); const minutes = Math.floor(displayTime / 60); const seconds = displayTime % 60; timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; }
        function updateStatus() { updateSettings(); if (isRunning || currentCycle <= maxCycles) { statusDisplay.textContent = currentMode === 'work' ? `Trabajo - Ciclo ${currentCycle} de ${maxCycles}` : `Descanso`; } }
        function updateSettings() { maxCycles = parseInt(cyclesCountInput.value, 10) || 3; maxBreakCycles = parseInt(breakCyclesCountInput.value, 10) || 2; }
        function setMascotMessage() { clearInterval(messageInterval); const quote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]; mascotMessageEl.textContent = quote; speechBubble.style.opacity = '1'; if (currentMode === 'work' && isRunning) { messageInterval = setInterval(() => { const newQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]; mascotMessageEl.textContent = newQuote; }, 15000); } }
        function clearMascotMessage() { clearInterval(messageInterval); speechBubble.style.opacity = '0'; }
        function showFocusMessage() { const message = focusMessages[Math.floor(Math.random() * focusMessages.length)]; focusMessage.textContent = message; focusMessage.style.animation = 'none'; focusMessage.offsetHeight; focusMessage.style.animation = 'focus-fade 2.5s ease-in-out forwards'; focusOverlay.style.opacity = '1'; setTimeout(() => { focusOverlay.style.opacity = '0'; }, 2500); }
        function updateMascotState(state) { if (state === 'work') mascotMouth.setAttribute('d', 'M 40 68 Q 50 68 60 68'); else if (state === 'break') mascotMouth.setAttribute('d', 'M 40 68 Q 50 80 60 68'); else mascotMouth.setAttribute('d', 'M 40 68 Q 50 73 60 68'); }
        function playSound() { if (toneStarted && !isMuted) { synth.triggerAttackRelease("G5", "1.5s"); } }
        function handleInteraction(e) { e.preventDefault(); const rect = timerContainer.getBoundingClientRect(); const centerX = rect.left + rect.width / 2, centerY = rect.top + rect.height / 2; const touch = e.touches ? e.touches[0] : null; const clientX = touch ? touch.clientX : e.clientX; const clientY = touch ? touch.clientY : e.clientY; if (clientX === undefined || clientY === undefined) return; const deltaX = clientX - centerX, deltaY = clientY - centerY; let angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI) + 90; if (angle < 0) angle += 360; updateKnob(angle, false); }
        function snapOnRelease() { if (isDragging) { isDragging = false; let snappedSeconds = Math.round(currentTime / 30) * 30; currentTime = snappedSeconds; workDuration = snappedSeconds; let snappedAngle = (snappedSeconds / (maxWorkMinutes * 60)) * 360; if (isNaN(snappedAngle)) snappedAngle = 0; updateKnob(snappedAngle, true); updateDisplay(); } }

        // --- Kanban Logic ---
        function renderTasks() {
            document.querySelectorAll('.kanban-tasks').forEach(ul => ul.innerHTML = '');
            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = 'task-item';
                li.dataset.index = index;
                const taskContent = task.editing ? `<input type="text" value="${task.text}" class="edit-input flex-grow bg-slate-700 border border-slate-600 rounded p-1 text-sm w-full focus:ring-violet-500 focus:border-violet-500 text-slate-200">` : `<span class="flex-grow">${task.text}</span>`;
                li.innerHTML = `<div class="flex justify-between items-center">${taskContent}<div class="flex items-center gap-1 ml-2"><button class="edit-btn text-slate-500 hover:text-yellow-400 text-xs">✏️</button><button class="delete-btn text-slate-500 hover:text-red-500 text-xs">✖</button></div></div>`;
                document.querySelector(`.kanban-column[data-status="${task.status}"] .kanban-tasks`).appendChild(li);
                if(task.editing) { const editInput = li.querySelector('.edit-input'); editInput.focus(); editInput.addEventListener('blur', () => saveTask(index, editInput.value)); editInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') saveTask(index, editInput.value); else if (e.key === 'Escape') cancelEdit(index); }); }
            });
            updateTaskProgress();
            addTaskEventListeners();
        }
        function updateTaskProgress() { const totalTasks = tasks.length; const completedTasks = tasks.filter(task => task.status === 'done').length; const percentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0; if(totalTasks > 0) { taskProgressContainer.style.display = 'block'; taskProgressBar.style.width = `${percentage}%`; taskProgressText.textContent = `${Math.round(percentage)}%`; } else { taskProgressContainer.style.display = 'none'; } }
        function saveTask(index, newText) { if (newText.trim() !== '') { tasks[index].text = newText.trim(); } tasks[index].editing = false; renderTasks(); }
        function cancelEdit(index) { tasks[index].editing = false; renderTasks(); }
        
        // --- Music Logic ---
        function onPlayerReady(event) { event.target.playVideo(); trackInfoEl.textContent = event.target.getVideoData().title; volumeSlider.value = event.target.getVolume(); }
        function onPlayerStateChange(event) { if(event.data === YT.PlayerState.PLAYING) musicPlayPauseBtn.innerHTML = '❚❚'; else musicPlayPauseBtn.innerHTML = '▶'; }
        function loadYoutubeAPI(initialVideoId) { if (window.YT && window.YT.Player) { if(ytPlayer) { ytPlayer.loadVideoById(initialVideoId); } else { ytPlayer = new YT.Player('youtube-player', { height: '100%', width: '100%', videoId: initialVideoId, playerVars: { 'autoplay': 1, 'controls': 0, 'showinfo': 0, 'rel': 0, 'modestbranding': 1 }, events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange } }); } return; } const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api"; const firstScriptTag = document.getElementsByTagName('script')[0]; firstScriptTag.parentNode.insertBefore(tag, firstScriptTag); window.onYouTubeIframeAPIReady = () => { ytPlayer = new YT.Player('youtube-player', { height: '100%', width: '100%', videoId: initialVideoId, playerVars: { 'autoplay': 1, 'controls': 0, 'showinfo': 0, 'rel': 0, 'modestbranding': 1 }, events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange } }); } }

        // --- Event Listeners ---
        function addTaskEventListeners() {
            document.querySelectorAll('.task-item').forEach(item => {
                item.addEventListener('click', e => {
                    if (e.target.closest('.edit-btn') || e.target.closest('.delete-btn')) return;
                    const index = parseInt(item.dataset.index);
                    const task = tasks[index];
                    if (task.status === 'todo') task.status = 'inprogress';
                    else if (task.status === 'inprogress') task.status = 'done';
                    else if (task.status === 'done') task.status = 'todo';
                    renderTasks();
                });
                item.querySelector('.edit-btn').addEventListener('click', () => { tasks.forEach((task, i) => task.editing = (i == item.dataset.index)); renderTasks(); });
                item.querySelector('.delete-btn').addEventListener('click', () => { tasks.splice(item.dataset.index, 1); renderTasks(); });
            });
        }
        taskForm.addEventListener('submit', e => { e.preventDefault(); const taskText = taskInput.value.trim(); if (taskText !== '') { tasks.push({ text: taskText, status: 'todo', editing: false }); taskInput.value = ''; renderTasks(); } });
        resetTasksBtn.addEventListener('click', () => { confirmModal.classList.remove('hidden'); });
        cancelResetBtn.addEventListener('click', () => { confirmModal.classList.add('hidden'); });
        confirmResetBtn.addEventListener('click', () => { tasks = []; renderTasks(); confirmModal.classList.add('hidden'); });
        
        timerContainer.addEventListener('mousedown', (e) => { if(!isRunning) { isDragging = true; handleInteraction(e); } });
        document.addEventListener('mousemove', (e) => { if (isDragging) handleInteraction(e); });
        document.addEventListener('mouseup', snapOnRelease);
        timerContainer.addEventListener('touchstart', (e) => { if(!isRunning) { isDragging = true; handleInteraction(e); } }, { passive: false });
        document.addEventListener('touchmove', (e) => { if (isDragging) handleInteraction(e); }, { passive: false });
        document.addEventListener('touchend', snapOnRelease);
        startPauseBtn.addEventListener('click', () => { if (!toneStarted) { Tone.start().then(() => { toneStarted = true; }); } isRunning ? pauseTimer() : startTimer(); });
        resetBtn.addEventListener('click', resetTimer);
        muteBtn.addEventListener('click', () => { isMuted = !isMuted; muteBtn.innerHTML = isMuted ? volumeOffIcon : volumeOnIcon; });
        cyclesCountInput.addEventListener('change', updateStatus);
        breakCyclesCountInput.addEventListener('change', updateStatus);
        breakDurationInput.addEventListener('change', updateStatus);
        levelSelector.addEventListener('change', (e) => { if (e.target.name === 'level') { const level = e.target.id.split('-')[1]; document.body.className = `theme-${level}`; if(!isRunning) { maxWorkMinutes = parseInt(e.target.value, 10); resetTimer(); } } });
        
        musicPlayPauseBtn.addEventListener('click', () => { if (!currentAudioSource) return; if (currentAudioSource === 'local') { if (audioPlayer.paused) { audioPlayer.play(); musicPlayPauseBtn.innerHTML = '❚❚'; } else { audioPlayer.pause(); musicPlayPauseBtn.innerHTML = '▶'; } } else if (currentAudioSource === 'youtube' && ytPlayer) { const state = ytPlayer.getPlayerState(); state === 1 ? ytPlayer.pauseVideo() : ytPlayer.playVideo(); } });
        musicRewindBtn.addEventListener('click', () => { if (!currentAudioSource) return; if (currentAudioSource === 'local') audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10); else if (ytPlayer) ytPlayer.seekTo(Math.max(0, ytPlayer.getCurrentTime() - 10), true); });
        musicForwardBtn.addEventListener('click', () => { if (!currentAudioSource) return; if (currentAudioSource === 'local') audioPlayer.currentTime += 10; else if (ytPlayer) ytPlayer.seekTo(ytPlayer.getCurrentTime() + 10, true); });
        volumeSlider.addEventListener('input', e => { const volume = e.target.value; if (currentAudioSource === 'local') audioPlayer.volume = volume / 100; else if (ytPlayer) ytPlayer.setVolume(volume); });
        localFileInput.addEventListener('change', e => { const file = e.target.files[0]; if (file) { if (ytPlayer) { ytPlayer.stopVideo(); ytPlayer.destroy(); ytPlayer = null; } const objectURL = URL.createObjectURL(file); audioPlayer.src = objectURL; trackInfoEl.textContent = file.name; if(playerUi.querySelector('#youtube-player-container')) { playerUi.querySelector('#youtube-player-container').classList.add('hidden'); } playerUi.classList.remove('hidden'); currentAudioSource = 'local'; audioPlayer.play(); musicPlayPauseBtn.innerHTML = '❚❚'; } });
        loadYoutubeBtn.addEventListener('click', () => { const url = youtubeUrlInput.value; const videoId = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/); if (videoId && videoId[1]) { if(playerUi.querySelector('#youtube-player-container')) {playerUi.querySelector('#youtube-player-container').classList.remove('hidden');} audioPlayer.pause(); musicPlayPauseBtn.innerHTML = '▶'; playerUi.classList.remove('hidden'); currentAudioSource = 'youtube'; if (ytPlayer) ytPlayer.loadVideoById(videoId[1]); else loadYoutubeAPI(videoId[1]); } else { alert("URL de YouTube no válida."); } });
        
        tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(t => t.classList.remove('active')); tab.classList.add('active'); panes.forEach(pane => pane.classList.add('hidden')); document.getElementById(`${tab.dataset.tab}-content`).classList.remove('hidden'); }); });
        
        // --- INITIALIZATION ---
        muteBtn.innerHTML = volumeOnIcon;
        resetTimer(); 
        renderTasks();
    });
    </script>
</body>
</html>

