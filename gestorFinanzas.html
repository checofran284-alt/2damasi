<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINTRACK</title>
    <!-- Importamos una fuente moderna (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES CSS (Tema Oscuro por defecto) --- */
        :root {
            /* Colores Base (Modificables por JS) */
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --surface-hover: #2C2C2C;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B0B0;
            --input-bg: #2C2C2C;
            
            /* Color Primario (Modificable) */
            --primary-color: #00E676; 
            
            /* Colores Fijos */
            --danger-color: #CF6679;
            --edit-color: #64B5F6; 
            --crypto-color: #9C27B0; 
            --highlight-color: #FFD700; 
            --stock-color: #2979FF; 
            
            /* Layout */
            --nav-height: 70px;
            --max-width-desktop: 100%; 
        }

        /* --- RESET & BASE --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* RESPONSIVE: Asegurar altura completa */
        html, body {
            height: 100%;
            width: 100%;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            transition: background-color 0.3s, color 0.3s; /* Transici√≥n suave de tema */
        }

        body {
            display: flex;
            flex-direction: column;
            /* Scrollbar personalizada */
            scrollbar-width: thin;
            scrollbar-color: var(--surface-hover) var(--bg-color);
        }

        /* --- CONTENEDOR PRINCIPAL FLUIDO --- */
        #app-container {
            width: 100%; /* Ocupa todo el ancho */
            max-width: var(--max-width-desktop); /* 100% */
            margin: 0 auto; 
            background-color: var(--bg-color);
            min-height: 100vh; /* Altura m√≠nima completa */
            position: relative;
            display: flex;
            flex-direction: column;
            padding-bottom: calc(var(--nav-height) + 40px); /* Espacio para el nav */
            overflow-x: hidden;
            box-shadow: none; 
            border: none;
            transition: background-color 0.3s;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px; 
            background-color: var(--bg-color);
            position: sticky;
            top: 0;
            z-index: 20;
            border-bottom: 1px solid var(--surface-hover);
            width: 100%;
            max-width: var(--max-width-desktop);
            transition: background-color 0.3s;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
        }

        .logo span {
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .user-icon {
            width: 40px;
            height: 40px;
            background-color: var(--surface-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: background-color 0.2s;
            font-size: 1.2rem; /* Para el emoji de engranaje */
        }
        
        .user-icon:hover {
            background-color: var(--surface-hover);
            border-color: var(--primary-color);
        }

        .user-icon svg {
            width: 20px;
            height: 20px;
            fill: var(--text-secondary);
        }

        /* --- MAIN SECTIONS --- */
        main {
            padding: 20px 40px; /* M√°s espacio lateral para respirar */
            width: 100%;
            flex: 1; /* Empuja el footer hacia abajo si hay poco contenido */
        }

        section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
            width: 100%;
        }

        section.active {
            display: block;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        /* --- TARJETAS RESUMEN (DASHBOARD) --- */
        .summary-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .summary-container {
                flex-direction: row;
            }
            .summary-card {
                flex: 1; 
            }
        }

        .summary-card {
            background: linear-gradient(145deg, var(--surface-color), transparent);
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--surface-hover);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 0; 
        }

        .summary-card span:first-child {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* --- FORMULARIOS --- */
        .form-container {
            background-color: var(--surface-color);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--surface-hover);
            width: 100%; 
        }

        @media (min-width: 1024px) {
            .form-container {
                max-width: 600px;
                margin-left: auto;
                margin-right: auto;
            }
        }

        .info-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        input, select, textarea {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
        }

        .primary-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: #000; /* Texto siempre oscuro en el bot√≥n primario para contraste */
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        .primary-btn:hover { opacity: 0.9; }
        .primary-btn:active { transform: scale(0.98); }
        
        .secondary-btn {
            width: 100%;
            padding: 12px;
            background-color: transparent;
            color: var(--text-secondary);
            border: 1px solid #444;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .secondary-btn:hover { background-color: var(--surface-hover); }

        .list-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--surface-hover);
            padding-bottom: 10px;
            margin-top: 40px;
            color: var(--text-primary);
        }

        /* --- GRID SYSTEM PARA LISTAS --- */
        #lista-gastos, #lista-objetivos, #lista-suscripciones, #lista-inversiones {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }

        @media (min-width: 768px) {
            #lista-gastos, #lista-objetivos, #lista-suscripciones, #lista-inversiones {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); 
                gap: 20px;
            }
        }

        .gasto-item, .objetivo-card, .sub-card {
            background-color: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--surface-hover);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.2s, box-shadow 0.2s;
            height: 100%; 
        }

        @media (min-width: 1024px) {
            .gasto-item:hover, .objetivo-card:hover, .sub-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                border-color: var(--text-secondary);
            }
        }

        .gasto-item {
            flex-direction: row;
            align-items: center;
            border-left: 4px solid var(--primary-color);
        }

        .gasto-info h4 { font-size: 1.1rem; margin-bottom: 4px; color: var(--text-primary); }
        .gasto-info p { font-size: 0.9rem; color: var(--text-secondary); }
        .gasto-amount { font-weight: 700; color: var(--text-primary); font-size: 1.1rem; }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
            font-style: italic;
            grid-column: 1 / -1; 
            background: var(--surface-color);
            border-radius: 12px;
            border: 1px dashed #444;
        }

        /* --- OBJETIVOS --- */
        .objetivo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .objetivo-title { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }
        .objetivo-fechas { font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px; }

        .status-badge {
            font-size: 0.75rem;
            padding: 5px 10px;
            border-radius: 20px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .status-badge.en_curso { background-color: var(--surface-hover); color: var(--text-secondary); border: 1px solid #444; }
        .status-badge.completado { background-color: var(--primary-color); color: #000; box-shadow: 0 0 10px rgba(0,0,0,0.1); }

        .progress-bar-bg {
            background-color: var(--input-bg);
            border-radius: 6px;
            height: 10px;
            width: 100%;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-bar-fill { background-color: var(--primary-color); height: 100%; transition: width 0.5s ease-out; }
        .progress-bar-fill.completado { background-color: var(--primary-color); }

        .objetivo-stats { display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-secondary); }

        .card-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--surface-hover);
            gap: 10px;
        }
        .btn-action {
            flex: 1; padding: 10px; border-radius: 8px; border: none; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s;
        }
        .btn-action:hover { opacity: 0.8; }
        .btn-add { background-color: var(--primary-color); color: #000; flex: 1.5; }
        .btn-edit { background-color: var(--surface-hover); color: var(--edit-color); border: 1px solid #444; }
        .btn-delete { background-color: var(--surface-hover); color: var(--danger-color); border: 1px solid #444; }
        .btn-api { background-color: var(--surface-hover); color: var(--crypto-color); border: 1px solid var(--crypto-color); }
        .btn-bolsa { 
            background-color: rgba(41, 121, 255, 0.15); 
            color: var(--stock-color); 
            border: 1px solid var(--stock-color); 
            padding: 8px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-bolsa:hover { background-color: rgba(41, 121, 255, 0.3); }

        /* --- SUSCRIPCIONES / INVERSIONES CARDS --- */
        .sub-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .sub-name { font-weight: 700; font-size: 1.15rem; display: flex; align-items: center; gap: 8px; color: var(--text-primary); }
        .sub-price { font-weight: 700; color: var(--primary-color); font-size: 1.1rem; }
        .sub-detail { font-size: 0.9rem; color: var(--text-secondary); }
        .sub-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; background-color: var(--input-bg); color: var(--text-secondary); }
        .notes-badge { font-size: 1rem; cursor:help; }

        .text-green { color: var(--primary-color) !important; }
        .text-red { color: var(--danger-color) !important; }
        .text-neutral { color: var(--text-secondary) !important; }

        /* --- VISTA BOLSA / TABLAS RESPONSIVE --- */
        .view-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--surface-hover);
            padding-bottom: 15px;
            flex-wrap: wrap;
        }

        .view-tab-btn {
            background: none; border: none; color: var(--text-secondary); font-size: 1.1rem; font-weight: 600; cursor: pointer;
            padding: 10px 20px; border-radius: 8px; transition: all 0.2s;
        }
        .view-tab-btn.active { background-color: var(--surface-hover); color: var(--primary-color); }

        .table-container {
            width: 100%;
            overflow-x: auto; 
            border-radius: 12px;
            border: 1px solid #333;
            background-color: var(--surface-color);
            margin-bottom: 30px;
        }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 600px; 
        }

        .stock-table th { text-align: left; padding: 15px; background-color: var(--surface-hover); color: var(--text-secondary); font-weight: 600; border-bottom: 1px solid #444; position: sticky; top: 0; }
        .stock-table td { padding: 15px; border-bottom: 1px solid #333; color: var(--text-primary); }
        .stock-row:hover { background-color: var(--input-bg); cursor: pointer; }
        .stock-row.selected { background-color: rgba(41, 121, 255, 0.1); border-left: 3px solid var(--stock-color); }
        .stock-ticker { font-weight: 700; color: var(--stock-color); }

        #stock-details-panel {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            display: none;
            margin-top: 25px;
            animation: fadeIn 0.3s ease;
        }
        .stock-detail-title {
            font-size: 1.2rem;
            color: var(--stock-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-container {
            background-color: var(--input-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            width: 100%;
            height: 350px; 
            position: relative;
        }
        canvas#stockChart {
            width: 100%;
            height: 100%;
        }
        .history-table-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 8px;
        }

        /* --- MODALES RESPONSIVE --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 0;
        }

        .modal-content {
            background: var(--surface-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
            animation: modalPop 0.3s ease-out;
            box-shadow: 0 15px 40px rgba(0,0,0,0.9);
            width: 100%;
            height: 100%;
            max-height: 100vh;
            border-radius: 0;
            padding: 20px;
            overflow-y: auto;
        }

        @media (min-width: 768px) {
            .modal-content {
                width: 600px; 
                height: auto;
                max-height: 90vh; 
                border-radius: 16px;
                border: 1px solid #444;
            }
            .modal-overlay {
                padding: 20px;
            }
        }

        @keyframes modalPop {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header h3 { font-size: 1.5rem; color: var(--primary-color); margin-bottom: 10px; }
        .modal-details { font-size: 1rem; border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 15px; }

        .flashcard-area {
            background: var(--input-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px dashed #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 220px;
        }
        .flashcard-display {
            background: var(--surface-color);
            width: 100%;
            flex-grow: 1;
            border-radius: 8px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        .flashcard-display.is-highlighted {
            border-color: var(--highlight-color);
            background: linear-gradient(145deg, var(--surface-color), #332f1a);
        }
        .flashcard-meta { font-size: 0.75rem; color: #888; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .flashcard-text { font-size: 1.1rem; line-height: 1.6; color: var(--text-primary); text-align: center; margin: 10px 0; }
        .btn-star-large { background: none; border: none; font-size: 1.5rem; color: #444; cursor: pointer; align-self: flex-end; transition: transform 0.2s; }
        .btn-star-large:hover { transform: scale(1.1); }
        .btn-star-large.active { color: var(--highlight-color); }
        .flashcard-nav { width: 100%; display: flex; justify-content: space-between; margin-top: 15px; }
        .flashcard-controls-top { display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px; align-items: center; }
        .toggle-filter-btn { background: transparent; border: 1px solid #555; color: #888; font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .toggle-filter-btn.active { border-color: var(--highlight-color); color: var(--highlight-color); background: rgba(255, 215, 0, 0.1); }
        .flashcard-indicator { font-size: 0.8rem; color: #666; }
        .nav-arrow { background: var(--surface-hover); color: var(--text-primary); border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        .nav-arrow:disabled { opacity: 0.3; cursor: not-allowed; }
        .new-note-container textarea { background: var(--input-bg); font-size: 1rem; border: 1px solid #444; color: var(--text-primary); padding: 10px; }

        /* --- TOASTS --- */
        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 4000;
            display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none;
        }
        .toast {
            background-color: var(--surface-color); color: var(--text-primary); padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: space-between;
            animation: slideInDown 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            border-left: 5px solid transparent; pointer-events: auto; cursor: pointer; font-size: 0.95rem; border: 1px solid var(--surface-hover);
        }
        .toast.success { border-left-color: var(--primary-color); }
        .toast.error { border-left-color: var(--danger-color); }
        .toast.info { border-left-color: var(--edit-color); }
        @keyframes slideInDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        /* --- NAVIGATION --- */
        nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: var(--max-width-desktop);
            height: var(--nav-height);
            background-color: var(--surface-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--surface-hover);
            z-index: 100;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        @media (min-width: 768px) {
            nav {
                justify-content: center;
                gap: 50px; 
            }
        }

        .nav-btn {
            background: none; border: none; display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 6px; color: var(--text-secondary); cursor: pointer; width: auto; height: 100%; transition: color 0.2s ease;
            padding: 0 10px;
        }
        .nav-btn svg { width: 26px; height: 26px; fill: currentColor; transition: transform 0.2s; }
        .nav-btn span { font-size: 0.8rem; font-weight: 500; }
        .nav-btn.active { color: var(--primary-color); }
        .nav-btn.active svg { transform: translateY(-3px); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 360px) {
            h2 { font-size: 1.5rem; }
            .summary-card .amount { font-size: 1.2rem; }
            .nav-btn span { font-size: 0.7rem; }
        }

        /* --- NUEVO: ESTILOS PARA MODAL DE AJUSTES --- */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .settings-section-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            grid-column: 1 / -1;
            border-bottom: 1px solid var(--surface-hover);
            padding-bottom: 5px;
        }

        .setting-btn {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid transparent;
            background-color: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-align: center;
        }

        .setting-btn:hover {
            background-color: var(--surface-hover);
        }

        .setting-btn.active {
            border-color: var(--primary-color);
            background-color: rgba(0, 230, 118, 0.1); /* Tinte verde suave */
            color: var(--primary-color);
        }

        /* Colores espec√≠ficos para botones de color */
        .color-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .color-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

    </style>
</head>
<body>

    <div id="app-container">
        <!-- HEADER -->
        <header>
            <div class="logo">FIN<span>TRACK</span></div>
            <!-- Bot√≥n de Ajustes (Engranaje) -->
            <div class="header-actions">
                <div class="user-icon" onclick="openSettingsModal()" title="Personalizaci√≥n">
                    ‚öôÔ∏è
                </div>
                <!-- Bot√≥n de Backup / Configuraci√≥n general -->
                <div class="user-icon" onclick="showSection('section-config')" title="Backup y Datos">
                    üìÇ
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main>
            <!-- Secci√≥n GASTOS -->
            <section id="section-gastos">
                <h2 data-i18n="title_expenses">Resumen de Gastos</h2>
                <div class="summary-container">
                    <div class="summary-card">
                        <span data-i18n="label_total_today">Total Hoy</span>
                        <span class="amount" id="total-hoy">0.00 ‚Ç¨</span>
                    </div>
                    <div class="summary-card">
                        <span data-i18n="label_total_month">Total Mes</span>
                        <span class="amount" id="total-mes">0.00 ‚Ç¨</span>
                    </div>
                </div>

                <div class="form-container">
                    <div class="form-group">
                        <label data-i18n="label_amount">Importe (‚Ç¨)</label>
                        <input type="number" id="input-importe" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_category">Categor√≠a</label>
                        <select id="select-categoria">
                            <option value="Comida">Comida</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Ocio">Ocio</option>
                            <option value="Suscripciones">Suscripciones</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_date">Fecha</label>
                        <input type="date" id="input-fecha">
                    </div>
                    <div class="form-group">
                        <label data-i18n="label_note">Nota (Opcional)</label>
                        <textarea id="input-nota" rows="2" placeholder="Detalles del gasto..."></textarea>
                    </div>
                    <button id="btn-guardar-gasto" class="primary-btn" data-i18n="btn_save_expense">Guardar Gasto</button>
                </div>

                <div class="list-header" data-i18n="header_recent_moves">Movimientos Recientes</div>
                <div id="lista-gastos"></div>
            </section>

            <!-- Secci√≥n AHORRO -->
            <section id="section-ahorro">
                <h2 data-i18n="title_savings">Objetivos de Ahorro</h2>
                <div class="summary-container">
                    <div class="summary-card">
                        <span data-i18n="label_saved">Ahorrado</span>
                        <span class="amount" id="ahorro-total-acumulado">0.00 ‚Ç¨</span>
                    </div>
                    <div class="summary-card">
                        <span data-i18n="label_goal_total">Meta Total</span>
                        <span class="amount" id="ahorro-total-objetivos">0.00 ‚Ç¨</span>
                    </div>
                </div>
                <!-- ... (Formularios de ahorro omitidos por brevedad, asumiendo estructura similar) ... -->
                <div class="form-container">
                    <input type="hidden" id="input-objetivo-id">
                    <div class="form-group">
                        <label>Nombre del Objetivo</label>
                        <input type="text" id="input-objetivo-nombre" placeholder="Ej. Viaje a Jap√≥n">
                    </div>
                    <div class="form-group">
                        <label>Meta Total (‚Ç¨)</label>
                        <input type="number" id="input-objetivo-total" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Ya Ahorrado (‚Ç¨)</label>
                        <input type="number" id="input-objetivo-ahorrado" placeholder="0.00" value="0" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Fecha Inicio</label>
                        <input type="date" id="input-objetivo-inicio">
                    </div>
                    <div class="form-group">
                        <label>Fecha L√≠mite</label>
                        <input type="date" id="input-objetivo-limite">
                    </div>
                    <button id="btn-guardar-objetivo" class="primary-btn">Guardar Objetivo</button>
                    <button id="btn-cancelar-edicion" class="secondary-btn" style="display: none;">Cancelar Edici√≥n</button>
                </div>
                <div class="list-header" data-i18n="header_my_goals">Mis Metas</div>
                <div id="lista-objetivos"></div>
            </section>

            <!-- Secci√≥n SUSCRIPCIONES -->
            <section id="section-suscripciones">
                <h2 data-i18n="title_subscriptions">Suscripciones</h2>
                
                <div class="summary-container">
                    <div class="summary-card" style="width: 100%; flex: 1 1 100%;">
                        <span data-i18n="label_monthly_cost">Gasto Total Mensual</span>
                        <span class="amount" id="total-mensual-suscripciones">0.00 ‚Ç¨</span>
                    </div>
                </div>
                <!-- ... (Formulario suscripciones) ... -->
                 <div class="form-container">
                    <input type="hidden" id="input-sub-id">
                    <div class="form-group">
                        <label>Nombre del Servicio</label>
                        <input type="text" id="input-sub-nombre" placeholder="Ej. Netflix">
                    </div>
                    <div class="form-group">
                        <label>Precio (‚Ç¨)</label>
                        <input type="number" id="input-sub-precio" placeholder="0.00" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Periodicidad</label>
                        <select id="select-sub-periodo">
                            <option value="mensual">Mensual</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Categor√≠a</label>
                        <select id="select-sub-categoria">
                            <option value="Streaming">Streaming</option>
                            <option value="M√∫sica">M√∫sica</option>
                            <option value="Software">Software</option>
                            <option value="Juegos">Juegos</option>
                            <option value="Gimnasio">Gimnasio</option>
                            <option value="Otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pr√≥ximo Cobro</label>
                        <input type="date" id="input-sub-fecha">
                    </div>
                    <button id="btn-guardar-sub" class="primary-btn">Guardar Suscripci√≥n</button>
                    <button id="btn-cancelar-sub" class="secondary-btn" style="display: none;">Cancelar Edici√≥n</button>
                </div>
                <div class="list-header" data-i18n="header_my_services">Mis Servicios</div>
                <div id="lista-suscripciones"></div>
            </section>

            <!-- Secci√≥n INVERSIONES -->
            <section id="section-inversiones">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 style="margin:0;" data-i18n="title_investments">Inversiones</h2>
                    <button class="primary-btn" style="width: auto; padding: 8px 16px; font-size: 0.9rem;" onclick="toggleInvForm(true)" data-i18n="btn_new_investment">+ Nueva Inversi√≥n</button>
                </div>
                
                <div class="summary-container" id="inversiones-resumen">
                    <div class="summary-card">
                        <span data-i18n="label_total_value">Valor Total</span>
                        <span class="amount" id="inv-total-valor">0.00 ‚Ç¨</span>
                    </div>
                    <div class="summary-card">
                        <span data-i18n="label_total_profit">Total Ganancia</span>
                        <span class="amount" id="inv-total-ganancia">0.00 ‚Ç¨</span>
                    </div>
                </div>

                 <div id="inv-form-container" style="display: none;">
                    <div class="form-container">
                        <input type="hidden" id="input-inv-id">
                        <div class="form-group">
                            <label>Nombre del Activo</label>
                            <input type="text" id="input-inv-nombre" placeholder="Ej. Bitcoin, Apple">
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="select-inv-tipo">
                                <option value="Acci√≥n/ETF">Acci√≥n/ETF</option>
                                <option value="Cripto">Cripto</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ticker / ID CoinGecko</label>
                            <input type="text" id="input-inv-ticker" placeholder="Ej. bitcoin, ethereum">
                        </div>
                        <div class="form-group">
                            <label>Cantidad Pose√≠da</label>
                            <input type="number" id="input-inv-cantidad" placeholder="0.00" min="0" step="any">
                        </div>
                        <div class="form-group">
                            <label>Precio Compra (Unidad)</label>
                            <input type="number" id="input-inv-precio-compra" placeholder="0.00" min="0" step="any">
                        </div>
                        <div class="form-group">
                            <label>Precio Actual (Unidad)</label>
                            <input type="number" id="input-inv-precio-actual" placeholder="0.00" min="0" step="any">
                        </div>
                        <button id="btn-guardar-inv" class="primary-btn">Guardar Inversi√≥n</button>
                        <button id="btn-cancelar-inv" class="secondary-btn">Cerrar</button>
                    </div>
                </div>

                <div class="view-tabs">
                    <button class="view-tab-btn active" id="tab-bolsa" onclick="showInversionesView('bolsa')">Bolsa</button>
                    <button class="view-tab-btn" id="tab-cripto" onclick="showInversionesView('cripto')">Cripto</button>
                    <button class="view-tab-btn" id="tab-otros" onclick="showInversionesView('otros')">Otros</button>
                </div>

                <!-- SUB-VISTAS (Estructura igual a la anterior) -->
                <div id="inv-bolsa-view">
                    <!-- Resumen Bolsa -->
                     <div class="summary-container">
                        <div class="summary-card">
                            <span>Inv. Bolsa</span>
                            <span class="amount" id="bolsa-total-invertido">0.00 ‚Ç¨</span>
                        </div>
                        <div class="summary-card">
                            <span>Valor Bolsa</span>
                            <span class="amount" id="bolsa-total-valor">0.00 ‚Ç¨</span>
                        </div>
                    </div>
                    <div class="list-header">Mi Cartera de Acciones</div>
                    <div class="table-container">
                        <table class="stock-table">
                            <thead><tr><th>Ticker</th><th>Nombre</th><th>Cant.</th><th>P.Compra</th><th>P.Actual</th><th>Ganancia</th><th>%</th></tr></thead>
                            <tbody id="tabla-bolsa-body"></tbody>
                        </table>
                    </div>
                    <div id="stock-details-panel" style="display: none;">
                         <div class="stock-detail-title">
                            <span id="detail-ticker">TICKER</span>
                            <small style="color: #888;">Datos Hist√≥ricos</small>
                            <button class="btn-api" style="margin-left: auto;" onclick="refreshStockData()">‚Üª</button>
                        </div>
                        <div class="chart-container"><canvas id="stockChart"></canvas></div>
                        <div class="list-header" style="font-size: 1rem;">√öltimos 30 d√≠as</div>
                        <div class="history-table-container">
                            <table class="stock-table"><thead><tr><th>Fecha</th><th>Cierre</th><th>Var %</th></tr></thead><tbody id="tabla-historico-body"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="inv-cripto-view" style="display:none;">
                     <div class="list-header">Criptomonedas</div>
                     <div class="summary-container">
                        <div class="summary-card"><span>Inv. Cripto</span><span class="amount" id="cripto-total-invertido">0.00 ‚Ç¨</span></div>
                        <div class="summary-card"><span>Valor Cripto</span><span class="amount" id="cripto-total-valor">0.00 ‚Ç¨</span></div>
                    </div>
                    <div class="table-container">
                        <table class="stock-table"><thead><tr><th>ID</th><th>Nombre</th><th>Cant.</th><th>P.Compra</th><th>P.Actual</th><th>Ganancia</th><th>%</th><th>Acci√≥n</th></tr></thead><tbody id="tabla-cripto-body"></tbody></table>
                    </div>
                </div>

                <div id="inv-otros-view" style="display:none;">
                    <div class="list-header">Otros Activos</div>
                    <div class="summary-container">
                        <div class="summary-card"><span>Inv. Otros</span><span class="amount" id="otros-total-invertido">0.00 ‚Ç¨</span></div>
                        <div class="summary-card"><span>Valor Otros</span><span class="amount" id="otros-total-valor">0.00 ‚Ç¨</span></div>
                    </div>
                    <div class="table-container">
                        <table class="stock-table"><thead><tr><th>Nombre</th><th>Tipo</th><th>Cant.</th><th>P.Compra</th><th>P.Actual</th><th>Ganancia</th><th>%</th></tr></thead><tbody id="tabla-otros-body"></tbody></table>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n AJUSTES (DATA & BACKUP) -->
            <section id="section-config">
                <h2 data-i18n="title_settings_data">Ajustes de Datos</h2>
                <p class="info-text">Gestiona tus datos y copias de seguridad.</p>
                <div class="form-container">
                    <h3>Copia de Seguridad</h3>
                    <p style="color:var(--text-secondary); margin-bottom: 20px; font-size: 0.9rem;">
                        Exporta tus datos a un archivo JSON para guardarlos o transferirlos a otro dispositivo.
                    </p>
                    <button id="btn-export-json" class="primary-btn" style="margin-bottom: 15px;" onclick="exportFintrackToJson()" data-i18n="btn_export_json">üì• Exportar datos (JSON)</button>
                    <button id="btn-import-json" class="secondary-btn" style="border-color: var(--primary-color); color: var(--primary-color);" data-i18n="btn_import_json">üì§ Importar datos (JSON)</button>
                    <input type="file" id="backup-file-input" accept="application/json" style="display: none;">
                </div>
            </section>

        </main>

        <!-- TOAST CONTAINER -->
        <div id="toast-container"></div>

        <!-- MODAL SUSCRIPCION -->
        <div id="sub-modal" class="modal-overlay">
             <div class="modal-content">
                <div class="modal-header"><h3 id="modal-sub-name">Nombre</h3></div>
                <div class="modal-details" id="modal-sub-details"></div>
                <div class="notes-section">
                    <h4>Notas</h4>
                    <div class="new-note-container"><textarea id="input-new-note"></textarea><button onclick="addNoteToSub()" class="primary-btn">A√±adir</button></div>
                    <div class="flashcard-area">
                        <div class="flashcard-controls-top"><button id="btn-filter-star" class="toggle-filter-btn" onclick="toggleFilterHighlighted()">‚òÖ Destacadas</button><span id="flashcard-indicator">0/0</span></div>
                        <div id="flashcard-display" class="flashcard-display"><p>Sin notas</p></div>
                        <div class="flashcard-nav"><button id="btn-prev-note" class="nav-arrow" onclick="prevNote()">Anterior</button><button id="btn-next-note" class="nav-arrow" onclick="nextNote()">Siguiente</button></div>
                    </div>
                </div>
                <div class="modal-actions"><button onclick="closeSubModal()" class="secondary-btn">Cerrar</button></div>
            </div>
        </div>

        <!-- NUEVO: MODAL DE AJUSTES UI (PERSONALIZACI√ìN) -->
        <div id="settings-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 data-i18n="modal_settings_title">Personalizaci√≥n</h3>
                </div>
                
                <div style="overflow-y:auto; padding-right:5px;">
                    
                    <!-- Tema -->
                    <div class="settings-section-title" data-i18n="st_theme">Tema</div>
                    <div class="settings-grid">
                        <div class="setting-btn" onclick="updateTheme('dark')" id="theme-btn-dark">üåë Oscuro</div>
                        <div class="setting-btn" onclick="updateTheme('light')" id="theme-btn-light">‚òÄÔ∏è Claro</div>
                        <div class="setting-btn" onclick="updateTheme('sepia')" id="theme-btn-sepia">üìú Sepia</div>
                    </div>

                    <!-- Colores -->
                    <div class="settings-section-title" data-i18n="st_color">Color Principal</div>
                    <div class="settings-grid">
                        <div class="setting-btn color-option" onclick="updateColor('green')" id="color-btn-green">
                            <span class="color-circle" style="background:#00E676;"></span> Verde
                        </div>
                        <div class="setting-btn color-option" onclick="updateColor('blue')" id="color-btn-blue">
                            <span class="color-circle" style="background:#2979FF;"></span> Azul
                        </div>
                        <div class="setting-btn color-option" onclick="updateColor('purple')" id="color-btn-purple">
                            <span class="color-circle" style="background:#D500F9;"></span> Morado
                        </div>
                        <div class="setting-btn color-option" onclick="updateColor('orange')" id="color-btn-orange">
                            <span class="color-circle" style="background:#FF9100;"></span> Naranja
                        </div>
                    </div>

                    <!-- Fuente -->
                    <div class="settings-section-title" data-i18n="st_font_size">Tama√±o Fuente</div>
                    <div class="settings-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                        <div class="setting-btn" onclick="updateFontSize('small')" id="font-btn-small">Aa</div>
                        <div class="setting-btn" onclick="updateFontSize('normal')" id="font-btn-normal">Aa</div>
                        <div class="setting-btn" onclick="updateFontSize('large')" id="font-btn-large">Aa</div>
                    </div>

                    <!-- Idioma -->
                    <div class="settings-section-title" data-i18n="st_language">Idioma</div>
                    <div class="settings-grid">
                        <div class="setting-btn" onclick="updateLanguage('es')" id="lang-btn-es">üá™üá∏ Espa√±ol</div>
                        <div class="setting-btn" onclick="updateLanguage('en')" id="lang-btn-en">üá∫üá∏ English</div>
                    </div>

                    <!-- Acciones -->
                    <div style="border-top:1px solid #444; padding-top:15px; margin-top:10px;">
                        <button onclick="resetToDefaults()" class="secondary-btn" style="color:var(--danger-color); border-color:var(--danger-color); width:100%;" data-i18n="btn_reset_defaults">Restaurar Predeterminados</button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button onclick="closeSettingsModal()" class="secondary-btn" style="margin-top:0; width: 100%;" data-i18n="btn_close">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- BOTTOM NAVIGATION -->
        <nav>
            <button class="nav-btn" onclick="showSection('section-gastos')" id="btn-gastos">
                <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                <span data-i18n="nav_expenses">Gastos</span>
            </button>
            <button class="nav-btn" onclick="showSection('section-ahorro')" id="btn-ahorro">
                <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                <span data-i18n="nav_savings">Ahorro</span>
            </button>
            <button class="nav-btn" onclick="showSection('section-suscripciones')" id="btn-suscripciones">
                <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-7-2h2v-2h-2v2zm0-4h2V8h-2v5z"/></svg>
                <span data-i18n="nav_subscriptions">Suscr.</span>
            </button>
            <button class="nav-btn" onclick="showSection('section-inversiones')" id="btn-inversiones">
                <svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
                <span data-i18n="nav_investments">Inver.</span>
            </button>
        </nav>
    </div>

    <script>
        // --- ESTADO GLOBAL ---
        let gastos = [];
        let objetivos = []; 
        let suscripciones = []; 
        let inversiones = [];
        
        // Estado Vistas y UI
        let currentSubIdForModal = null;
        let currentNoteIndex = 0; 
        let filterHighlighted = false; 
        let selectedStockId = null;
        let currentInvView = 'bolsa'; 

        // --- SISTEMA DE PERSONALIZACI√ìN (AJUSTES) ---
        
        // 1. Configuraci√≥n por defecto
        const defaultSettings = {
            theme: 'dark',           // dark, light, sepia
            primaryColor: 'green',   // green, blue, purple, orange
            fontSize: 'normal',      // small, normal, large
            language: 'es'           // es, en
        };

        let userSettings = { ...defaultSettings };

        // 2. Diccionario de Traducciones
        const translations = {
            es: {
                nav_expenses: "Gastos",
                nav_savings: "Ahorro",
                nav_subscriptions: "Suscr.",
                nav_investments: "Inver.",
                title_expenses: "Resumen de Gastos",
                title_savings: "Objetivos de Ahorro",
                title_subscriptions: "Suscripciones",
                title_investments: "Inversiones",
                title_settings_data: "Ajustes de Datos",
                label_total_today: "Total Hoy",
                label_total_month: "Total Mes",
                label_amount: "Importe (‚Ç¨)",
                label_category: "Categor√≠a",
                label_date: "Fecha",
                label_note: "Nota (Opcional)",
                btn_save_expense: "Guardar Gasto",
                header_recent_moves: "Movimientos Recientes",
                label_saved: "Ahorrado",
                label_goal_total: "Meta Total",
                header_my_goals: "Mis Metas",
                label_monthly_cost: "Gasto Total Mensual",
                header_my_services: "Mis Servicios",
                btn_new_investment: "+ Nueva Inversi√≥n",
                label_total_value: "Valor Total",
                label_total_profit: "Total Ganancia",
                btn_export_json: "üì• Exportar datos (JSON)",
                btn_import_json: "üì§ Importar datos (JSON)",
                modal_settings_title: "Personalizaci√≥n",
                st_theme: "Tema",
                st_color: "Color Principal",
                st_font_size: "Tama√±o Fuente",
                st_language: "Idioma",
                btn_reset_defaults: "Restaurar Predeterminados",
                btn_close: "Cerrar"
            },
            en: {
                nav_expenses: "Expenses",
                nav_savings: "Savings",
                nav_subscriptions: "Subs.",
                nav_investments: "Invest.",
                title_expenses: "Expenses Summary",
                title_savings: "Savings Goals",
                title_subscriptions: "Subscriptions",
                title_investments: "Investments",
                title_settings_data: "Data Settings",
                label_total_today: "Total Today",
                label_total_month: "Total Month",
                label_amount: "Amount (‚Ç¨)",
                label_category: "Category",
                label_date: "Date",
                label_note: "Note (Optional)",
                btn_save_expense: "Save Expense",
                header_recent_moves: "Recent Transactions",
                label_saved: "Saved",
                label_goal_total: "Total Goal",
                header_my_goals: "My Goals",
                label_monthly_cost: "Monthly Total Cost",
                header_my_services: "My Services",
                btn_new_investment: "+ New Investment",
                label_total_value: "Total Value",
                label_total_profit: "Total Profit",
                btn_export_json: "üì• Export Data (JSON)",
                btn_import_json: "üì§ Import Data (JSON)",
                modal_settings_title: "Customization",
                st_theme: "Theme",
                st_color: "Primary Color",
                st_font_size: "Font Size",
                st_language: "Language",
                btn_reset_defaults: "Reset to Defaults",
                btn_close: "Close"
            }
        };

        // Paletas de Temas (Variables CSS que se inyectan)
        const themePalettes = {
            dark: {
                '--bg-color': '#121212',
                '--surface-color': '#1E1E1E',
                '--surface-hover': '#2C2C2C',
                '--text-primary': '#FFFFFF',
                '--text-secondary': '#B0B0B0',
                '--input-bg': '#2C2C2C'
            },
            light: {
                '--bg-color': '#F3F4F6',
                '--surface-color': '#FFFFFF',
                '--surface-hover': '#E5E7EB',
                '--text-primary': '#1F2937',
                '--text-secondary': '#6B7280',
                '--input-bg': '#F9FAFB'
            },
            sepia: {
                '--bg-color': '#F1E7D0',
                '--surface-color': '#E3D5B8',
                '--surface-hover': '#D1C2A5',
                '--text-primary': '#433422',
                '--text-secondary': '#7D6A55',
                '--input-bg': '#EFE2C9'
            }
        };

        const colorPalettes = {
            green: '#00E676',
            blue: '#2979FF',
            purple: '#D500F9',
            orange: '#FF9100'
        };

        const fontSizes = {
            small: '0.9em',
            normal: '1em',
            large: '1.2em'
        };

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar Ajustes UI primero para evitar "flicker"
            loadUserSettings();
            
            // Cargar Fechas default inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-fecha').value = today;
            document.getElementById('input-objetivo-inicio').value = today;
            document.getElementById('input-sub-fecha').value = today;

            // Cargar Datos
            loadGastosFromLocalStorage();
            loadObjetivosFromLocalStorage();
            loadSuscripcionesFromLocalStorage();
            loadInversionesFromLocalStorage();

            // Renderizar todo
            renderGastos();
            calcularTotalesGastos();
            renderObjetivos();
            calcularResumenObjetivos();
            renderSuscripciones();
            calcularTotalMensualSuscripciones();
            renderInversiones(); 

            showSection('section-gastos');

            // Listeners Generales
            document.getElementById('btn-guardar-gasto').addEventListener('click', addGasto);
            document.getElementById('btn-guardar-objetivo').addEventListener('click', addObjetivo);
            document.getElementById('btn-cancelar-edicion').addEventListener('click', resetFormObjetivo);
            document.getElementById('btn-guardar-sub').addEventListener('click', addOrUpdateSuscripcion);
            document.getElementById('btn-cancelar-sub').addEventListener('click', resetFormSuscripcion);
            document.getElementById('btn-guardar-inv').addEventListener('click', addOrUpdateInversion);
            document.getElementById('btn-cancelar-inv').addEventListener('click', resetFormInversion);
            
            // Backup
            document.getElementById('btn-import-json').addEventListener('click', () => document.getElementById('backup-file-input').click());
            document.getElementById('backup-file-input').addEventListener('change', (e) => {
                if (e.target.files[0]) importFintrackFromJson(e.target.files[0]);
                e.target.value = '';
            });
        });

        // --- FUNCIONES DE PERSONALIZACI√ìN ---

        function loadUserSettings() {
            const saved = localStorage.getItem('fintrack-settings');
            if (saved) {
                userSettings = JSON.parse(saved);
            }
            // Aplicar todo
            updateTheme(userSettings.theme, false);
            updateColor(userSettings.primaryColor, false);
            updateFontSize(userSettings.fontSize, false);
            updateLanguage(userSettings.language, false);
        }

        function saveUserSettings() {
            localStorage.setItem('fintrack-settings', JSON.stringify(userSettings));
        }

        function updateTheme(themeName, save = true) {
            if (!themePalettes[themeName]) return;
            const root = document.documentElement;
            const palette = themePalettes[themeName];
            
            // Inyectar variables CSS en vivo
            for (const [key, value] of Object.entries(palette)) {
                root.style.setProperty(key, value);
            }
            
            userSettings.theme = themeName;
            updateSettingsUI('theme', themeName);
            if (save) saveUserSettings();
        }

        function updateColor(colorName, save = true) {
            if (!colorPalettes[colorName]) return;
            document.documentElement.style.setProperty('--primary-color', colorPalettes[colorName]);
            userSettings.primaryColor = colorName;
            updateSettingsUI('color', colorName);
            if (save) saveUserSettings();
        }

        function updateFontSize(sizeName, save = true) {
            if (!fontSizes[sizeName]) return;
            document.documentElement.style.fontSize = fontSizes[sizeName];
            userSettings.fontSize = sizeName;
            updateSettingsUI('font', sizeName);
            if (save) saveUserSettings();
        }

        function updateLanguage(lang, save = true) {
            if (!translations[lang]) return;
            userSettings.language = lang;
            
            // Aplicar traducciones a elementos con data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                         // Para inputs podr√≠a ser placeholder, pero aqu√≠ solo hay labels y botones con texto
                    } else {
                        el.textContent = translations[lang][key];
                    }
                }
            });

            updateSettingsUI('lang', lang);
            if (save) saveUserSettings();
        }

        function resetToDefaults() {
            if(confirm("¬øRestaurar apariencia predeterminada?")) {
                userSettings = { ...defaultSettings };
                updateTheme(userSettings.theme);
                updateColor(userSettings.primaryColor);
                updateFontSize(userSettings.fontSize);
                updateLanguage(userSettings.language);
                saveUserSettings();
            }
        }

        // Funci√≥n de ayuda: t(key) para usar en JS din√°mico
        function t(key) {
            const lang = userSettings.language || 'es';
            return translations[lang][key] || key;
        }

        // Gesti√≥n UI del Modal de Ajustes
        function openSettingsModal() {
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function updateSettingsUI(type, value) {
            // Actualiza la clase 'active' de los botones del modal
            const prefixMap = { 'theme': 'theme-btn-', 'color': 'color-btn-', 'font': 'font-btn-', 'lang': 'lang-btn-' };
            const prefix = prefixMap[type];
            
            // Quitar active de todos los botones de ese tipo
            document.querySelectorAll(`[id^="${prefix}"]`).forEach(btn => btn.classList.remove('active'));
            
            // Poner active al seleccionado
            const activeBtn = document.getElementById(`${prefix}${value}`);
            if (activeBtn) activeBtn.classList.add('active');
        }

        // ==========================================
        //         SISTEMA DE BACKUP (JSON)
        // ==========================================

        function exportFintrackToJson() {
            const backup = {
                version: 1,
                createdAt: new Date().toISOString(),
                gastos, objetivos, suscripciones, inversiones,
                settings: userSettings // Incluimos settings en el backup
            };

            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fintrack-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("Backup descargado", "success");
        }

        function importFintrackFromJson(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.gastos && !data.objetivos && !data.inversiones) throw new Error("Archivo inv√°lido.");

                    if (confirm("Sobrescribir todos los datos?")) {
                        gastos = data.gastos || [];
                        objetivos = data.objetivos || [];
                        suscripciones = data.suscripciones || [];
                        inversiones = data.inversiones || [];
                        
                        // Si hay settings en el backup, restaurarlos (opcional, aqu√≠ lo hacemos)
                        if (data.settings) {
                            userSettings = data.settings;
                            saveUserSettings();
                            loadUserSettings(); // Re-aplica visualmente
                        }

                        localStorage.setItem('fintrack_gastos', JSON.stringify(gastos));
                        localStorage.setItem('fintrack_objetivos', JSON.stringify(objetivos));
                        localStorage.setItem('fintrack_suscripciones', JSON.stringify(suscripciones));
                        localStorage.setItem('fintrack_inversiones', JSON.stringify(inversiones));

                        renderGastos(); calcularTotalesGastos();
                        renderObjetivos(); calcularResumenObjetivos();
                        renderSuscripciones(); calcularTotalMensualSuscripciones();
                        renderInversiones(); 

                        showToast("Datos importados", "success");
                        showSection('section-gastos');
                    }
                } catch (err) {
                    console.error(err);
                    showToast("Error importar: " + err.message, "error");
                }
            };
            reader.readAsText(file);
        }

        // ==========================================
        //         SISTEMA DE NOTIFICACIONES
        // ==========================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerText = message;
            toast.onclick = () => { toast.style.display = 'none'; toast.remove(); };
            setTimeout(() => { if(toast.parentElement) toast.remove(); }, 3000);
            container.appendChild(toast);
        }

        // ==========================================
        //         L√ìGICA DE GASTOS
        // ==========================================
        function loadGastosFromLocalStorage() {
            const storedData = localStorage.getItem('fintrack_gastos');
            if (storedData) gastos = JSON.parse(storedData);
        }
        function saveGastosToLocalStorage() { localStorage.setItem('fintrack_gastos', JSON.stringify(gastos)); }
        
        function addGasto() {
            const importeInput = document.getElementById('input-importe');
            const categoriaSelect = document.getElementById('select-categoria');
            const fechaInput = document.getElementById('input-fecha');
            const notaInput = document.getElementById('input-nota');
            const importe = parseFloat(importeInput.value);
            const categoria = categoriaSelect.value;
            const fecha = fechaInput.value;
            const nota = notaInput.value;
            if (isNaN(importe) || importe <= 0) { alert("Importe inv√°lido."); return; }
            if (!fecha) { alert("Fecha requerida."); return; }
            const nuevoGasto = { id: Date.now(), importe, categoria, fecha, nota };
            gastos.push(nuevoGasto);
            saveGastosToLocalStorage();
            renderGastos();
            calcularTotalesGastos();
            importeInput.value = ''; notaInput.value = ''; categoriaSelect.value = 'Comida'; 
        }

        function renderGastos() {
            const listaContainer = document.getElementById('lista-gastos');
            listaContainer.innerHTML = '';
            const gastosOrdenados = [...gastos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            if (gastosOrdenados.length === 0) {
                listaContainer.innerHTML = '<div class="empty-state">No hay gastos registrados.</div>';
                return;
            }
            gastosOrdenados.forEach(gasto => {
                const item = document.createElement('div');
                item.className = 'gasto-item';
                const fechaObj = new Date(gasto.fecha);
                const fechaStr = fechaObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                item.innerHTML = `
                    <div class="gasto-info">
                        <h4>${gasto.categoria}</h4>
                        <p>${fechaStr} ${gasto.nota ? ' - ' + gasto.nota : ''}</p>
                    </div>
                    <div class="gasto-amount">- ${gasto.importe.toFixed(2)} ‚Ç¨</div>
                `;
                listaContainer.appendChild(item);
            });
        }
        function calcularTotalesGastos() {
            const hoy = new Date().toISOString().split('T')[0];
            const fechaActual = new Date();
            const mesActual = fechaActual.getMonth(); 
            const anioActual = fechaActual.getFullYear();
            let totalHoy = 0, totalMes = 0;
            gastos.forEach(gasto => {
                const fechaGasto = new Date(gasto.fecha);
                if (gasto.fecha === hoy) totalHoy += gasto.importe;
                if (fechaGasto.getMonth() === mesActual && fechaGasto.getFullYear() === anioActual) totalMes += gasto.importe;
            });
            document.getElementById('total-hoy').textContent = totalHoy.toFixed(2) + ' ‚Ç¨';
            document.getElementById('total-mes').textContent = totalMes.toFixed(2) + ' ‚Ç¨';
        }

        // ==========================================
        //     L√ìGICA DE AHORRO
        // ==========================================
        function loadObjetivosFromLocalStorage() {
            const storedData = localStorage.getItem('fintrack_objetivos');
            if (storedData) objetivos = JSON.parse(storedData);
        }
        function saveObjetivosToLocalStorage() { localStorage.setItem('fintrack_objetivos', JSON.stringify(objetivos)); }
        
        function addObjetivo() {
            // ... (L√≥gica igual, omitida por brevedad, el original sigue funcionando)
            const idInput = document.getElementById('input-objetivo-id');
            const nombreInput = document.getElementById('input-objetivo-nombre');
            const totalInput = document.getElementById('input-objetivo-total');
            const ahorradoInput = document.getElementById('input-objetivo-ahorrado');
            const inicioInput = document.getElementById('input-objetivo-inicio');
            const limiteInput = document.getElementById('input-objetivo-limite');
            const id = idInput.value;
            const nombre = nombreInput.value.trim();
            const montoTotal = parseFloat(totalInput.value);
            const montoAhorrado = parseFloat(ahorradoInput.value) || 0;
            const fechaInicio = inicioInput.value;
            const fechaLimite = limiteInput.value;

            if (!nombre) { showToast("Nombre requerido", "error"); return; }
            if (isNaN(montoTotal) || montoTotal <= 0) { showToast("Meta total > 0", "error"); return; }
            
            let estado = 'en_curso';
            if (montoAhorrado >= montoTotal) estado = 'completado';

            if (id) {
                const index = objetivos.findIndex(o => o.id == id);
                if (index !== -1) {
                    objetivos[index] = { ...objetivos[index], nombre, montoTotal, montoAhorrado, fechaInicio, fechaLimite, estado };
                    showToast("Objetivo actualizado", "info");
                }
            } else {
                objetivos.push({ id: Date.now(), nombre, montoTotal, montoAhorrado, fechaInicio, fechaLimite, estado });
                showToast("Objetivo guardado", "success");
            }
            saveObjetivosToLocalStorage();
            renderObjetivos();
            calcularResumenObjetivos();
            resetFormObjetivo();
        }
        function renderObjetivos() {
            const listaContainer = document.getElementById('lista-objetivos');
            listaContainer.innerHTML = ''; 
            if (objetivos.length === 0) { listaContainer.innerHTML = '<div class="empty-state">No tienes metas activas.</div>'; return; }
            objetivos.forEach(obj => {
                const porcentaje = Math.min((obj.montoAhorrado / obj.montoTotal) * 100, 100);
                const inicioStr = obj.fechaInicio ? new Date(obj.fechaInicio).toLocaleDateString('es-ES') : '--';
                const limiteStr = obj.fechaLimite ? new Date(obj.fechaLimite).toLocaleDateString('es-ES') : '--';
                const total = obj.montoTotal || obj.total;
                const ahorrado = obj.montoAhorrado || obj.ahorrado || 0;
                let estadoActual = obj.estado || (ahorrado >= total ? 'completado' : 'en_curso');
                const estadoClass = estadoActual === 'completado' ? 'completado' : 'en_curso';
                const estadoLabel = estadoActual === 'completado' ? '‚úì Completado' : 'En Curso';

                const item = document.createElement('div');
                item.className = 'objetivo-card';
                item.innerHTML = `
                    <div class="objetivo-header">
                        <div><span class="objetivo-title">${obj.nombre}</span><div class="objetivo-fechas">Inicio: ${inicioStr} &bull; Fin: ${limiteStr}</div></div>
                        <span class="status-badge ${estadoClass}">${estadoLabel}</span>
                    </div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill ${estadoClass}" style="width: ${porcentaje}%"></div></div>
                    <div class="objetivo-stats"><span>${ahorrado.toFixed(2)} ‚Ç¨ de ${total.toFixed(2)} ‚Ç¨ (${porcentaje.toFixed(0)}%)</span></div>
                    <div class="card-actions">
                        <button class="btn-action btn-add" onclick="addAhorro(${obj.id})">+ Ahorrar</button>
                        <button class="btn-action btn-edit" onclick="editObjetivo(${obj.id})">Editar</button>
                        <button class="btn-action btn-delete" onclick="deleteObjetivo(${obj.id})">Borrar</button>
                    </div>
                `;
                listaContainer.appendChild(item);
            });
        }
        function editObjetivo(id) {
            const obj = objetivos.find(o => o.id === id);
            if (!obj) return;
            document.getElementById('input-objetivo-id').value = obj.id;
            document.getElementById('input-objetivo-nombre').value = obj.nombre;
            document.getElementById('input-objetivo-total').value = obj.montoTotal || obj.total;
            document.getElementById('input-objetivo-ahorrado').value = obj.montoAhorrado || obj.ahorrado;
            document.getElementById('input-objetivo-inicio').value = obj.fechaInicio;
            document.getElementById('input-objetivo-limite').value = obj.fechaLimite;
            document.getElementById('btn-guardar-objetivo').textContent = "Actualizar Objetivo";
            document.getElementById('btn-cancelar-edicion').style.display = "block";
            document.querySelector('#section-ahorro .form-container').scrollIntoView({ behavior: 'smooth' });
        }
        function deleteObjetivo(id) {
            if(!confirm("¬øBorrar meta?")) return;
            objetivos = objetivos.filter(o => o.id !== id);
            saveObjetivosToLocalStorage();
            renderObjetivos();
            calcularResumenObjetivos();
            showToast("Objetivo eliminado", "error");
            if (document.getElementById('input-objetivo-id').value == id) resetFormObjetivo();
        }
        function addAhorro(id) {
            const obj = objetivos.find(o => o.id === id);
            if (!obj) return;
            const ingreso = prompt(`¬øCu√°nto a√±ades a "${obj.nombre}"?`);
            if (ingreso === null) return; 
            const cantidad = parseFloat(ingreso);
            if (isNaN(cantidad) || cantidad <= 0) { showToast("Cantidad inv√°lida", "error"); return; }
            let actual = obj.montoAhorrado || obj.ahorrado || 0;
            let total = obj.montoTotal || obj.total;
            obj.montoAhorrado = actual + cantidad;
            obj.ahorrado = obj.montoAhorrado; 
            showToast("Ahorro a√±adido", "success");
            if (obj.montoAhorrado >= total) { obj.estado = 'completado'; showToast("¬°Meta completada!", "success"); }
            saveObjetivosToLocalStorage();
            renderObjetivos();
            calcularResumenObjetivos();
        }
        function resetFormObjetivo() {
            document.getElementById('input-objetivo-id').value = '';
            document.getElementById('input-objetivo-nombre').value = '';
            document.getElementById('input-objetivo-total').value = '';
            document.getElementById('input-objetivo-ahorrado').value = '0';
            document.getElementById('input-objetivo-inicio').value = new Date().toISOString().split('T')[0];
            document.getElementById('input-objetivo-limite').value = '';
            document.getElementById('btn-guardar-objetivo').textContent = "Guardar Objetivo";
            document.getElementById('btn-cancelar-edicion').style.display = "none";
        }
        function calcularResumenObjetivos() {
            let totalAcumulado = 0, totalObjetivos = 0;
            objetivos.forEach(obj => {
                totalAcumulado += (obj.montoAhorrado || obj.ahorrado || 0);
                totalObjetivos += (obj.montoTotal || obj.total || 0);
            });
            document.getElementById('ahorro-total-acumulado').textContent = totalAcumulado.toFixed(2) + ' ‚Ç¨';
            document.getElementById('ahorro-total-objetivos').textContent = totalObjetivos.toFixed(2) + ' ‚Ç¨';
        }

        // ==========================================
        //    L√ìGICA DE SUSCRIPCIONES
        // ==========================================
        function loadSuscripcionesFromLocalStorage() {
            const storedData = localStorage.getItem('fintrack_suscripciones');
            if (storedData) {
                suscripciones = JSON.parse(storedData);
                suscripciones.forEach(sub => {
                    if (typeof sub.notas === 'string' && sub.notas.length > 0) {
                        const oldNote = { id: Date.now(), texto: sub.notas, destacada: false, fechaCreacion: new Date().toLocaleString('es-ES') };
                        sub.notas = [oldNote];
                    } else if (!Array.isArray(sub.notas)) { sub.notas = []; }
                });
                saveSuscripcionesToLocalStorage();
            }
        }
        function saveSuscripcionesToLocalStorage() { localStorage.setItem('fintrack_suscripciones', JSON.stringify(suscripciones)); }
        
        function addOrUpdateSuscripcion() {
             const idInput = document.getElementById('input-sub-id');
            const nombreInput = document.getElementById('input-sub-nombre');
            const precioInput = document.getElementById('input-sub-precio');
            const periodoSelect = document.getElementById('select-sub-periodo');
            const catSelect = document.getElementById('select-sub-categoria');
            const fechaInput = document.getElementById('input-sub-fecha');
            const id = idInput.value;
            const nombre = nombreInput.value.trim();
            const precio = parseFloat(precioInput.value);
            const periodicidad = periodoSelect.value;
            const categoria = catSelect.value;
            const fechaProximoCobro = fechaInput.value;
            if (!nombre) { showToast("Nombre requerido", "error"); return; }
            if (isNaN(precio) || precio <= 0) { showToast("Precio inv√°lido", "error"); return; }
            let currentNotes = [];
            if (id) {
                const existing = suscripciones.find(s => s.id == id);
                if (existing) currentNotes = existing.notas || [];
            }
            const subData = { nombre, precio, periodicidad, categoria, fechaProximoCobro, notas: currentNotes };
            if (id) {
                const index = suscripciones.findIndex(s => s.id == id);
                if (index !== -1) { suscripciones[index] = { ...suscripciones[index], ...subData }; showToast("Suscripci√≥n actualizada", "info"); }
            } else {
                suscripciones.push({ id: Date.now(), ...subData }); showToast("Suscripci√≥n a√±adida", "success");
            }
            saveSuscripcionesToLocalStorage();
            renderSuscripciones();
            calcularTotalMensualSuscripciones();
            resetFormSuscripcion();
        }
        function renderSuscripciones() {
             const lista = document.getElementById('lista-suscripciones');
            lista.innerHTML = '';
            if (suscripciones.length === 0) { lista.innerHTML = '<div class="empty-state">No tienes suscripciones activas.</div>'; return; }
            const subsSorted = [...suscripciones].sort((a, b) => {
                 if(!a.fechaProximoCobro) return 1;
                 if(!b.fechaProximoCobro) return -1;
                 return new Date(a.fechaProximoCobro) - new Date(b.fechaProximoCobro);
            });
            subsSorted.forEach(sub => {
                let precioStr = `${sub.precio.toFixed(2)} ‚Ç¨ / mes`;
                if (sub.periodicidad === 'anual') {
                    const mensualEq = sub.precio / 12;
                    precioStr = `${sub.precio.toFixed(2)} ‚Ç¨ / a√±o (~${mensualEq.toFixed(2)} ‚Ç¨/mes)`;
                }
                const fechaCobroStr = sub.fechaProximoCobro ? new Date(sub.fechaProximoCobro).toLocaleDateString('es-ES', {day: 'numeric', month: 'short'}) : 'Sin fecha';
                const hasNotes = Array.isArray(sub.notas) && sub.notas.length > 0;
                const notesIcon = hasNotes ? '<span class="notes-badge">üìù</span>' : '';
                const item = document.createElement('div');
                item.className = 'sub-card';
                item.setAttribute('onclick', `openSubModal(${sub.id})`);
                item.innerHTML = `
                    <div class="sub-row"><span class="sub-name">${sub.nombre} ${notesIcon}</span><span class="sub-price">${precioStr}</span></div>
                    <div class="sub-row"><span class="sub-detail">Pr√≥ximo: ${fechaCobroStr}</span><span class="sub-badge">${sub.categoria}</span></div>
                    <div class="card-actions" style="margin-top:10px; padding-top:10px; border-top:1px solid #333;" onclick="event.stopPropagation()">
                        <button class="btn-action btn-edit" onclick="editSuscripcion(${sub.id})">Editar</button>
                        <button class="btn-action btn-delete" onclick="deleteSuscripcion(${sub.id})">Borrar</button>
                    </div>
                `;
                lista.appendChild(item);
            });
        }
        function editSuscripcion(id) {
             const sub = suscripciones.find(s => s.id === id);
            if (!sub) return;
            document.getElementById('input-sub-id').value = sub.id;
            document.getElementById('input-sub-nombre').value = sub.nombre;
            document.getElementById('input-sub-precio').value = sub.precio;
            document.getElementById('select-sub-periodo').value = sub.periodicidad;
            document.getElementById('select-sub-categoria').value = sub.categoria;
            document.getElementById('input-sub-fecha').value = sub.fechaProximoCobro;
            document.getElementById('btn-guardar-sub').textContent = "Actualizar Suscripci√≥n";
            document.getElementById('btn-cancelar-sub').style.display = "block";
            document.querySelector('#section-suscripciones .form-container').scrollIntoView({ behavior: 'smooth' });
        }
        function deleteSuscripcion(id) {
             if(!confirm("¬øBorrar suscripci√≥n?")) return;
            suscripciones = suscripciones.filter(s => s.id !== id);
            saveSuscripcionesToLocalStorage();
            renderSuscripciones();
            calcularTotalMensualSuscripciones();
            showToast("Suscripci√≥n eliminada", "error");
            if (document.getElementById('input-sub-id').value == id) resetFormSuscripcion();
        }
        function resetFormSuscripcion() {
            document.getElementById('input-sub-id').value = '';
            document.getElementById('input-sub-nombre').value = '';
            document.getElementById('input-sub-precio').value = '';
            document.getElementById('select-sub-periodo').value = 'mensual';
            document.getElementById('select-sub-categoria').value = 'Streaming';
            document.getElementById('input-sub-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('btn-guardar-sub').textContent = "Guardar Suscripci√≥n";
            document.getElementById('btn-cancelar-sub').style.display = "none";
        }
        function calcularTotalMensualSuscripciones() {
             let totalMensual = 0;
            suscripciones.forEach(sub => {
                if (sub.periodicidad === 'mensual') { totalMensual += sub.precio; }
                else if (sub.periodicidad === 'anual') { totalMensual += (sub.precio / 12); }
            });
            document.getElementById('total-mensual-suscripciones').textContent = totalMensual.toFixed(2) + ' ‚Ç¨';
        }

        // --- L√ìGICA MODAL & FLASHCARDS ---
        function openSubModal(id) {
            const sub = suscripciones.find(s => s.id === id); if (!sub) return;
            currentSubIdForModal = id; currentNoteIndex = 0; filterHighlighted = false; 
            document.getElementById('modal-sub-name').textContent = sub.nombre;
            const fecha = sub.fechaProximoCobro ? new Date(sub.fechaProximoCobro).toLocaleDateString('es-ES') : 'Sin fecha';
            const detalleHtml = `<p><strong>Precio:</strong> ${sub.precio.toFixed(2)} ‚Ç¨ (${sub.periodicidad})</p><p><strong>Categor√≠a:</strong> ${sub.categoria}</p><p><strong>Pr√≥ximo cobro:</strong> ${fecha}</p>`;
            document.getElementById('modal-sub-details').innerHTML = detalleHtml;
            document.getElementById('input-new-note').value = '';
            updateFilterButtonUI(); renderFlashcardUI();
            document.getElementById('sub-modal').style.display = 'flex';
        }
        function closeSubModal() { document.getElementById('sub-modal').style.display = 'none'; currentSubIdForModal = null; }
        function renderFlashcardUI() {
            const sub = suscripciones.find(s => s.id === currentSubIdForModal); if (!sub) return;
            let visibleNotes = sub.notas || [];
            if (filterHighlighted) visibleNotes = visibleNotes.filter(n => n.destacada === true);
            if (currentNoteIndex >= visibleNotes.length) currentNoteIndex = Math.max(0, visibleNotes.length - 1);
            const display = document.getElementById('flashcard-display');
            const indicator = document.getElementById('flashcard-indicator');
            const btnPrev = document.getElementById('btn-prev-note');
            const btnNext = document.getElementById('btn-next-note');
            display.className = 'flashcard-display'; 
            if (visibleNotes.length === 0) {
                const msg = filterHighlighted ? "No hay notas destacadas." : "Sin notas a√∫n.";
                display.innerHTML = `<p class="empty-flashcard">${msg}</p>`; indicator.textContent = "0 / 0";
                btnPrev.disabled = true; btnNext.disabled = true;
            } else {
                const note = visibleNotes[currentNoteIndex];
                const starIcon = note.destacada ? '‚òÖ' : '‚òÜ';
                const starClass = note.destacada ? 'active' : '';
                if (note.destacada) display.classList.add('is-highlighted');
                display.innerHTML = `<div class="flashcard-meta"><span>${note.fechaCreacion}</span><span>#${note.id.toString().slice(-4)}</span></div><div class="flashcard-text">${note.texto}</div><button class="btn-star-large ${starClass}" onclick="toggleNoteHighlight(${note.id})">${starIcon}</button>`;
                indicator.textContent = `${currentNoteIndex + 1} / ${visibleNotes.length}`;
                btnPrev.disabled = (currentNoteIndex === 0);
                btnNext.disabled = (currentNoteIndex === visibleNotes.length - 1);
            }
        }
        function prevNote() { if (currentNoteIndex > 0) { currentNoteIndex--; renderFlashcardUI(); } }
        function nextNote() {
            const sub = suscripciones.find(s => s.id === currentSubIdForModal); if (!sub) return;
            let count = sub.notas.length;
            if (filterHighlighted) count = sub.notas.filter(n => n.destacada).length;
            if (currentNoteIndex < count - 1) { currentNoteIndex++; renderFlashcardUI(); }
        }
        function toggleFilterHighlighted() { filterHighlighted = !filterHighlighted; currentNoteIndex = 0; updateFilterButtonUI(); renderFlashcardUI(); }
        function updateFilterButtonUI() {
            const btn = document.getElementById('btn-filter-star');
            if (filterHighlighted) btn.classList.add('active'); else btn.classList.remove('active');
        }
        function addNoteToSub() {
            if (!currentSubIdForModal) return;
            const input = document.getElementById('input-new-note'); const text = input.value.trim();
            if (!text) { showToast("Escribe algo...", "error"); return; }
            const subIndex = suscripciones.findIndex(s => s.id === currentSubIdForModal);
            if (subIndex !== -1) {
                const newNote = { id: Date.now(), texto: text, destacada: false, fechaCreacion: new Date().toLocaleString('es-ES') };
                if(!suscripciones[subIndex].notas) suscripciones[subIndex].notas = [];
                suscripciones[subIndex].notas.push(newNote);
                saveSuscripcionesToLocalStorage();
                if (filterHighlighted) { filterHighlighted = false; updateFilterButtonUI(); }
                currentNoteIndex = suscripciones[subIndex].notas.length - 1;
                renderFlashcardUI(); renderSuscripciones(); 
                input.value = ''; showToast("Nota a√±adida", "success");
            }
        }
        function toggleNoteHighlight(noteId) {
             const subIndex = suscripciones.findIndex(s => s.id === currentSubIdForModal);
            if (subIndex !== -1) {
                const noteIndex = suscripciones[subIndex].notas.findIndex(n => n.id === noteId);
                if (noteIndex !== -1) {
                    suscripciones[subIndex].notas[noteIndex].destacada = !suscripciones[subIndex].notas[noteIndex].destacada;
                    saveSuscripcionesToLocalStorage();
                    renderFlashcardUI(); 
                }
            }
        }

        // ==========================================
        //    L√ìGICA DE INVERSIONES
        // ==========================================
        function loadInversionesFromLocalStorage() {
            const storedData = localStorage.getItem('fintrack_inversiones');
            if (storedData) inversiones = JSON.parse(storedData);
        }
        function saveInversionesToLocalStorage() { localStorage.setItem('fintrack_inversiones', JSON.stringify(inversiones)); }
        function calcularValoresInversion(inv) {
            const invertido = inv.cantidad * inv.precioCompra;
            const valor = inv.cantidad * inv.precioActual;
            const ganancia = valor - invertido;
            const porcentaje = invertido === 0 ? 0 : (ganancia / invertido) * 100;
            return { invertido, valor, ganancia, porcentaje };
        }
        function calcularResumenInversiones() {
             let totalInvertido = 0; let totalValor = 0;
            inversiones.forEach(inv => {
                const vals = calcularValoresInversion(inv);
                totalInvertido += vals.invertido; totalValor += vals.valor;
            });
            const gananciaGlobal = totalValor - totalInvertido;
            const porcentajeGlobal = totalInvertido === 0 ? 0 : (gananciaGlobal / totalInvertido) * 100;
            document.getElementById('inv-total-valor').textContent = totalValor.toFixed(2) + ' ‚Ç¨';
            const spanGanancia = document.getElementById('inv-total-ganancia');
            const signo = gananciaGlobal > 0 ? '+' : '';
            spanGanancia.textContent = `${signo}${gananciaGlobal.toFixed(2)} ‚Ç¨ (${porcentajeGlobal.toFixed(2)}%)`;
            spanGanancia.className = 'amount';
            if (gananciaGlobal > 0) spanGanancia.classList.add('text-green');
            else if (gananciaGlobal < 0) spanGanancia.classList.add('text-red');
            else spanGanancia.classList.add('text-neutral');
        }
        function addOrUpdateInversion() {
            const idInput = document.getElementById('input-inv-id');
            const nombreInput = document.getElementById('input-inv-nombre');
            const tipoSelect = document.getElementById('select-inv-tipo');
            const tickerInput = document.getElementById('input-inv-ticker');
            const cantidadInput = document.getElementById('input-inv-cantidad');
            const precioCompraInput = document.getElementById('input-inv-precio-compra');
            const precioActualInput = document.getElementById('input-inv-precio-actual');
            const id = idInput.value;
            const nombre = nombreInput.value.trim();
            const tipo = tipoSelect.value;
            const ticker = tickerInput.value.trim().toUpperCase();
            const cantidad = parseFloat(cantidadInput.value);
            const precioCompra = parseFloat(precioCompraInput.value);
            const precioActual = parseFloat(precioActualInput.value);
            if (!nombre) { showToast("Nombre requerido", "error"); return; }
            if (!ticker) { showToast("Ticker requerido", "error"); return; }
            if (isNaN(cantidad) || cantidad < 0) { showToast("Cantidad inv√°lida", "error"); return; }
            if (isNaN(precioCompra) || precioCompra < 0) { showToast("Precio compra inv√°lido", "error"); return; }
            if (isNaN(precioActual) || precioActual < 0) { showToast("Precio actual inv√°lido", "error"); return; }
            const invData = { nombre, tipo, ticker, cantidad, precioCompra, precioActual };
            if (id) {
                const index = inversiones.findIndex(i => i.id == id);
                if (index !== -1) { inversiones[index] = { ...inversiones[index], ...invData }; showToast("Inversi√≥n actualizada", "info"); }
            } else {
                inversiones.push({ id: Date.now(), ...invData }); showToast("Inversi√≥n a√±adida", "success");
            }
            saveInversionesToLocalStorage();
            renderInversiones(); toggleInvForm(false); resetFormInversion();
        }
        function renderInversiones() { calcularResumenInversiones(); showInversionesView(currentInvView); }
        function showInversionesView(viewName) {
            currentInvView = viewName;
            document.querySelectorAll('.view-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${viewName}`).classList.add('active');
            document.getElementById('inv-bolsa-view').style.display = 'none';
            document.getElementById('inv-cripto-view').style.display = 'none';
            document.getElementById('inv-otros-view').style.display = 'none';
            if(viewName === 'bolsa') { document.getElementById('inv-bolsa-view').style.display = 'block'; renderVistaBolsa(); }
            else if (viewName === 'cripto') { document.getElementById('inv-cripto-view').style.display = 'block'; renderVistaCripto(); }
            else if (viewName === 'otros') { document.getElementById('inv-otros-view').style.display = 'block'; renderVistaOtros(); }
        }
        function renderVistaBolsa() {
            const bolsaItems = inversiones.filter(inv => inv.tipo === 'Acci√≥n/ETF');
            let totalInvertido = 0; let totalValor = 0;
            const tbody = document.getElementById('tabla-bolsa-body'); tbody.innerHTML = '';
            if (bolsaItems.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#666;">No hay acciones registradas.</td></tr>'; }
            else {
                bolsaItems.forEach(inv => {
                    const { invertido, valor, ganancia, porcentaje } = calcularValoresInversion(inv);
                    totalInvertido += invertido; totalValor += valor;
                    let colorClass = 'text-neutral'; if (ganancia > 0) colorClass = 'text-green'; if (ganancia < 0) colorClass = 'text-red';
                    const row = document.createElement('tr');
                    const isSelected = (selectedStockId == inv.id);
                    row.className = `stock-row ${isSelected ? 'selected' : ''}`;
                    row.onclick = () => selectStockRow(inv.id);
                    row.innerHTML = `<td class="stock-ticker">${inv.ticker}</td><td>${inv.nombre}</td><td>${inv.cantidad}</td><td>${inv.precioCompra.toFixed(2)}</td><td>${inv.precioActual.toFixed(2)}</td><td class="${colorClass}">${ganancia.toFixed(2)}</td><td class="${colorClass}">${porcentaje.toFixed(2)}%</td>`;
                    tbody.appendChild(row);
                });
            }
            document.getElementById('bolsa-total-invertido').textContent = totalInvertido.toFixed(2) + ' ‚Ç¨';
            document.getElementById('bolsa-total-valor').textContent = totalValor.toFixed(2) + ' ‚Ç¨';
        }
        function renderVistaCripto() {
             const criptoItems = inversiones.filter(inv => inv.tipo === 'Cripto');
            let totalInvertido = 0; let totalValor = 0;
            const tbody = document.getElementById('tabla-cripto-body'); tbody.innerHTML = '';
            if (criptoItems.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#666;">No hay criptomonedas.</td></tr>'; }
            else {
                criptoItems.forEach(inv => {
                    const { invertido, valor, ganancia, porcentaje } = calcularValoresInversion(inv);
                    totalInvertido += invertido; totalValor += valor;
                    let colorClass = 'text-neutral'; if (ganancia > 0) colorClass = 'text-green'; if (ganancia < 0) colorClass = 'text-red';
                    const row = document.createElement('tr'); row.className = 'stock-row';
                    row.innerHTML = `<td class="stock-ticker" style="color:var(--crypto-color)">${inv.ticker}</td><td>${inv.nombre}</td><td>${inv.cantidad}</td><td>${inv.precioCompra.toFixed(2)}</td><td>${inv.precioActual.toFixed(2)}</td><td class="${colorClass}">${ganancia.toFixed(2)}</td><td class="${colorClass}">${porcentaje.toFixed(2)}%</td><td><button class="btn-api" onclick="actualizarPrecioCripto(${inv.id})">‚Üª</button><button class="toggle-filter-btn" onclick="editInversion(${inv.id})">‚úé</button><button class="toggle-filter-btn" onclick="deleteInversion(${inv.id})">üóë</button></td>`;
                    tbody.appendChild(row);
                });
            }
            document.getElementById('cripto-total-invertido').textContent = totalInvertido.toFixed(2) + ' ‚Ç¨';
            document.getElementById('cripto-total-valor').textContent = totalValor.toFixed(2) + ' ‚Ç¨';
        }
        function renderVistaOtros() {
            const otrosItems = inversiones.filter(inv => inv.tipo === 'Otro');
            let totalInvertido = 0; let totalValor = 0;
            const tbody = document.getElementById('tabla-otros-body'); tbody.innerHTML = '';
            if (otrosItems.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#666;">No hay otros activos.</td></tr>'; }
            else {
                otrosItems.forEach(inv => {
                    const { invertido, valor, ganancia, porcentaje } = calcularValoresInversion(inv);
                    totalInvertido += invertido; totalValor += valor;
                    let colorClass = 'text-neutral'; if (ganancia > 0) colorClass = 'text-green'; if (ganancia < 0) colorClass = 'text-red';
                    const row = document.createElement('tr'); row.className = 'stock-row';
                    row.innerHTML = `<td>${inv.nombre}</td><td>${inv.ticker || '-'}</td><td>${inv.cantidad}</td><td>${inv.precioCompra.toFixed(2)}</td><td>${inv.precioActual.toFixed(2)}</td><td class="${colorClass}">${ganancia.toFixed(2)}</td><td class="${colorClass}">${porcentaje.toFixed(2)}%</td>`;
                    row.onclick = () => editInversion(inv.id);
                    tbody.appendChild(row);
                });
            }
            document.getElementById('otros-total-invertido').textContent = totalInvertido.toFixed(2) + ' ‚Ç¨';
            document.getElementById('otros-total-valor').textContent = totalValor.toFixed(2) + ' ‚Ç¨';
        }
        async function actualizarPrecioCripto(id) {
            const inv = inversiones.find(i => i.id === id); if (!inv || !inv.ticker) return;
            const cryptoId = inv.ticker.trim().toLowerCase(); 
            showToast(`Actualizando ${inv.nombre}...`, 'info');
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${cryptoId}&vs_currencies=eur`);
                if (!response.ok) throw new Error("Error API");
                const data = await response.json();
                if (data[cryptoId] && data[cryptoId].eur) {
                    inv.precioActual = data[cryptoId].eur;
                    saveInversionesToLocalStorage(); renderInversiones(); 
                    showToast(`Precio actualizado: ${inv.precioActual} ‚Ç¨`, 'success');
                } else { showToast(`ID '${cryptoId}' no encontrado`, 'error'); }
            } catch (error) { console.error(error); showToast("Error de conexi√≥n con CoinGecko", 'error'); }
        }
        function toggleInvForm(show) {
            const formContainer = document.getElementById('inv-form-container');
            if (show) { formContainer.style.display = 'block'; formContainer.scrollIntoView({ behavior: 'smooth' }); }
            else { formContainer.style.display = 'none'; }
        }
        function editInversion(id) {
            const inv = inversiones.find(i => i.id === id); if (!inv) return;
            toggleInvForm(true);
            document.getElementById('input-inv-id').value = inv.id;
            document.getElementById('input-inv-nombre').value = inv.nombre;
            document.getElementById('select-inv-tipo').value = inv.tipo;
            document.getElementById('input-inv-ticker').value = inv.ticker;
            document.getElementById('input-inv-cantidad').value = inv.cantidad;
            document.getElementById('input-inv-precio-compra').value = inv.precioCompra;
            document.getElementById('input-inv-precio-actual').value = inv.precioActual;
            document.getElementById('btn-guardar-inv').textContent = "Actualizar Inversi√≥n";
            document.getElementById('btn-cancelar-inv').style.display = "block";
        }
        function deleteInversion(id) {
            if(!confirm("¬øBorrar inversi√≥n?")) return;
            inversiones = inversiones.filter(i => i.id !== id);
            saveInversionesToLocalStorage(); renderInversiones(); showToast("Inversi√≥n eliminada", "error");
            if (document.getElementById('input-inv-id').value == id) { resetFormInversion(); toggleInvForm(false); }
        }
        function resetFormInversion() {
            document.getElementById('input-inv-id').value = '';
            document.getElementById('input-inv-nombre').value = '';
            document.getElementById('select-inv-tipo').value = 'Acci√≥n/ETF';
            document.getElementById('input-inv-ticker').value = '';
            document.getElementById('input-inv-cantidad').value = '';
            document.getElementById('input-inv-precio-compra').value = '';
            document.getElementById('input-inv-precio-actual').value = '';
            document.getElementById('btn-guardar-inv').textContent = "Guardar Inversi√≥n";
            toggleInvForm(false); 
        }
        function selectStockRow(id) { selectedStockId = id; renderVistaBolsa(); loadStockDetails(id); }
        function loadStockDetails(id) {
            const stock = inversiones.find(i => i.id === id);
            if(stock) {
                const panel = document.getElementById('stock-details-panel');
                if (panel) { panel.style.display = 'block'; panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
                fetchHistoricoBolsa(stock.ticker);
            }
        }
        function refreshStockData() {
            if (selectedStockId) { const stock = inversiones.find(i => i.id === selectedStockId); if (stock) fetchHistoricoBolsa(stock.ticker); }
            else { showToast("Selecciona una acci√≥n primero", "info"); }
        }
        async function fetchHistoricoBolsa(ticker) {
            const title = document.getElementById('detail-ticker');
            const tbody = document.getElementById('tabla-historico-body');
            if (title) title.textContent = ticker;
            if (tbody) tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Cargando datos de mercado...</td></tr>';
            setTimeout(() => {
                const stock = inversiones.find(i => i.ticker === ticker);
                const precioBase = stock ? stock.precioActual : 100;
                const mockData = generateMockHistory(precioBase);
                renderHistoricoTable(mockData); drawStockChart(mockData);
            }, 600); 
        }
        function generateMockHistory(basePrice) {
            let data = []; let currentPrice = basePrice; const today = new Date();
            for (let i = 0; i < 30; i++) {
                const date = new Date(today); date.setDate(today.getDate() - i);
                const change = (Math.random() - 0.5) * 0.05; currentPrice = currentPrice * (1 - change); 
                data.push({ fecha: date.toISOString().split('T')[0], cierre: currentPrice });
            }
            return data.reverse(); 
        }
        function renderHistoricoTable(data) {
            const tbody = document.getElementById('tabla-historico-body'); if (!tbody) return;
            tbody.innerHTML = '';
            const viewData = [...data].reverse();
            viewData.forEach((day, index) => {
                let varPct = 0; let varText = "‚Äî"; let colorClass = "text-neutral";
                if (index < viewData.length - 1) {
                    const prevClose = viewData[index + 1].cierre;
                    if (prevClose !== 0) {
                        varPct = ((day.cierre - prevClose) / prevClose) * 100;
                        varText = varPct.toFixed(2) + "%";
                        if (varPct > 0) { varText = "+" + varText; colorClass = "text-green"; }
                        if (varPct < 0) colorClass = "text-red";
                    }
                }
                const row = `<tr><td>${day.fecha}</td><td>${day.cierre.toFixed(2)} ‚Ç¨</td><td class="${colorClass}">${varText}</td></tr>`;
                tbody.innerHTML += row;
            });
        }
        function drawStockChart(data) {
            const canvas = document.getElementById('stockChart'); if (!canvas) return;
            const ctx = canvas.getContext('2d'); if (!ctx) return;
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) return;
            canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const width = rect.width; const height = rect.height; const padding = 30;
            ctx.clearRect(0, 0, width, height);
            const prices = data.map(d => d.cierre); if (prices.length === 0) return;
            const minPrice = Math.min(...prices) * 0.98; const maxPrice = Math.max(...prices) * 1.02; const range = maxPrice - minPrice;
            ctx.beginPath(); ctx.strokeStyle = '#2979FF'; ctx.lineWidth = 2.5; ctx.lineJoin = 'round';
            data.forEach((point, i) => {
                const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((point.cierre - minPrice) / range) * (height - 2 * padding);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, "rgba(41, 121, 255, 0.2)");
            gradient.addColorStop(1, "rgba(41, 121, 255, 0)");
            ctx.lineTo(width - padding, height - padding);
            ctx.lineTo(padding, height - padding);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();
        }

        // --- L√ìGICA DE NAVEGACI√ìN ---
        function showSection(sectionId) {
            const sections = document.querySelectorAll('section');
            sections.forEach(section => section.classList.remove('active'));
            const activeSection = document.getElementById(sectionId);
            if (activeSection) activeSection.classList.add('active');
            updateNavState(sectionId);
        }
        function updateNavState(activeSectionId) {
            const btnId = activeSectionId.replace('section-', 'btn-');
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(btnId);
            if (activeBtn) activeBtn.classList.add('active');
        }
        function addInversion() { toggleInvForm(true); }

    </script>
</body>
</html>
