<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART CITY: NEURAL GRID V4.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://jdyfpihuvsoeukzqorbz.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkeWZwaWh1dnNvZXVrenFvcmJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5OTA3NzYsImV4cCI6MjA4NDU2Njc3Nn0.oDPNMGzLVyRLADSxr2q3rW3nGgHoUTX4e3hfpivP92k'

        const supabaseClient = supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
        )
    </script>
    <style>
        :root {
            /* Base Palette from ciudad4-1 */
            --city-bg: #020617;
            --city-base: #06b6d4;
            /* Cyan-500 equivalent */

            /* Monochromatic Sector Styles */
            --sector-a: rgba(6, 182, 212, 0.15);
            /* Financial/Core */
            --sector-b: rgba(6, 182, 212, 0.08);
            /* Industrial */
            --sector-c: rgba(6, 182, 212, 0.05);
            /* Residential */
            --sector-d: rgba(6, 182, 212, 0.02);
            /* Dark/Suburbs */

            /* Tower Status Colors (Only these break the monochrome) */
            --tower-online: #22c55e;
            --tower-transition: #eab308;
            --tower-off: #334155;
            --tower-error: #ef4444;

            --color-road: rgba(6, 182, 212, 0.2);
            --color-data: #ccfbf1;
        }

        body {
            background-color: var(--city-bg);
            color: #f8fafc;
            font-family: 'Inter', system-ui, sans-serif;
            overflow: hidden;
            margin: 0;
            height: 100vh;
            width: 100vw;
            perspective: 1000px;
            /* For Parallax */
        }

        /* --- VISUAL EFFECTS --- */
        .scanline {
            width: 100%;
            height: 200px;
            z-index: 20;
            background: linear-gradient(0deg, transparent 0%, rgba(6, 182, 212, 0.05) 50%, transparent 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scan 8s linear infinite;
            pointer-events: none;
        }

        @keyframes scan {
            0% {
                bottom: 100%;
            }

            100% {
                bottom: -200px;
            }
        }

        .glass-panel {
            background: rgba(2, 6, 23, 0.85);
            /* Darker for better contrast */
            backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid rgba(6, 182, 212, 0.15);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        /* --- MAP CONTAINER (PARALLAX TARGET) --- */
        #viewport {
            position: absolute;
            inset: -5%;
            /* Larger than screen to allow panning */
            width: 110%;
            height: 110%;
            z-index: 0;
            background: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 80%);
            transform-style: preserve-3d;
            will-change: transform;
            transition: transform 0.1s ease-out;
            /* Smooth follow */
        }

        /* --- SVG STYLES --- */
        .district {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            stroke-width: 1;
            stroke: rgba(6, 182, 212, 0.2);
            fill-opacity: 1;
        }

        .district:hover {
            fill-opacity: 0.8;
            stroke: var(--city-base);
            stroke-width: 2;
            filter: drop-shadow(0 0 15px rgba(6, 182, 212, 0.3));
        }

        .district.selected {
            stroke: #fff !important;
            stroke-width: 3 !important;
            filter: drop-shadow(0 0 30px rgba(6, 182, 212, 0.6)) !important;
        }

        /* Specific Monochrome Sector Fills */
        .sector-a {
            fill: var(--sector-a);
        }

        .sector-b {
            fill: var(--sector-b);
        }

        .sector-c {
            fill: var(--sector-c);
        }

        .sector-d {
            fill: var(--sector-d);
        }

        /* Roads & Data */
        .city-road {
            stroke: var(--color-road);
            stroke-width: 1.5;
            fill: none;
            stroke-dasharray: 2, 8;
            opacity: 0.5;
        }

        .data-packet {
            fill: var(--color-data);
            filter: drop-shadow(0 0 8px var(--city-base));
        }

        /* Towers */
        .tower-beacon {
            transition: fill 0.4s, filter 0.4s;
        }

        .tower-online {
            fill: var(--tower-online);
            filter: drop-shadow(0 0 20px var(--tower-online));
        }

        .tower-transition {
            fill: var(--tower-transition);
            animation: pulse-yellow 1s infinite;
            filter: drop-shadow(0 0 15px var(--tower-transition));
        }

        .tower-off {
            fill: var(--tower-off);
            opacity: 0.5;
        }

        .tower-error {
            fill: var(--tower-error);
            animation: flash-red 0.5s infinite;
            filter: drop-shadow(0 0 20px var(--tower-error));
        }

        @keyframes pulse-yellow {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.6
            }
        }

        @keyframes flash-red {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.3
            }
        }

        /* Decor */
        .building {
            fill: rgba(6, 182, 212, 0.1);
            transition: fill 0.3s;
        }

        .group-sector:hover .building {
            fill: rgba(6, 182, 212, 0.3);
        }

        /* Grid Background Pattern */
        .grid-line {
            stroke: rgba(6, 182, 212, 0.05);
            stroke-width: 0.5;
        }

        /* UI Animations */
        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen,
        #register-screen {
            background: radial-gradient(circle at 50% 50%, #020617 0%, #000000 100%);
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: opacity 0.5s ease-out, visibility 0.5s;
        }

        #login-screen.hidden-auth,
        #register-screen.hidden-auth {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            display: none;
            /* Ensure it doesn't block clicks when hidden */
        }

        .login-card {
            background: rgba(2, 6, 23, 0.9);
            border: 1px solid rgba(6, 182, 212, 0.3);
            box-shadow: 0 0 50px rgba(6, 182, 212, 0.2), inset 0 0 20px rgba(6, 182, 212, 0.1);
        }

        .input-field {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .input-field:focus {
            border-color: var(--city-base);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.3);
            outline: none;
        }
    </style>
</head>

<body>
    <div class="scanline"></div>

    <!-- PARALLAX VIEWPORT -->
    <div id="viewport">
        <svg id="map-svg" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid slice" width="100%" height="100%">
            <!-- Background Grid -->
            <defs>
                <pattern id="gridPattern" width="50" height="50" patternUnits="userSpaceOnUse">
                    <path d="M 50 0 L 0 0 0 50" fill="none" class="grid-line" />
                </pattern>
            </defs>
            <rect width="100%" height="100%" fill="url(#gridPattern)" />

            <!-- Map Layers -->
            <g id="layer-districts"></g>
            <g id="layer-connections"></g>
            <g id="layer-traffic"></g>
            <g id="layer-towers"></g>
            <g id="layer-labels"></g>

            <!-- Debris Layer (Floating particles) -->
            <g id="layer-debris"></g>
        </svg>
    </div>

    <!-- UI: HEADER -->
    <header class="fixed top-6 left-6 right-6 h-20 glass-panel rounded-2xl flex items-center justify-between px-8 z-50">
        <div class="flex items-center gap-5">
            <div class="relative w-4 h-4">
                <div class="absolute inset-0 bg-cyan-400 rounded-full animate-ping opacity-75"></div>
                <div class="relative w-4 h-4 bg-cyan-500 rounded-full shadow-[0_0_15px_#06b6d4]"></div>
            </div>
            <div>
                <h1 class="text-2xl font-black italic text-white tracking-widest drop-shadow-md">
                    SMART_CITY <span class="text-cyan-400 font-thin">OS</span>
                </h1>
                <p class="text-[9px] text-cyan-200/50 font-bold tracking-[0.4em] uppercase">Neural Network Control V4.1
                </p>
            </div>
        </div>
        <div class="flex gap-8 text-right">
            <div>
                <button id="header-logout-btn" onclick="handleSignOut()"
                    class="hidden text-[10px] bg-red-500/10 text-red-400 border border-red-500/20 px-3 py-1 rounded hover:bg-red-500/20 transition-all uppercase font-bold tracking-wider">
                    <i class="fas fa-power-off mr-1"></i> Disconnect
                </button>
            </div>
            <div>
                <p class="text-[9px] text-slate-500 uppercase tracking-widest">Network Load</p>
                <p id="net-load" class="text-xs font-mono text-cyan-300">45.2 TB/s</p>
            </div>
            <div class="border-r border-white/10 pr-6">
                <p class="text-[9px] text-slate-500 uppercase tracking-widest">System Status</p>
                <p class="text-xs font-black text-emerald-400 italic">OPTIMAL</p>
            </div>
        </div>
    </header>

    <!-- LOGIN OVERLAY -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center p-4">
        <div class="login-card p-10 rounded-3xl w-full max-w-md text-center relative overflow-hidden">
            <!-- Deco -->
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent">
            </div>
            <div
                class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-900 to-transparent">
            </div>

            <i class="fas fa-network-wired text-5xl text-cyan-500 mb-6 drop-shadow-[0_0_15px_rgba(6,182,212,0.5)]"></i>

            <h1 class="text-3xl font-black italic text-white tracking-widest mb-1">SMART_CITY <span
                    class="text-cyan-400 font-thin">OS</span></h1>
            <p class="text-[10px] text-cyan-200/50 font-bold tracking-[0.4em] uppercase mb-8">Secure Access Terminal</p>

            <form id="global-auth-form" class="space-y-4 text-left">
                <div>
                    <label
                        class="block text-[10px] text-cyan-300 uppercase tracking-widest font-bold mb-1 ml-1">Identity</label>
                    <input id="login-email" type="email" placeholder="OPERATOR ID (EMAIL)"
                        class="input-field w-full px-4 py-3 text-sm text-cyan-100 rounded-lg placeholder-slate-600 font-mono" />
                </div>
                <div>
                    <label class="block text-[10px] text-cyan-300 uppercase tracking-widest font-bold mb-1 ml-1">Access
                        Key</label>
                    <input id="login-pass" type="password" placeholder="••••••••••••"
                        class="input-field w-full px-4 py-3 text-sm text-cyan-100 rounded-lg placeholder-slate-600 font-mono" />
                </div>

                <div id="auth-error-msg"
                    class="text-red-400 text-xs font-mono text-center h-4 opacity-0 transition-opacity"></div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="handleSignIn()"
                        class="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-black rounded-lg shadow-lg shadow-cyan-900/30 transition-all uppercase text-xs tracking-widest">
                        Initialize
                    </button>
                    <button type="button" onclick="showRegisterScreen()"
                        class="flex-1 py-3 bg-transparent border border-white/10 hover:bg-white/5 text-slate-400 font-bold rounded-lg transition-all uppercase text-xs tracking-widest">
                        Create Account
                    </button>
                </div>

                <div class="relative py-4 my-2">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-white/10"></div>
                    </div>
                    <div
                        class="relative flex justify-center text-[10px] uppercase tracking-widest text-slate-500 bg-[#06101f] px-2 rounded">
                        Or Access With</div>
                </div>

                <button type="button" onclick="signInWithGoogle()"
                    class="w-full py-3 bg-white hover:bg-slate-200 text-slate-900 font-bold rounded-lg transition-all uppercase text-xs tracking-widest flex items-center justify-center gap-2">
                    <i class="fab fa-google text-red-500"></i> Google Identity
                </button>
            </form>
        </div>
    </div>

    <!-- REGISTER OVERLAY (Hidden by default) -->
    <div id="register-screen" class="fixed inset-0 flex items-center justify-center p-4 hidden-auth">
        <div class="login-card p-10 rounded-3xl w-full max-w-md text-center relative overflow-hidden">
            <!-- Deco -->
            <div
                class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-purple-500 to-transparent">
            </div>
            <div
                class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-purple-900 to-transparent">
            </div>

            <i class="fas fa-user-plus text-5xl text-purple-500 mb-6 drop-shadow-[0_0_15px_rgba(168,85,247,0.5)]"></i>

            <h1 class="text-3xl font-black italic text-white tracking-widest mb-1">NEW <span
                    class="text-purple-400 font-thin">OPERATOR</span></h1>
            <p class="text-[10px] text-purple-200/50 font-bold tracking-[0.4em] uppercase mb-8">System Access Request
            </p>

            <form id="global-reg-form" class="space-y-4 text-left">
                <div>
                    <label
                        class="block text-[10px] text-purple-300 uppercase tracking-widest font-bold mb-1 ml-1">Identity
                        (Email)</label>
                    <input id="reg-email" type="email" placeholder="NEW OPERATOR ID"
                        class="input-field w-full px-4 py-3 text-sm text-purple-100 rounded-lg placeholder-slate-600 font-mono focus:border-purple-500 focus:shadow-[0_0_15px_rgba(168,85,247,0.3)]" />
                </div>
                <div>
                    <label
                        class="block text-[10px] text-purple-300 uppercase tracking-widest font-bold mb-1 ml-1">Secure
                        Password</label>
                    <input id="reg-pass" type="password" placeholder="••••••••••••"
                        class="input-field w-full px-4 py-3 text-sm text-purple-100 rounded-lg placeholder-slate-600 font-mono focus:border-purple-500 focus:shadow-[0_0_15px_rgba(168,85,247,0.3)]" />
                </div>
                <div>
                    <label
                        class="block text-[10px] text-purple-300 uppercase tracking-widest font-bold mb-1 ml-1">Confirm
                        Password</label>
                    <input id="reg-pass-confirm" type="password" placeholder="••••••••••••"
                        class="input-field w-full px-4 py-3 text-sm text-purple-100 rounded-lg placeholder-slate-600 font-mono focus:border-purple-500 focus:shadow-[0_0_15px_rgba(168,85,247,0.3)]" />
                </div>

                <div id="reg-error-msg"
                    class="text-red-400 text-xs font-mono text-center h-4 opacity-0 transition-opacity"></div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="showLoginScreen()"
                        class="flex-1 py-3 bg-transparent border border-white/10 hover:bg-white/5 text-slate-400 font-bold rounded-lg transition-all uppercase text-xs tracking-widest">
                        Back to Login
                    </button>
                    <button type="button" onclick="handleSignUp()"
                        class="flex-1 py-3 bg-purple-600 hover:bg-purple-500 text-white font-black rounded-lg shadow-lg shadow-purple-900/30 transition-all uppercase text-xs tracking-widest">
                        Create Operator
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- UI: SIDEBAR -->
    <aside
        class="fixed top-32 left-6 bottom-6 w-80 glass-panel rounded-2xl p-6 flex flex-col gap-6 z-40 transition-transform duration-300">

        <!-- Mode Selector -->
        <div class="p-4 bg-white/5 rounded-xl border border-white/5">
            <p class="text-[9px] text-slate-500 uppercase tracking-widest font-black mb-2">Estrategia de Control</p>
            <div class="flex gap-2 mb-3">
                <button onclick="setMode('single')" id="btn-mode-single"
                    class="flex-1 py-2 text-[10px] font-bold uppercase rounded bg-cyan-500/20 text-cyan-400 border border-cyan-500/50 transition-all">Single</button>
                <button onclick="setMode('group')" id="btn-mode-group"
                    class="flex-1 py-2 text-[10px] font-bold uppercase rounded bg-transparent text-slate-500 border border-white/10 hover:bg-white/5 transition-all">Group</button>
                <button onclick="setMode('all')" id="btn-mode-all"
                    class="flex-1 py-2 text-[10px] font-bold uppercase rounded bg-transparent text-slate-500 border border-white/10 hover:bg-white/5 transition-all">All</button>
            </div>

            <button onclick="executeSequence()" id="btn-exec-main"
                class="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-black rounded-lg shadow-lg shadow-cyan-900/50 transition-all transform active:scale-95 uppercase text-[10px] tracking-widest hidden">
                <i class="fas fa-play mr-2"></i> EJECUTAR SECUENCIA
            </button>
        </div>

        <!-- Selected Sector Info -->
        <div id="sector-info" class="hidden animate-slide-in">
            <div class="relative overflow-hidden p-5 rounded-xl bg-slate-900/50 border border-cyan-900/50">
                <div class="absolute top-0 right-0 p-2 opacity-20"><i class="fas fa-server text-4xl text-cyan-500"></i>
                </div>
                <p class="text-[9px] text-cyan-500 font-black tracking-widest mb-1">DATA CENTER NODE</p>
                <h2 id="ui-name" class="text-xl font-black text-white italic tracking-wide mb-2">SERVER NAME</h2>
                <div id="ui-status-badge"
                    class="inline-flex items-center gap-2 px-3 py-1 rounded bg-black/40 border border-white/10 text-[10px] font-mono text-white">
                    <span class="w-2 h-2 rounded-full bg-gray-500"></span> OFFLINE
                </div>
            </div>

            <!-- Dashboard Actions (Connected to Logic) -->
            <div class="flex flex-col gap-2 mt-4">
                <p class="text-[9px] text-slate-600 uppercase tracking-widest font-black ml-1">Protocolos</p>
                <button onclick="sendAction('START')"
                    class="group relative w-full py-3 bg-emerald-500/5 hover:bg-emerald-500/10 text-emerald-500 font-bold text-[10px] uppercase tracking-widest border border-emerald-500/20 rounded-lg transition-all overflow-hidden">
                    <span
                        class="absolute inset-0 bg-emerald-500/10 translate-x-[-100%] group-hover:translate-x-0 transition-transform duration-300"></span>
                    <span class="relative flex items-center justify-center gap-2"><i class="fas fa-power-off"></i>
                        Iniciar Secuencia</span>
                </button>
                <button onclick="sendAction('STOP')"
                    class="group w-full py-3 bg-slate-500/5 hover:bg-slate-500/10 text-slate-400 font-bold text-[10px] uppercase tracking-widest border border-slate-500/20 rounded-lg transition-all">
                    <span class="flex items-center justify-center gap-2"><i class="fas fa-stop"></i> Detener
                        Núcleo</span>
                </button>
            </div>

            <!-- Metrics -->
            <div class="mt-4 space-y-2">
                <div class="flex justify-between text-[10px] font-mono text-cyan-300"><span>CPU</span><span
                        id="ui-cpu">0%</span></div>
                <div class="h-1 w-full bg-slate-800 rounded-full overflow-hidden">
                    <div id="ui-cpu-bar" class="h-full bg-cyan-400 transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-center opacity-30">
            <i class="fas fa-satellite-dish text-4xl mb-4 text-cyan-500"></i>
            <p class="text-[10px] font-black uppercase tracking-widest text-slate-400">Selecciona un Sector<br>del Mapa
            </p>
        </div>

        <!-- Terminal -->
        <div class="mt-auto">
            <div class="flex justify-between items-end mb-1 px-1">
                <h3 class="text-[9px] font-black text-slate-600 uppercase tracking-widest">System Log</h3>
                <span class="animate-pulse text-cyan-500 text-[10px]">●</span>
            </div>
            <div id="console-log"
                class="h-32 bg-black/60 rounded-xl border border-white/5 p-3 font-mono text-[9px] text-cyan-600/80 overflow-y-auto flex flex-col-reverse shadow-inner">
                <div>> Ready.</div>
            </div>
        </div>
    </aside>

    <script>
        // --- 1. DATA CONFIGURATION (DASHBOARD LOGIC) ---
        // Mapping Dashboard Sectors to Visual Styles of Ciudad4
        const SECTORS = [
            {
                id: "A", name: "Sector: Core", server: "W10",
                style: "sector-a", status: "stopped", cpu: 0,
                // Path borrowed/adapted from Ciudad4 (Financial Center-like)
                path: "M300,0 L1000,0 L1000,200 L500,300 L300,300 L250,150 Z"
            },
            {
                id: "B", name: "Sector: Ind", server: "UbuntuServer24",
                style: "sector-b", status: "stopped", cpu: 0,
                // Industrial Area
                path: "M0,0 L300,0 L250,150 L300,300 L0,300 Z"
            },
            {
                id: "C", name: "Sector: Res", server: "HABITAT_SYS",
                style: "sector-c", status: "online", cpu: 32,
                // Residential
                path: "M300,300 L500,300 L1000,200 L1000,450 L600,450 Z"
            },
            {
                id: "D", name: "Sector: Dark", server: "QUARANTINE",
                style: "sector-d", status: "stopped", cpu: 0,
                // Periphery/Dark
                path: "M0,300 L300,300 L600,450 L1000,450 L1000,600 L0,600 Z"
            },
            {
                id: "E", name: "Sector: Exp", server: "LAB_OMEGA",
                style: "sector-b", status: "online", cpu: 12,
                // Integrated Annex (Polygonal) - Fits better with Core/Res
                path: "M650,100 L850,120 L800,280 L600,220 Z"
            }
        ];

        let selectedSectorId = null;
        let currentMode = 'single';
        let selectedGroup = new Set();

        // --- 2. INITIALIZATION ---
        // --- 2. INITIALIZATION ---
        // Initialization handling merged at the bottom of the script


        // --- 3. RENDER ENGINE ---
        function renderMap() {
            const layerDistricts = document.getElementById('layer-districts');
            const layerTowers = document.getElementById('layer-towers');
            const layerLabels = document.getElementById('layer-labels');
            const layerConnections = document.getElementById('layer-connections');
            const layerDebris = document.getElementById('layer-debris');

            // Draw Connections First (Bottom Layer)
            drawConnections(layerConnections);

            SECTORS.forEach(sec => {
                const center = getPolyCenter(sec.path);
                sec.cx = center.x;
                sec.cy = center.y;

                // Group
                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("class", "group-sector");
                g.onclick = () => selectSector(sec.id);

                // District Path
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", sec.path);
                path.setAttribute("class", `district ${sec.style}`);
                path.setAttribute("id", `poly-${sec.id}`);
                g.appendChild(path);

                // Buildings / Debris
                drawDetails(g, sec);

                layerDistricts.appendChild(g);

                // Tower
                const gTower = document.createElementNS("http://www.w3.org/2000/svg", "g");
                gTower.setAttribute("id", `tower-grp-${sec.id}`);

                // Mast
                const mast = document.createElementNS("http://www.w3.org/2000/svg", "path");
                mast.setAttribute("d", `M${center.x},${center.y} L${center.x},${center.y - 35}`);
                mast.setAttribute("stroke", "rgba(6,182,212,0.5)");
                mast.setAttribute("stroke-width", "2");

                // Beacon based on status
                const beacon = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                beacon.setAttribute("cx", center.x);
                beacon.setAttribute("cy", center.y - 35);
                beacon.setAttribute("r", 5);
                beacon.setAttribute("id", `beacon-${sec.id}`);
                updateBeaconVisuals(beacon, sec.status);

                gTower.appendChild(mast);
                gTower.appendChild(beacon);
                layerTowers.appendChild(gTower);

                // Label
                drawLabel(layerLabels, sec);
            });

            // Extra Debris in the background
            for (let i = 0; i < 30; i++) {
                const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                dot.setAttribute("cx", Math.random() * 1000);
                dot.setAttribute("cy", Math.random() * 600);
                dot.setAttribute("r", Math.random() * 1.5);
                dot.setAttribute("fill", "rgba(6,182,212,0.3)");
                layerDebris.appendChild(dot);
            }
        }

        function drawDetails(g, sec) {
            // Generate random simple buildings inside the generic area of the sector
            const count = 15;
            for (let i = 0; i < count; i++) {
                const w = 5 + Math.random() * 20;
                const h = 5 + Math.random() * 30;
                const ox = (Math.random() - 0.5) * 100;
                const oy = (Math.random() - 0.5) * 80;

                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", sec.cx + ox);
                rect.setAttribute("y", sec.cy + oy);
                rect.setAttribute("width", w);
                rect.setAttribute("height", h);
                rect.setAttribute("class", "building");
                g.appendChild(rect);
            }
        }

        function drawLabel(layer, sec) {
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.style.pointerEvents = "none";

            const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
            txt.setAttribute("x", sec.cx);
            txt.setAttribute("y", sec.cy + 30);
            txt.setAttribute("text-anchor", "middle");
            txt.setAttribute("fill", "rgba(255,255,255,0.7)");
            txt.setAttribute("font-size", "10");
            txt.setAttribute("font-family", "monospace");
            txt.setAttribute("font-weight", "bold");
            txt.textContent = sec.id;

            g.appendChild(txt);
            layer.appendChild(g);
        }

        // --- GLOBAL CONNECTIONS DEFINITION ---
        const CONNECTIONS = [
            [0, 1], [1, 2], [2, 3], [0, 2], [1, 4], [0, 4],
            [1, 3], // New Connection: Factory (B) <-> Dark (D)
            [4, 2], // Exp (E) <-> Res (C)
            [4, 3]  // Exp (E) <-> Dark (D)
        ];

        function drawConnections(layer) {
            CONNECTIONS.forEach(pair => {
                const s1 = SECTORS[pair[0]];
                const s2 = SECTORS[pair[1]];
                if (!s1 || !s2) return;

                const p1 = getPolyCenter(s1.path);
                const p2 = getPolyCenter(s2.path);

                const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
                line.setAttribute("d", `M${p1.x},${p1.y} L${p2.x},${p2.y}`);
                line.setAttribute("class", "city-road");
                line.setAttribute("id", `road-${s1.id}-${s2.id}`);
                layer.appendChild(line);
            });
        }

        // --- 4. ADVANCED VISUALS: PARALLAX & TRAFFIC ---
        function initParallax() {
            const viewport = document.getElementById('viewport');

            document.addEventListener('mousemove', (e) => {
                const x = (window.innerWidth / 2 - e.clientX) / 40;
                const y = (window.innerHeight / 2 - e.clientY) / 40;
                viewport.style.transform = `scale(1.05) translate(${x}px, ${y}px) rotateX(${y / 2}deg) rotateY(${-x / 2}deg)`;
            });
        }

        function initTrafficSystem() {
            updateTraffic();
            // Re-check less frequently, main loop handles animation
            setInterval(updateTraffic, 4000);
        }

        function updateTraffic() {
            const layerTraffic = document.getElementById('layer-traffic');

            CONNECTIONS.forEach(pair => {
                const s1 = SECTORS[pair[0]];
                const s2 = SECTORS[pair[1]];
                const roadId = `road-${s1.id}-${s2.id}`;

                // Traffic only if BOTH ends are ONLINE
                const shouldHaveTraffic = (s1.status === 'online' && s2.status === 'online');

                if (shouldHaveTraffic) {
                    // Only spawn if not already there
                    if (document.querySelectorAll(`.${roadId}-vehicle`).length === 0) {
                        spawnVehiclesOnRoad(roadId, layerTraffic);
                    }
                } else {
                    // Clear if link is broken
                    document.querySelectorAll(`.${roadId}-vehicle`).forEach(el => el.remove());
                }
            });
        }

        function spawnVehiclesOnRoad(roadId, layer) {
            // 3 Vehicles per road, infinite loop, staggered
            for (let k = 0; k < 3; k++) {
                const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
                group.setAttribute("class", `${roadId}-vehicle`);

                const car = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                car.setAttribute("r", 2);
                car.setAttribute("class", "data-packet");

                const speed = 2 + Math.random();
                const delay = k * (speed / 2.5);

                const anim = document.createElementNS("http://www.w3.org/2000/svg", "animateMotion");
                anim.setAttribute("dur", `${speed}s`);
                anim.setAttribute("repeatCount", "indefinite");
                anim.setAttribute("begin", `-${delay}s`); // Negative begin for instant start

                const mpath = document.createElementNS("http://www.w3.org/2000/svg", "mpath");
                mpath.setAttributeNS("http://www.w3.org/1999/xlink", "xlink:href", `#${roadId}`);

                anim.appendChild(mpath);
                car.appendChild(anim);
                group.appendChild(car);
                layer.appendChild(group);
            }
        }

        // --- 5. UI LOGIC (DASHBOARD) ---
        function setMode(mode) {
            currentMode = mode;
            selectedGroup.clear();
            selectedSectorId = null;

            // Toggle Buttons
            ['single', 'group', 'all'].forEach(m => {
                const btn = document.getElementById(`btn-mode-${m}`);
                if (btn) btn.className = (m === mode) ?
                    "flex-1 py-2 text-[10px] font-bold uppercase rounded bg-cyan-500/20 text-cyan-400 border border-cyan-500/50 transition-all" :
                    "flex-1 py-2 text-[10px] font-bold uppercase rounded bg-transparent text-slate-500 border border-white/10 hover:bg-white/5 transition-all";
            });

            // Toggle Execute Button
            const execBtn = document.getElementById('btn-exec-main');
            if (mode === 'group' || mode === 'all') execBtn.classList.remove('hidden');
            else execBtn.classList.add('hidden');

            // Reset View
            document.querySelectorAll('.district').forEach(d => d.classList.remove('selected'));
            document.getElementById('sector-info').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
        }

        async function executeSequence() {
            let targets = [];
            if (currentMode === 'all') targets = SECTORS.map(s => s.id);
            else if (currentMode === 'group') targets = Array.from(selectedGroup);

            if (targets.length === 0) return;

            for (const id of targets) {
                const sec = SECTORS.find(s => s.id === id);
                if (sec.status !== 'online') {
                    // Simulate auto-start
                    sec.status = 'transition';
                    refreshVisuals(sec);
                    await new Promise(r => setTimeout(r, 200));
                    sec.status = 'online';
                    sec.cpu = 20 + Math.floor(Math.random() * 60);
                    refreshVisuals(sec);
                }
            }
        }
        function selectSector(id) {
            if (currentMode === 'all') return;

            const poly = document.getElementById(`poly-${id}`);

            if (currentMode === 'single') {
                selectedSectorId = id;
                document.querySelectorAll('.district').forEach(d => d.classList.remove('selected'));
                poly.classList.add('selected');
                showSectorDetails(id);
            }
            else if (currentMode === 'group') {
                if (selectedGroup.has(id)) {
                    selectedGroup.delete(id);
                    poly.classList.remove('selected');
                } else {
                    selectedGroup.add(id);
                    poly.classList.add('selected');
                }

                // Show details of the last toggled sector, or hide if empty
                if (selectedGroup.size > 0 || selectedGroup.has(id)) showSectorDetails(id);
                else {
                    document.getElementById('sector-info').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                }
            }
        }

        function showSectorDetails(id) {
            const sec = SECTORS.find(s => s.id === id);

            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('sector-info').classList.remove('hidden');

            document.getElementById('ui-name').innerText = sec.server;
            document.getElementById('ui-cpu').innerText = sec.cpu + '%';
            document.getElementById('ui-cpu-bar').style.width = sec.cpu + '%';

            updateStatusBadge(sec);
            log(`Accessing Node: ${sec.server}...`);
        }


        function updateStatusBadge(sec) {
            const badge = document.getElementById('ui-status-badge');
            let colorClass = 'bg-gray-500';
            let label = 'UNKNOWN';
            let textClass = 'text-white';

            if (sec.status === 'online') { colorClass = 'bg-green-500'; label = 'ONLINE'; textClass = 'text-green-400'; }
            else if (sec.status === 'transition') { colorClass = 'bg-yellow-500 animate-pulse'; label = 'WORKING...'; textClass = 'text-yellow-400'; }
            else if (sec.status === 'error') { colorClass = 'bg-red-500'; label = 'CRITICAL'; textClass = 'text-red-400'; }
            else { label = 'OFFLINE'; textClass = 'text-slate-400'; }

            badge.innerHTML = `<span class="w-2 h-2 rounded-full ${colorClass} mr-2"></span> ${label}`;
            badge.className = `inline-flex items-center px-3 py-1 rounded bg-black/40 border border-white/10 text-[10px] font-mono ${textClass}`;
        }

        async function sendAction(action) {
            if (!selectedSectorId) return;
            const sec = SECTORS.find(s => s.id === selectedSectorId);
            const vmName = sec.server; // "W10" or "UbuntuServer24"

            if (action === 'START') {
                if (sec.status === 'online') { log("Already Online."); return; }

                sec.status = 'transition';
                refreshVisuals(sec);
                log(`Initializing VM: ${vmName}...`);

                // Backend Call
                try {
                    const res = await fetchStartVM(vmName);
                    if (res.ok) {
                        sec.status = 'online';
                        sec.cpu = 20 + Math.floor(Math.random() * 60);
                        log(`${vmName} STARTED successfully.`);
                    } else {
                        throw new Error('Backend Error');
                    }
                } catch (e) {
                    sec.status = 'error';
                    log(`Error starting ${vmName}: ${e.message}`);
                }

            } else if (action === 'STOP') {
                if (sec.status === 'stopped') { log("Already Stopped."); return; }

                sec.status = 'transition';
                refreshVisuals(sec);
                log(`Stopping VM: ${vmName}...`);

                // Backend Call
                try {
                    const res = await fetchStopVM(vmName);
                    if (res.ok) {
                        sec.status = 'stopped';
                        sec.cpu = 0;
                        log(`${vmName} STOPPED successfully.`);
                    } else {
                        throw new Error('Backend Error');
                    }
                } catch (e) {
                    sec.status = 'error';
                    log(`Error stopping ${vmName}: ${e.message}`);
                }
            }

            refreshVisuals(sec);
        }

        function refreshVisuals(sec) {
            // Update Tower Beacon
            const beacon = document.getElementById(`beacon-${sec.id}`);
            updateBeaconVisuals(beacon, sec.status);

            // Update UI if selected
            if (selectedSectorId === sec.id) {
                updateStatusBadge(sec);
                document.getElementById('ui-cpu').innerText = sec.cpu + '%';
                document.getElementById('ui-cpu-bar').style.width = sec.cpu + '%';
            }

            // Update traffic in case a node went offline/online
            updateTraffic();
        }



        function updateBeaconVisuals(el, status) {
            el.setAttribute("class", `tower-beacon tower-${status}`);
        }

        // --- UTILS ---
        function getPolyCenter(path) {
            // Simple regex for M x,y and L x,y
            const nums = path.replace(/[a-zA-Z]/g, '').split(/[\s,]+/).filter(x => x).map(Number);
            let x = 0, y = 0, c = 0;
            for (let i = 0; i < nums.length; i += 2) { x += nums[i]; y += nums[i + 1]; c++; }
            return { x: x / c, y: y / c };
        }

        function log(msg) {
            const c = document.getElementById('console-log');
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            c.prepend(d);
            if (c.childNodes.length > 20) c.lastChild.remove();
        }



        // --- VIRTUALBOX API ---
        const API_BASE = 'http://localhost:3001/api/vms';

        async function fetchVMs() {
            try {
                const res = await fetch(API_BASE);
                const vms = await res.json();
                // vms = ["W10", "UbuntuServer24"]
                log(`Detected VMs: ${vms.join(', ')}`);
                // Optional: Update status if backend provided status (currently just list)
            } catch (e) {
                log("Backend Offline (VirtualBox Control Unavailable)");
            }
        }

        async function fetchStartVM(name) {
            return fetch(`${API_BASE}/${name}/start`, { method: 'POST' });
        }

        async function fetchStopVM(name) {
            return fetch(`${API_BASE}/${name}/stop`, { method: 'POST' });
        }


        // --- AUTH & VALIDATION LOGIC ---
        function toggleLoginScreen(show) {
            const loginScreen = document.getElementById('login-screen');
            const regScreen = document.getElementById('register-screen');
            const logoutBtn = document.getElementById('header-logout-btn');

            if (show) {
                // Show Login by default when "Showing Auth"
                loginScreen.classList.remove('hidden-auth');
                loginScreen.style.display = 'flex';
                regScreen.classList.add('hidden-auth');
                regScreen.style.display = 'none';

                logoutBtn.classList.add('hidden');
                document.getElementById('viewport').style.filter = 'blur(10px) grayscale(80%)';
            } else {
                loginScreen.classList.add('hidden-auth');
                regScreen.classList.add('hidden-auth');
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                    regScreen.style.display = 'none';
                }, 500);

                logoutBtn.classList.remove('hidden');
                document.getElementById('viewport').style.filter = 'none';
            }
        }

        function showRegisterScreen() {
            document.getElementById('login-screen').classList.add('hidden-auth');
            setTimeout(() => document.getElementById('login-screen').style.display = 'none', 500);

            const reg = document.getElementById('register-screen');
            reg.style.display = 'flex';
            setTimeout(() => reg.classList.remove('hidden-auth'), 50);
        }

        function showLoginScreen() {
            document.getElementById('register-screen').classList.add('hidden-auth');
            setTimeout(() => document.getElementById('register-screen').style.display = 'none', 500);

            const login = document.getElementById('login-screen');
            login.style.display = 'flex';
            setTimeout(() => login.classList.remove('hidden-auth'), 50);
        }

        function showAuthError(msg, isSuccess = false, context = 'login') {
            const id = context === 'register' ? 'reg-error-msg' : 'auth-error-msg';
            const el = document.getElementById(id);
            if (!el) return;

            el.innerText = `> ${isSuccess ? 'SUCCESS' : 'ERROR'}: ${msg}`;

            if (isSuccess) {
                el.classList.remove('text-red-400');
                el.classList.add('text-emerald-400');
            } else {
                el.classList.remove('text-emerald-400');
                el.classList.add('text-red-400');
            }

            el.classList.remove('opacity-0');
            setTimeout(() => el.classList.add('opacity-0'), isSuccess ? 6000 : 3000);
        }


        async function handleSignUp() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;
            const confirmPass = document.getElementById('reg-pass-confirm').value;

            if (!email || !password || !confirmPass) { showAuthError("MISSING CREDENTIALS", false, 'register'); return; }
            if (password !== confirmPass) { showAuthError("PASSWORDS DO NOT MATCH", false, 'register'); return; }
            if (password.length < 6) { showAuthError("PASSWORD TOO SHORT (MIN 6)", false, 'register'); return; }

            const { data, error } = await supabaseClient.auth.signUp({ email, password });

            if (error) {
                showAuthError(error.message, false, 'register');
            } else {
                if (data.user && !data.session) {
                    showAuthError("CHECK EMAIL TO CONFIRM REGISTRATION", true, 'register');
                    log(`Registration pending for ${email}`);
                } else if (data.session) {
                    showAuthError("REGISTRATION COMPLETE. LOGGING IN...", true, 'register');
                    log(`Registration successful for ${email}`);
                    // Auth state change will handle screen closing
                }
            }
        }

        async function handleSignIn() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;

            if (!email || !password) { showAuthError("MISSING CREDENTIALS"); return; }

            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email, password
            });

            if (error) {
                showAuthError(error.message);
                log(`Auth Failed: ${error.message}`);
            } else {
                log(`Session Established: ${email}`);
                // State change handled by onAuthStateChange listener
            }
        }

        async function signInWithGoogle() {
            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        queryParams: {
                            access_type: 'offline',
                            prompt: 'consent',
                        },
                    },
                });

                if (error) throw error;
                log("Redirecting to Google Identity Services...");
            } catch (error) {
                showAuthError(error.message);
                log(`Google Auth Error: ${error.message}`);
            }
        }

        async function handleSignOut() {
            await supabaseClient.auth.signOut();
            log('Session Terminated.');
            // Toggle handled by listener
        }

        supabaseClient.auth.onAuthStateChange((_event, session) => {
            if (session?.user) {
                toggleLoginScreen(false);
                log(`Operator Connected: ${session.user.email}`);
            } else {
                toggleLoginScreen(true);
            }
        });

        // --- INITIALIZATION ---
        window.onload = () => {
            // Check initial session
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    toggleLoginScreen(false);
                    log(`Restored Session: ${session.user.email}`);
                } else {
                    toggleLoginScreen(true); // Force login
                }
            });

            setMode('single');
            renderMap();
            initParallax();
            initTrafficSystem();
            fetchVMs(); // Initialize VM list

            log("System initialized securely.");
            log("Waiting for operator authentication...");
        };








    </script>
</body>

</html>