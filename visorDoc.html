<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuVisor - Drag & Drop + Excel Support</title>
    
    <!-- Tailwind CSS con plugin Typography activado -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Marked.js (Markdown) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- PDF.js (Librería de renderizado PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <!-- SheetJS (Librería para Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #the-canvas { direction: ltr; }

        /* Estilos Syntax Highlighting JSON */
        .json-key { color: #e11d48; font-weight: 600; }
        .json-string { color: #15803d; }
        .json-number { color: #2563eb; }
        .json-boolean { color: #7c3aed; font-weight: bold; }
        .json-null { color: #9ca3af; font-style: italic; }

        /* Estilo para el Overlay de Drag & Drop */
        #dropOverlay {
            backdrop-filter: blur(4px);
            background-color: rgba(79, 70, 229, 0.1);
        }

        /* Estilos para Tablas Excel generadas */
        .excel-table-wrapper table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        .excel-table-wrapper th { background-color: #f3f4f6; font-weight: 600; text-align: left; padding: 0.75rem; border: 1px solid #e5e7eb; }
        .excel-table-wrapper td { padding: 0.75rem; border: 1px solid #e5e7eb; color: #374151; }
        .excel-table-wrapper tr:nth-child(even) { background-color: #f9fafb; }
        .excel-table-wrapper tr:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 h-screen flex overflow-hidden relative">

    <!-- INPUT OCULTO: Acepta .txt, .md, .pdf, .json y EXCEL -->
    <input type="file" id="fileInput" accept=".txt,.md,.markdown,.pdf,.json,.xlsx,.xls,.csv" class="hidden">

    <!-- OVERLAY DRAG & DROP -->
    <div id="dropOverlay" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center border-4 border-indigo-500 border-dashed m-4 rounded-xl bg-white/90 transition-all pointer-events-none">
        <div class="bg-indigo-100 p-6 rounded-full mb-4 animate-bounce">
            <i data-lucide="upload-cloud" class="w-16 h-16 text-indigo-600"></i>
        </div>
        <h2 class="text-3xl font-bold text-indigo-700">Suelta el archivo aquí</h2>
        <p class="text-gray-500 mt-2">Soporta Excel, PDF, JSON, Markdown y Texto</p>
    </div>

    <!-- 1. SIDEBAR -->
    <aside id="sidebar" class="w-80 bg-white border-r border-gray-200 flex flex-col h-full fixed md:relative z-20 transition-all duration-300 transform md:translate-x-0 -translate-x-full shadow-lg md:shadow-none">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between shrink-0">
            <div class="flex items-center gap-2 text-indigo-600 font-bold text-lg">
                <i data-lucide="layers"></i>
                <span>DocuVisor Pro</span>
            </div>
            <button id="closeSidebarBtn" class="md:hidden text-gray-500 hover:text-gray-700">
                <i data-lucide="x"></i>
            </button>
        </div>

        <div class="p-4 shrink-0 space-y-3">
            <button id="createDocBtn" class="w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg transition-colors font-medium shadow-sm">
                <i data-lucide="plus" class="w-4 h-4"></i>
                Nuevo Documento
            </button>
            
            <button id="importDocBtn" class="w-full flex items-center justify-center gap-2 bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 py-2 px-4 rounded-lg transition-colors font-medium text-sm">
                <i data-lucide="upload" class="w-4 h-4"></i>
                Importar Archivo
            </button>
            
            <div class="relative pt-2">
                <i data-lucide="search" class="absolute left-3 top-4 text-gray-400 w-4 h-4"></i>
                <input type="text" id="searchInput" placeholder="Buscar..." class="w-full pl-10 pr-4 py-2 bg-gray-100 border-transparent focus:bg-white focus:border-indigo-500 border rounded-lg text-sm outline-none transition-all">
            </div>
        </div>

        <div id="docList" class="flex-1 overflow-y-auto px-2 pb-4 space-y-1"></div>
    </aside>

    <!-- 2. MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative w-full overflow-hidden">
        
        <div class="absolute top-4 left-4 z-10 md:hidden">
            <button id="openSidebarBtn" class="p-2 bg-white shadow-md rounded-md border text-gray-600">
                <i data-lucide="menu"></i>
            </button>
        </div>

        <!-- ESTADO VACÍO / DROP ZONE -->
        <div id="emptyState" class="hidden flex-1 flex flex-col items-center justify-center text-gray-400 p-8">
            <div class="border-2 border-dashed border-gray-300 rounded-2xl p-12 flex flex-col items-center justify-center hover:bg-gray-50 hover:border-indigo-300 transition-all cursor-default w-full max-w-lg">
                <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-indigo-100">
                    <i data-lucide="file-up" class="w-10 h-10 text-gray-400"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">Arrastra y suelta tu archivo</h3>
                <p class="text-sm text-gray-500 text-center mb-6">Soporta Excel, PDF, JSON, MD, TXT</p>
                <button onclick="document.getElementById('fileInput').click()" class="text-indigo-600 font-medium hover:underline cursor-pointer">
                    O haz clic para buscar
                </button>
            </div>
        </div>

        <div id="contentArea" class="hidden flex-col h-full">
            <!-- Header -->
            <header class="h-16 border-b border-gray-200 bg-white flex items-center justify-between px-6 shrink-0 z-10">
                <div class="flex items-center gap-2 text-sm text-gray-500 ml-10 md:ml-0">
                    <span class="hidden md:inline">Docs</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 hidden md:inline"></i>
                    <span id="headerTitle" class="font-medium text-gray-800 truncate max-w-[150px] md:max-w-md">Titulo</span>
                </div>

                <div class="flex items-center gap-2">
                    <div id="viewActions" class="flex gap-2">
                        <button id="downloadBtn" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-md font-medium transition-all" title="Descargar">
                            <i data-lucide="download" class="w-4 h-4"></i> <span class="hidden sm:inline">Exportar</span>
                        </button>

                        <button id="editBtn" class="flex items-center gap-2 px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 border border-gray-200 hover:border-gray-300 rounded-md font-medium transition-all">
                            <i data-lucide="edit-3" class="w-4 h-4"></i> <span class="hidden sm:inline">Editar</span>
                        </button>
                        <button id="deleteBtn" class="flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 border border-transparent hover:border-red-100 rounded-md font-medium transition-all" title="Eliminar">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div id="editActions" class="hidden flex gap-2">
                        <button id="cancelBtn" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md font-medium">Cancelar</button>
                        <button id="saveBtn" class="flex items-center gap-2 px-4 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700 rounded-md font-medium shadow-sm">
                            <i data-lucide="save" class="w-4 h-4"></i> Guardar
                        </button>
                    </div>
                </div>
            </header>

            <!-- Contenido Scrollable -->
            <div class="flex-1 overflow-y-auto bg-gray-50/50 p-6 md:p-8 relative" id="mainScroll">
                <div class="max-w-5xl mx-auto h-full flex flex-col">
                    
                    <!-- MODO VISUALIZACIÓN -->
                    <article id="viewMode" class="fade-in flex-1 flex flex-col">
                        <div class="mb-6 flex items-start justify-between">
                            <div>
                                <span id="viewCategory" class="inline-block px-2 py-1 bg-indigo-50 text-indigo-700 text-xs font-semibold rounded-md mb-2">Categoría</span>
                                <h1 id="viewTitle" class="text-3xl md:text-4xl font-bold text-gray-900 tracking-tight">Título</h1>
                                <p id="viewDate" class="text-gray-400 text-sm mt-1">Fecha</p>
                            </div>
                        </div>

                        <!-- 1. CONTENEDOR TEXTO/MARKDOWN -->
                        <div id="markdownContainer" class="hidden bg-white p-8 rounded-xl shadow-sm border border-gray-100 min-h-[200px]">
                            <div id="viewBody" class="prose prose-indigo max-w-none text-gray-700 leading-relaxed prose-headings:font-bold prose-h1:text-gray-900 prose-a:text-indigo-600"></div>
                        </div>

                        <!-- 2. CONTENEDOR PDF -->
                        <div id="pdfContainer" class="hidden flex-col items-center w-full bg-gray-200/50 rounded-xl border border-gray-200 p-4 shadow-inner min-h-[500px]">
                            <div class="flex flex-wrap items-center justify-center gap-3 bg-white p-2 rounded-lg shadow-sm mb-4 sticky top-0 z-10 border border-gray-200 w-full max-w-2xl">
                                <button id="prevPage" class="p-2 hover:bg-gray-100 rounded text-gray-600 disabled:opacity-50"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                                <span class="text-sm font-medium text-gray-700 min-w-[100px] text-center">Pág <span id="pageNum">1</span> / <span id="pageCount">--</span></span>
                                <button id="nextPage" class="p-2 hover:bg-gray-100 rounded text-gray-600 disabled:opacity-50"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                                <div class="w-px h-6 bg-gray-300 mx-2"></div>
                                <button id="zoomOut" class="p-2 hover:bg-gray-100 rounded text-gray-600"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                <span id="zoomLevel" class="text-sm text-gray-500 w-12 text-center">100%</span>
                                <button id="zoomIn" class="p-2 hover:bg-gray-100 rounded text-gray-600"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            </div>
                            <div class="overflow-auto w-full flex justify-center pb-10">
                                <canvas id="the-canvas" class="shadow-lg border border-gray-300 bg-white"></canvas>
                            </div>
                        </div>

                        <!-- 3. CONTENEDOR JSON -->
                        <div id="jsonContainer" class="hidden bg-[#1e1e1e] p-6 rounded-xl shadow-lg border border-gray-700 text-gray-100 font-mono text-sm overflow-x-auto min-h-[200px]">
                            <pre id="jsonContent" class="leading-relaxed"></pre>
                        </div>

                        <!-- 4. CONTENEDOR EXCEL (NUEVO) -->
                        <div id="excelContainer" class="hidden bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden min-h-[200px]">
                            <div class="p-4 bg-green-50 border-b border-green-100 flex items-center justify-between">
                                <span class="text-sm font-semibold text-green-800 flex items-center gap-2">
                                    <i data-lucide="table" class="w-4 h-4"></i> Hoja de Cálculo
                                </span>
                            </div>
                            <div id="excelContent" class="excel-table-wrapper overflow-x-auto">
                                <!-- La tabla se inyectará aquí -->
                            </div>
                        </div>
                    </article>

                    <!-- MODO EDICIÓN -->
                    <div id="editMode" class="hidden h-full flex flex-col fade-in bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                        <div class="mb-6 space-y-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Título</label>
                                <input type="text" id="editTitleInput" class="w-full text-2xl font-bold text-gray-900 border-b-2 border-gray-200 focus:border-indigo-500 outline-none py-2 bg-transparent">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">Categoría</label>
                                <input type="text" id="editCategoryInput" class="w-full text-sm text-gray-700 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-indigo-100 outline-none">
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col">
                            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Contenido</label>
                            <textarea id="editContentInput" class="flex-1 w-full p-4 text-base font-mono bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-100 outline-none resize-none leading-relaxed font-ligatures-none"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. CONFIGURACIÓN ---
        marked.use({ breaks: true, gfm: true });

        const state = {
            docs: [],
            selectedId: null,
            isEditing: false,
            searchQuery: '',
            pdf: { doc: null, pageNum: 1, pageRendering: false, pageNumPending: null, scale: 1.2, canvas: null, ctx: null }
        };

        const INITIAL_DOCS = [
            {
                id: '1',
                title: 'Nota de Texto',
                category: 'Notas',
                type: 'text',
                content: `Esto es un archivo de texto simple (.txt).\n\nAhora puedes arrastrar archivos Excel, PDF, JSON o Texto directamente.`,
                lastModified: new Date().toISOString()
            }
        ];

        // --- 2. UTILIDADES ---
        function syntaxHighlight(json) {
            if (typeof json !== 'string') json = JSON.stringify(json, undefined, 2);
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) cls = 'json-key';
                    else cls = 'json-string';
                } else if (/true|false/.test(match)) cls = 'json-boolean';
                else if (/null/.test(match)) cls = 'json-null';
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // --- 3. LÓGICA DE DATOS ---

        function initApp() {
            try {
                const saved = localStorage.getItem('docuvisor-ultra');
                state.docs = saved ? JSON.parse(saved) : INITIAL_DOCS;
            } catch (e) {
                state.docs = INITIAL_DOCS;
            }

            state.pdf.canvas = document.getElementById('the-canvas');
            state.pdf.ctx = state.pdf.canvas.getContext('2d');

            if (state.docs.length > 0) selectDoc(state.docs[0].id);
            else renderSidebar();
            updateUI();
        }

        function saveToStorage() {
            try {
                localStorage.setItem('docuvisor-ultra', JSON.stringify(state.docs));
            } catch (e) {
                if (e.name === 'QuotaExceededError') alert('⚠️ Memoria llena. No se guardará permanentemente.');
            }
        }

        function downloadDoc() {
            if (!state.selectedId) return;
            const doc = state.docs.find(d => d.id === state.selectedId);
            if (!doc) return;

            // EXCEL y PDF (Base64)
            if (doc.type === 'pdf' || doc.type === 'excel') {
                const link = document.createElement('a');
                link.href = doc.content; // Es Data URL
                link.download = `${doc.title}.${doc.type === 'pdf' ? 'pdf' : 'xlsx'}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                return;
            }

            let mimeType = 'text/plain';
            let extension = 'txt';

            if (doc.type === 'json') { mimeType = 'application/json'; extension = 'json'; }
            else if (doc.type === 'markdown') { mimeType = 'text/markdown'; extension = 'md'; }

            const blob = new Blob([doc.content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${doc.title}.${extension}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- MANEJO DE ARCHIVOS (Unified File Processing) ---
        
        function processFile(file) {
            if (!file) return;

            const reader = new FileReader();
            const extension = file.name.split('.').pop().toLowerCase();
            const isPdf = file.type === 'application/pdf' || extension === 'pdf';
            const isJson = file.type === 'application/json' || extension === 'json';
            const isMd = ['md', 'markdown'].includes(extension);
            const isExcel = ['xlsx', 'xls', 'csv'].includes(extension);

            // Manejo especial para lectura binaria (PDF y Excel)
            if (isPdf || isExcel) {
                reader.readAsDataURL(file); // Leer como Base64 para almacenar
            } else {
                reader.readAsText(file); // Texto plano
            }

            reader.onload = function(e) {
                let content = e.target.result;
                const fileName = file.name.replace(/\.[^/.]+$/, "");
                let docType = 'text';
                
                if (isJson) {
                    try {
                        content = JSON.stringify(JSON.parse(content), null, 2);
                        docType = 'json';
                    } catch (err) {
                        alert('JSON inválido, se guardará como texto plano.');
                        docType = 'text';
                    }
                } else if (isPdf) {
                    docType = 'pdf';
                } else if (isExcel) {
                    docType = 'excel';
                    // El contenido aquí ya es Base64 (DataURL) listo para guardar
                } else if (isMd) {
                    docType = 'markdown';
                }

                const newDoc = {
                    id: crypto.randomUUID(),
                    title: fileName.charAt(0).toUpperCase() + fileName.slice(1),
                    category: 'Importado',
                    type: docType,
                    content: content,
                    lastModified: new Date().toISOString()
                };

                state.docs.unshift(newDoc);
                saveToStorage();
                selectDoc(newDoc.id);
                renderSidebar();
            };
        }

        function handleFileUpload(event) {
            processFile(event.target.files[0]);
            event.target.value = ''; // Reset input
        }

        // --- 4. DRAG AND DROP EVENTS ---
        
        const dropOverlay = document.getElementById('dropOverlay');
        let dragCounter = 0;

        function initDragAndDrop() {
            document.body.addEventListener('dragenter', (e) => {
                e.preventDefault();
                dragCounter++;
                if (dragCounter === 1) dropOverlay.classList.remove('hidden');
            });

            document.body.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dragCounter--;
                if (dragCounter <= 0) {
                    dragCounter = 0;
                    dropOverlay.classList.add('hidden');
                }
            });

            document.body.addEventListener('dragover', (e) => {
                e.preventDefault(); 
            });

            document.body.addEventListener('drop', (e) => {
                e.preventDefault();
                dragCounter = 0;
                dropOverlay.classList.add('hidden');
                
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    processFile(e.dataTransfer.files[0]);
                }
            });
        }

        // --- 5. RENDERIZADO PDF Y EXCEL ---
        function renderPdfPage(num) {
            state.pdf.pageRendering = true;
            state.pdf.doc.getPage(num).then(function(page) {
                const viewport = page.getViewport({scale: state.pdf.scale});
                state.pdf.canvas.height = viewport.height;
                state.pdf.canvas.width = viewport.width;
                const renderContext = { canvasContext: state.pdf.ctx, viewport: viewport };
                page.render(renderContext).promise.then(() => {
                    state.pdf.pageRendering = false;
                    if (state.pdf.pageNumPending !== null) {
                        renderPdfPage(state.pdf.pageNumPending);
                        state.pdf.pageNumPending = null;
                    }
                });
            });
            document.getElementById('pageNum').textContent = num;
        }

        function queueRenderPage(num) { state.pdf.pageRendering ? state.pdf.pageNumPending = num : renderPdfPage(num); }
        function onPrevPage() { if (state.pdf.pageNum <= 1) return; state.pdf.pageNum--; queueRenderPage(state.pdf.pageNum); }
        function onNextPage() { if (state.pdf.pageNum >= state.pdf.doc.numPages) return; state.pdf.pageNum++; queueRenderPage(state.pdf.pageNum); }
        function onZoom(delta) { 
            const newScale = state.pdf.scale + delta; 
            if (newScale > 0.5 && newScale < 3.0) { state.pdf.scale = newScale; document.getElementById('zoomLevel').textContent = Math.round(state.pdf.scale * 100) + '%'; queueRenderPage(state.pdf.pageNum); } 
        }

        function loadPdfFromData(base64Data) {
            pdfjsLib.getDocument(base64Data).promise.then(function(pdfDoc_) {
                state.pdf.doc = pdfDoc_;
                document.getElementById('pageCount').textContent = state.pdf.doc.numPages;
                state.pdf.pageNum = 1;
                renderPdfPage(1);
            }, function (reason) { console.error(reason); alert('Error PDF'); });
        }

        // Nueva función para renderizar Excel
        function loadExcelFromData(base64Data) {
            try {
                // SheetJS lee directamente desde el string base64 (quitando la cabecera data:...)
                // A veces FileReader devuelve "data:application/vnd...;base64,....."
                const cleanBase64 = base64Data.split(',')[1]; 
                const workbook = XLSX.read(cleanBase64, {type: 'base64'});
                
                // Tomamos la primera hoja
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convertimos a HTML
                const html = XLSX.utils.sheet_to_html(worksheet, { id: "excelTable", editable: false });
                
                document.getElementById('excelContent').innerHTML = html;
                
                // Añadimos estilos de Tailwind a la tabla generada (SheetJS no pone estilos)
                // Esto se hace por CSS global, pero podemos retocar si hace falta
            } catch (e) {
                console.error(e);
                document.getElementById('excelContent').innerHTML = `<p class="text-red-500 p-4">Error al leer el archivo Excel.</p>`;
            }
        }

        // --- 6. GESTIÓN UI ---
        function selectDoc(id) {
            state.selectedId = id;
            state.isEditing = false;
            updateUI();
            if (window.innerWidth < 768) toggleSidebar(false);
        }

        function createDoc() {
            const newDoc = { id: crypto.randomUUID(), title: 'Nota Rápida', category: 'Borrador', type: 'text', content: 'Escribe aquí tu nota...', lastModified: new Date().toISOString() };
            state.docs.unshift(newDoc);
            saveToStorage();
            selectDoc(newDoc.id);
            startEditing();
            renderSidebar();
        }

        function deleteDoc() {
            if (!confirm('¿Eliminar documento?')) return;
            state.docs = state.docs.filter(d => d.id !== state.selectedId);
            saveToStorage();
            state.docs.length > 0 ? selectDoc(state.docs[0].id) : (state.selectedId = null);
            renderSidebar();
            updateUI();
        }

        function startEditing() { 
            const doc = state.docs.find(d => d.id === state.selectedId);
            if (doc && (doc.type === 'pdf' || doc.type === 'excel')) { alert("No se pueden editar archivos binarios (PDF/Excel)."); return; }
            state.isEditing = true; 
            updateUI(); 
        }
        
        function cancelEditing() { state.isEditing = false; updateUI(); }
        
        function saveEditing() {
            const title = document.getElementById('editTitleInput').value;
            const category = document.getElementById('editCategoryInput').value;
            let content = document.getElementById('editContentInput').value;
            const doc = state.docs.find(d => d.id === state.selectedId);
            
            if (doc.type === 'json') {
                try { content = JSON.stringify(JSON.parse(content), null, 2); } 
                catch (e) { alert("⚠️ JSON inválido."); return; }
            }

            const docIndex = state.docs.findIndex(d => d.id === state.selectedId);
            if (docIndex !== -1) {
                state.docs[docIndex] = { ...state.docs[docIndex], title, category, content, lastModified: new Date().toISOString() };
                saveToStorage();
                renderSidebar();
            }
            state.isEditing = false;
            updateUI();
        }

        function renderSidebar() {
            const list = document.getElementById('docList');
            list.innerHTML = '';
            
            const filtered = state.docs.filter(doc => 
                doc.title.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                doc.category.toLowerCase().includes(state.searchQuery.toLowerCase())
            );

            filtered.forEach(doc => {
                const isActive = doc.id === state.selectedId;
                let iconName = 'file-text';
                let badge = 'TXT';
                let badgeClass = "bg-gray-100 text-gray-600";
                
                if (doc.type === 'pdf') { iconName = 'file-text'; badge = 'PDF'; badgeClass = "bg-red-100 text-red-700"; }
                else if (doc.type === 'excel') { iconName = 'table'; badge = 'XLS'; badgeClass = "bg-green-100 text-green-700"; }
                else if (doc.type === 'json') { iconName = 'code-2'; badge = 'JSON'; badgeClass = "bg-yellow-100 text-yellow-700"; }
                else if (doc.type === 'markdown') { iconName = 'file-code'; badge = 'MD'; badgeClass = "bg-blue-100 text-blue-700"; }

                const item = document.createElement('div');
                item.className = `group flex items-center justify-between p-3 rounded-md cursor-pointer transition-all ${isActive ? 'bg-indigo-50 text-indigo-700' : 'hover:bg-gray-100 text-gray-600'}`;
                item.onclick = () => selectDoc(doc.id);
                
                item.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i data-lucide="${iconName}" class="w-4 h-4 ${isActive ? 'text-indigo-500' : 'text-gray-400'}"></i>
                        <div class="flex flex-col truncate">
                            <span class="font-medium truncate text-sm">${doc.title}</span>
                            <span class="text-xs text-gray-400 truncate flex items-center gap-1">
                                <span class="${badgeClass} px-1.5 rounded text-[10px] font-bold min-w-[32px] text-center">${badge}</span>
                                ${doc.category}
                            </span>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function updateUI() {
            const ui = {
                empty: document.getElementById('emptyState'),
                content: document.getElementById('contentArea'),
                viewMode: document.getElementById('viewMode'),
                editMode: document.getElementById('editMode'),
                mdContainer: document.getElementById('markdownContainer'),
                pdfContainer: document.getElementById('pdfContainer'),
                jsonContainer: document.getElementById('jsonContainer'),
                excelContainer: document.getElementById('excelContainer'),
                editBtn: document.getElementById('editBtn')
            };

            if (!state.selectedId) {
                ui.empty.classList.remove('hidden');
                ui.content.classList.add('hidden');
                return;
            }

            const doc = state.docs.find(d => d.id === state.selectedId);
            if (!doc) return;

            ui.empty.classList.add('hidden');
            ui.content.classList.remove('hidden');
            ui.content.classList.add('flex');
            document.getElementById('headerTitle').textContent = doc.title;

            if (state.isEditing) {
                ui.viewMode.classList.add('hidden');
                ui.editMode.classList.remove('hidden');
                document.getElementById('viewActions').classList.add('hidden');
                document.getElementById('editActions').classList.remove('hidden');

                document.getElementById('editTitleInput').value = doc.title;
                document.getElementById('editCategoryInput').value = doc.category;
                document.getElementById('editContentInput').value = doc.content;
            } 
            else {
                ui.viewMode.classList.remove('hidden');
                ui.editMode.classList.add('hidden');
                document.getElementById('viewActions').classList.remove('hidden');
                document.getElementById('editActions').classList.add('hidden');

                document.getElementById('viewTitle').textContent = doc.title;
                document.getElementById('viewCategory').textContent = doc.category;
                document.getElementById('viewDate').textContent = new Date(doc.lastModified).toLocaleDateString();

                // Ocultar todos
                ui.mdContainer.classList.add('hidden');
                ui.pdfContainer.classList.add('hidden');
                ui.jsonContainer.classList.add('hidden');
                ui.excelContainer.classList.add('hidden');
                ui.pdfContainer.classList.remove('flex');

                if (doc.type === 'pdf') {
                    ui.pdfContainer.classList.remove('hidden');
                    ui.pdfContainer.classList.add('flex');
                    ui.editBtn.style.display = 'none'; 
                    loadPdfFromData(doc.content);
                } 
                else if (doc.type === 'excel') {
                    ui.excelContainer.classList.remove('hidden');
                    ui.editBtn.style.display = 'none';
                    loadExcelFromData(doc.content);
                }
                else if (doc.type === 'json') {
                    ui.jsonContainer.classList.remove('hidden');
                    ui.editBtn.style.display = 'flex';
                    document.getElementById('jsonContent').innerHTML = syntaxHighlight(doc.content);
                }
                else {
                    ui.mdContainer.classList.remove('hidden');
                    ui.editBtn.style.display = 'flex';
                    document.getElementById('viewBody').innerHTML = marked.parse(doc.content);
                }
            }
            lucide.createIcons();
        }

        function toggleSidebar(show) {
            const sidebar = document.getElementById('sidebar');
            show ? sidebar.classList.remove('-translate-x-full') : sidebar.classList.add('-translate-x-full');
        }

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            initDragAndDrop(); 

            document.getElementById('createDocBtn').addEventListener('click', createDoc);
            document.getElementById('editBtn').addEventListener('click', startEditing);
            document.getElementById('cancelBtn').addEventListener('click', cancelEditing);
            document.getElementById('saveBtn').addEventListener('click', saveEditing);
            document.getElementById('deleteBtn').addEventListener('click', deleteDoc);
            document.getElementById('downloadBtn').addEventListener('click', downloadDoc);
            
            const fileInput = document.getElementById('fileInput');
            document.getElementById('importDocBtn').addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);

            document.getElementById('searchInput').addEventListener('input', (e) => {
                state.searchQuery = e.target.value;
                renderSidebar();
            });
            document.getElementById('openSidebarBtn').addEventListener('click', () => toggleSidebar(true));
            document.getElementById('closeSidebarBtn').addEventListener('click', () => toggleSidebar(false));

            document.getElementById('prevPage').addEventListener('click', onPrevPage);
            document.getElementById('nextPage').addEventListener('click', onNextPage);
            document.getElementById('zoomIn').addEventListener('click', () => onZoom(0.2));
            document.getElementById('zoomOut').addEventListener('click', () => onZoom(-0.2));
            
            lucide.createIcons();
        });
    </script>
</body>
</html>