<!DOCTYPE html>
<html lang="es" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linked Visor - Personalizable</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Configuraci贸n Din谩mica de Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Usamos variables CSS para el color primario (Personalizaci贸n)
                        primary: {
                            50: 'var(--color-primary-50)',
                            100: 'var(--color-primary-100)',
                            500: 'var(--color-primary-500)',
                            600: 'var(--color-primary-600)',
                            700: 'var(--color-primary-700)',
                        },
                        slate: { 850: '#1e293b' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Librer铆as -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <!-- IMPLEMENTAMOS EL SUPABASE-->


    <style>
        /* --- VARIABLES DE TEMA --- */
        :root {
            /* Default: Indigo */
            --color-primary-50: #eef2ff;
            --color-primary-100: #e0e7ff;
            --color-primary-500: #6366f1;
            --color-primary-600: #4f46e5;
            --color-primary-700: #4338ca;
        }

        /* Temas Alternativos */
        [data-accent="blue"] {
            --color-primary-50: #eff6ff;
            --color-primary-100: #dbeafe;
            --color-primary-500: #3b82f6;
            --color-primary-600: #2563eb;
            --color-primary-700: #1d4ed8;
        }
        [data-accent="emerald"] {
            --color-primary-50: #ecfdf5;
            --color-primary-100: #d1fae5;
            --color-primary-500: #10b981;
            --color-primary-600: #059669;
            --color-primary-700: #047857;
        }
        [data-accent="rose"] {
            --color-primary-50: #fff1f2;
            --color-primary-100: #ffe4e6;
            --color-primary-500: #f43f5e;
            --color-primary-600: #e11d48;
            --color-primary-700: #be123c;
        }
        [data-accent="orange"] {
            --color-primary-50: #fff7ed;
            --color-primary-100: #ffedd5;
            --color-primary-500: #f97316;
            --color-primary-600: #ea580c;
            --color-primary-700: #c2410c;
        }

        body { font-family: 'Inter', system-ui, sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Syntax & Table Styles */
        .json-key { color: var(--color-primary-600); font-weight: 600; } .dark .json-key { color: var(--color-primary-500); }
        .json-string { color: #15803d; } .dark .json-string { color: #4ade80; }
        .json-number { color: #2563eb; } .dark .json-number { color: #60a5fa; }
        
        .excel-table-wrapper table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .excel-table-wrapper th { background-color: #f8fafc; text-align: left; padding: 0.75rem; border: 1px solid #e2e8f0; font-weight: 600; color: #475569; }
        .excel-table-wrapper td { padding: 0.5rem 0.75rem; border: 1px solid #e2e8f0; color: #334155; }
        .dark .excel-table-wrapper th { background-color: #1e293b; border-color: #334155; color: #cbd5e1; }
        .dark .excel-table-wrapper td { border-color: #334155; color: #94a3b8; }

        /* UI Components */
        dialog::backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
        #dropOverlay { backdrop-filter: blur(12px); background-color: rgba(255, 255, 255, 0.7); }
        .dark #dropOverlay { background-color: rgba(15, 23, 42, 0.8); }
        
        .toast { transform: translateY(100%); opacity: 0; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .toast.show { transform: translateY(0); opacity: 1; }
    </style>
</head>

<body class="bg-gray-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 h-screen flex overflow-hidden relative transition-colors duration-300 selection:bg-primary-100 selection:text-primary-700">

    <!-- TOAST CONTAINER -->
    <div id="toastContainer" class="fixed bottom-6 right-6 z-[200] flex flex-col gap-3 pointer-events-none"></div>

    <!-- INPUTS OCULTOS -->
    <input type="file" id="fileInput" accept=".txt,.md,.markdown,.pdf,.json,.xlsx,.xls,.csv,.png,.jpg,.jpeg,.webp,.html,.htm,.css,.js,.xml" class="hidden">
    <input type="file" id="importAllInput" accept="application/json" class="hidden">

    <!-- MODAL AJUSTES (PERSONALIZACIN) -->
    <dialog id="settingsModal" class="p-0 rounded-2xl shadow-2xl w-full max-w-sm bg-white dark:bg-slate-800 overflow-hidden backdrop:bg-gray-900/50">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white flex items-center gap-2">
                    <i data-lucide="palette" class="w-5 h-5 text-primary-600"></i> Apariencia
                </h3>
                <button onclick="document.getElementById('settingsModal').close()" class="p-1 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                </button>
            </div>

            <!-- Selector de Tema -->
            <div class="mb-6">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-3">Tema</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setThemeMode('light')" class="flex items-center justify-center gap-2 p-3 rounded-xl border border-gray-200 dark:border-slate-600 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-slate-700 transition-all" id="btnThemeLight">
                        <i data-lucide="sun" class="w-4 h-4"></i> Claro
                    </button>
                    <button onclick="setThemeMode('dark')" class="flex items-center justify-center gap-2 p-3 rounded-xl border border-gray-200 dark:border-slate-600 hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-slate-700 transition-all" id="btnThemeDark">
                        <i data-lucide="moon" class="w-4 h-4"></i> Oscuro
                    </button>
                </div>
            </div>

            <!-- Selector de Acento -->
            <div class="mb-6">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-3">Color de Acento</label>
                <div class="flex justify-between gap-2">
                    <button onclick="setAccentColor('indigo')" class="w-10 h-10 rounded-full bg-indigo-500 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-offset-2 focus:ring-indigo-500"></button>
                    <button onclick="setAccentColor('blue')" class="w-10 h-10 rounded-full bg-blue-500 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-offset-2 focus:ring-blue-500"></button>
                    <button onclick="setAccentColor('emerald')" class="w-10 h-10 rounded-full bg-emerald-500 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-offset-2 focus:ring-emerald-500"></button>
                    <button onclick="setAccentColor('rose')" class="w-10 h-10 rounded-full bg-rose-500 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-offset-2 focus:ring-rose-500"></button>
                    <button onclick="setAccentColor('orange')" class="w-10 h-10 rounded-full bg-orange-500 hover:scale-110 transition-transform ring-2 ring-transparent focus:ring-offset-2 focus:ring-orange-500"></button>
                </div>
            </div>
            
            <div class="text-xs text-center text-gray-400 pt-4 border-t border-gray-100 dark:border-slate-700">
                Linked Visor v3.2
            </div>
        </div>
    </dialog>

    <!-- MODAL NUEVO DOCUMENTO -->
    <dialog id="newDocModal" class="p-0 rounded-2xl shadow-2xl w-full max-w-lg bg-white dark:bg-slate-800 overflow-hidden">
        <form id="newDocForm" method="dialog" class="p-6">
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-1">Nuevo Archivo</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">Selecciona el tipo de contenido.</p>
            
            <div class="mb-5">
                <input type="text" id="newDocTitleInput" required class="w-full p-3 rounded-xl border border-gray-200 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-primary-500 outline-none transition-all placeholder-gray-400 font-medium" placeholder="Nombre del documento...">
            </div>

            <!-- GRID DE OPCIONES RESTAURADA COMPLETA -->
            <div class="mb-8 grid grid-cols-3 gap-3">
                <label class="cursor-pointer group">
                    <input type="radio" name="docType" value="markdown" class="peer hidden" checked>
                    <div class="p-4 rounded-xl border border-gray-200 dark:border-slate-600 peer-checked:border-primary-500 peer-checked:bg-primary-50 dark:peer-checked:bg-primary-500/10 peer-checked:text-primary-600 dark:peer-checked:text-primary-400 flex flex-col items-center gap-2 transition-all hover:bg-gray-50 dark:hover:bg-slate-700">
                        <i data-lucide="file-text" class="w-6 h-6"></i>
                        <span class="text-xs font-bold">Markdown</span>
                    </div>
                </label>
                <label class="cursor-pointer group">
                    <input type="radio" name="docType" value="html" class="peer hidden">
                    <div class="p-4 rounded-xl border border-gray-200 dark:border-slate-600 peer-checked:border-orange-500 peer-checked:bg-orange-50 dark:peer-checked:bg-orange-900/10 peer-checked:text-orange-600 dark:peer-checked:text-orange-400 flex flex-col items-center gap-2 transition-all hover:bg-gray-50 dark:hover:bg-slate-700">
                        <i data-lucide="file-code" class="w-6 h-6"></i>
                        <span class="text-xs font-bold">HTML</span>
                    </div>
                </label>
                <label class="cursor-pointer group">
                    <input type="radio" name="docType" value="code" class="peer hidden">
                    <div class="p-4 rounded-xl border border-gray-200 dark:border-slate-600 peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/10 peer-checked:text-blue-600 dark:peer-checked:text-blue-400 flex flex-col items-center gap-2 transition-all hover:bg-gray-50 dark:hover:bg-slate-700">
                        <i data-lucide="code" class="w-6 h-6"></i>
                        <span class="text-xs font-bold">C贸digo</span>
                    </div>
                </label>
                <label class="cursor-pointer group">
                    <input type="radio" name="docType" value="json" class="peer hidden">
                    <div class="p-4 rounded-xl border border-gray-200 dark:border-slate-600 peer-checked:border-yellow-500 peer-checked:bg-yellow-50 dark:peer-checked:bg-yellow-900/10 peer-checked:text-yellow-600 dark:peer-checked:text-yellow-400 flex flex-col items-center gap-2 transition-all hover:bg-gray-50 dark:hover:bg-slate-700">
                        <i data-lucide="braces" class="w-6 h-6"></i>
                        <span class="text-xs font-bold">JSON</span>
                    </div>
                </label>
                <label class="cursor-pointer group">
                    <input type="radio" name="docType" value="excel" class="peer hidden">
                    <div class="p-4 rounded-xl border border-gray-200 dark:border-slate-600 peer-checked:border-green-500 peer-checked:bg-green-50 dark:peer-checked:bg-green-900/10 peer-checked:text-green-600 dark:peer-checked:text-green-400 flex flex-col items-center gap-2 transition-all hover:bg-gray-50 dark:hover:bg-slate-700">
                        <i data-lucide="table" class="w-6 h-6"></i>
                        <span class="text-xs font-bold">Tabla</span>
                    </div>
                </label>
                <label class="cursor-pointer group">
                    <input type="radio" name="docType" value="text" class="peer hidden">
                    <div class="p-4 rounded-xl border border-gray-200 dark:border-slate-600 peer-checked:border-gray-500 peer-checked:bg-gray-100 dark:peer-checked:bg-gray-700 peer-checked:text-gray-700 dark:peer-checked:text-gray-300 flex flex-col items-center gap-2 transition-all hover:bg-gray-50 dark:hover:bg-slate-700">
                        <i data-lucide="align-left" class="w-6 h-6"></i>
                        <span class="text-xs font-bold">Texto</span>
                    </div>
                </label>
            </div>

            <div class="flex gap-3 justify-end">
                <button type="button" onclick="document.getElementById('newDocModal').close()" class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors">Cancelar</button>
                <button type="submit" class="px-6 py-2 text-sm font-bold text-white bg-primary-600 hover:bg-primary-700 rounded-lg shadow-lg shadow-primary-500/30 transition-all transform hover:scale-105">Crear</button>
            </div>
        </form>
    </dialog>

    <!-- MODAL AUTH (SUPABASE) -->
    <dialog id="authModal" class="p-0 rounded-2xl shadow-2xl w-full max-w-sm bg-white dark:bg-slate-800 overflow-hidden">
    <form id="authForm" method="dialog" class="p-6 space-y-4">
        <div class="flex items-center justify-between">
        <h3 class="text-lg font-black text-slate-800 dark:text-white">Supabase</h3>
        <button type="button" onclick="document.getElementById('authModal').close()"
            class="p-1 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-full transition-colors">
            <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
        </button>
        </div>

        <input id="authEmail" type="email" required placeholder="Email"
        class="w-full p-3 rounded-xl border border-gray-200 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 dark:text-white outline-none">

        <input id="authPass" type="password" required placeholder="Contrase帽a"
        class="w-full p-3 rounded-xl border border-gray-200 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 dark:text-white outline-none">

        <div class="grid grid-cols-2 gap-3 pt-2">
        <button id="btnSignIn" type="button"
            class="px-4 py-2 rounded-xl bg-slate-900 dark:bg-primary-600 text-white font-bold">
            Login
        </button>
        <button id="btnSignUp" type="button"
            class="px-4 py-2 rounded-xl bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 font-bold text-slate-700 dark:text-slate-200">
            Registro
        </button>
        </div>

        <p class="text-xs text-gray-400">Al iniciar sesi贸n se sincronizan tus documentos.</p>
    </form>
    </dialog>


    <!-- OVERLAY DRAG & DROP -->
    <div id="dropOverlay" class="hidden absolute inset-0 z-[100] flex flex-col items-center justify-center border-4 border-primary-500/30 border-dashed m-6 rounded-3xl transition-all pointer-events-none">
        <div class="bg-primary-50 dark:bg-slate-800 p-8 rounded-full mb-6 animate-bounce shadow-2xl">
            <i data-lucide="upload-cloud" class="w-24 h-24 text-primary-500"></i>
        </div>
        <h2 class="text-4xl font-black text-slate-800 dark:text-white">Suelta aqu铆</h2>
        <p class="text-lg text-slate-500 dark:text-slate-400 mt-2 font-medium">Importaci贸n r谩pida activada</p>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-80 bg-white dark:bg-slate-800 border-r border-gray-200 dark:border-slate-700 flex flex-col h-full fixed md:relative z-20 transition-transform duration-300 transform md:translate-x-0 -translate-x-full shadow-2xl md:shadow-none">
        
        <!-- Header -->
        <div class="p-6 flex items-center justify-between shrink-0">
            <div class="flex items-center gap-3 text-primary-600 dark:text-primary-500 font-black text-2xl tracking-tight">
                <div class="bg-primary-100 dark:bg-primary-900/30 p-2 rounded-lg">
                    <i data-lucide="link" class="w-6 h-6"></i>
                </div>
                <span>Linked</span>
            </div>
            <button id="closeSidebarBtn" class="md:hidden text-gray-400 hover:text-gray-600 dark:hover:text-white transition-colors">
                <i data-lucide="x"></i>
            </button>
        </div>

        <!-- Controls -->
        <div class="px-6 pb-4 space-y-4">
            <!-- Search -->
            <div class="relative group">
                <i data-lucide="search" class="absolute left-3 top-3 text-gray-400 group-focus-within:text-primary-500 w-4 h-4 transition-colors"></i>
                <input type="text" id="searchInput" placeholder="Buscar..." class="w-full pl-10 pr-4 py-2.5 bg-gray-50 dark:bg-slate-700/50 border border-gray-200 dark:border-slate-600 focus:bg-white dark:focus:bg-slate-700 focus:border-primary-500 focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900/30 rounded-xl text-sm outline-none transition-all dark:text-white font-medium">
            </div>
            
            <!-- Actions -->
            <div class="grid grid-cols-2 gap-3">
                <button id="openNewDocModalBtn" class="flex items-center justify-center gap-2 bg-primary-600 hover:bg-primary-700 text-white py-2.5 px-3 rounded-xl transition-all font-bold text-sm shadow-lg shadow-primary-500/20 active:scale-95">
                    <i data-lucide="plus" class="w-4 h-4"></i> Nuevo
                </button>
                <button id="importDocBtn" class="flex items-center justify-center gap-2 bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border border-gray-200 dark:border-slate-600 py-2.5 px-3 rounded-xl transition-all font-bold text-sm hover:shadow-md active:scale-95">
                    <i data-lucide="upload" class="w-4 h-4"></i> Importar
                </button>
            </div>

            <!-- Filters -->
            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide snap-x" id="filterChips">
                <button data-filter="all" class="snap-start px-3 py-1.5 text-xs font-bold bg-slate-800 text-white rounded-lg whitespace-nowrap transition-colors shadow-sm">Todos</button>
                <button data-filter="code" class="snap-start px-3 py-1.5 text-xs font-bold bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-600 hover:shadow-sm rounded-lg whitespace-nowrap transition-all border border-transparent hover:border-gray-200">Dev</button>
                <button data-filter="pdf" class="snap-start px-3 py-1.5 text-xs font-bold bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-600 hover:shadow-sm rounded-lg whitespace-nowrap transition-all border border-transparent hover:border-gray-200">PDF</button>
                <button data-filter="excel" class="snap-start px-3 py-1.5 text-xs font-bold bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-600 hover:shadow-sm rounded-lg whitespace-nowrap transition-all border border-transparent hover:border-gray-200">Excel</button>
                <button data-filter="image" class="snap-start px-3 py-1.5 text-xs font-bold bg-gray-100 dark:bg-slate-700 text-gray-500 dark:text-gray-400 hover:bg-white dark:hover:bg-slate-600 hover:shadow-sm rounded-lg whitespace-nowrap transition-all border border-transparent hover:border-gray-200">Img</button>
            </div>
        </div>

        <!-- File List -->
        <div class="px-6 pb-2 pt-2 border-t border-gray-100 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Tus Archivos</p>
            <div id="docList" class="flex-1 overflow-y-auto space-y-2 pr-2"></div>
        </div>

        <!-- STORAGE STATS BAR (NUEVO) -->
        <div class="p-4 bg-gray-50 dark:bg-slate-900 border-t border-gray-200 dark:border-slate-700">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-gray-500 dark:text-gray-400">Almacenamiento</span>
                <span id="storageText" class="text-xs font-bold text-primary-600 dark:text-primary-400">0%</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
                    <div id="storageBar" class="bg-primary-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-3 items-center">
                    <button id="openSettingsBtn" class="text-xs font-bold text-gray-500 hover:text-primary-600 flex items-center gap-1 transition-colors">
                    <i data-lucide="settings" class="w-3 h-3"></i> Ajustes
                    </button>

                    <div class="flex items-center gap-2">
                        <button id="btnAuth" class="text-xs font-bold text-gray-500 hover:text-primary-600 transition-colors">
                        Iniciar sesi贸n
                        </button>
                        <button id="btnLogout" class="hidden text-xs font-bold text-red-500 hover:text-red-600 transition-colors">
                        Salir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative w-full overflow-hidden bg-white dark:bg-slate-900 transition-colors">

        <div class="absolute top-4 left-4 z-10 md:hidden">
            <button id="openSidebarBtn" class="p-2 bg-white dark:bg-slate-800 shadow-lg rounded-xl border border-gray-100 dark:border-slate-700 text-gray-600 dark:text-gray-300">
                <i data-lucide="menu"></i>
            </button>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden flex-1 flex flex-col items-center justify-center text-gray-400 p-8 fade-in bg-gray-50/50 dark:bg-slate-900">
            <div class="bg-white dark:bg-slate-800 border-2 border-dashed border-gray-200 dark:border-slate-700 rounded-3xl p-12 flex flex-col items-center justify-center hover:border-primary-400 dark:hover:border-primary-500 hover:shadow-2xl transition-all cursor-pointer w-full max-w-lg group duration-300" onclick="document.getElementById('fileInput').click()">
                <div class="w-24 h-24 bg-primary-50 dark:bg-slate-700 rounded-full flex items-center justify-center mb-6 text-primary-500 dark:text-primary-400 group-hover:scale-110 group-hover:rotate-12 transition-all duration-300 shadow-inner">
                    <i data-lucide="sparkles" class="w-10 h-10"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 dark:text-white mb-2">Espacio de Trabajo</h3>
                <p class="text-slate-500 dark:text-slate-400 text-center mb-8 max-w-xs font-medium">Sube tus documentos para visualizar, editar y organizarlos.</p>
                <button class="bg-slate-900 dark:bg-primary-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-800 dark:hover:bg-primary-500 transition-all shadow-xl hover:shadow-2xl transform hover:-translate-y-1">
                    Explorar Archivos
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div id="contentArea" class="hidden flex-col h-full">
            <header class="h-16 border-b border-gray-100 dark:border-slate-700 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md flex items-center justify-between px-6 shrink-0 z-10 sticky top-0 transition-colors">
                <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400 ml-10 md:ml-0 overflow-hidden">
                    <div id="headerIcon" class="p-2 bg-gray-100 dark:bg-slate-700 rounded-lg text-gray-600 dark:text-gray-300">
                        <i data-lucide="file" class="w-4 h-4"></i>
                    </div>
                    <span id="headerTitle" class="font-bold text-slate-800 dark:text-white truncate max-w-[150px] md:max-w-md text-lg">Titulo</span>
                </div>

                <div class="flex items-center gap-2">
                    <!-- Bot贸n Men煤 Contextual -->
                    <div class="relative">
                        <button id="menuBtn" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-lg transition-colors">
                            <i data-lucide="more-vertical" class="w-5 h-5"></i>
                        </button>
                        <!-- Dropdown (Reutiliza l贸gica anterior) -->
                        <div id="menuDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-600 rounded-2xl shadow-2xl overflow-hidden z-50 p-1">
                            <button data-action="exportDoc" class="w-full px-3 py-2 text-left text-sm text-slate-700 dark:text-slate-200 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl flex items-center gap-3 transition-colors font-medium">
                                <i data-lucide="download" class="w-4 h-4"></i> Exportar
                            </button>
                            <button data-action="delete" class="w-full px-3 py-2 text-left text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl flex items-center gap-3 transition-colors font-medium">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> Eliminar
                            </button>
                            <div class="h-px bg-gray-100 dark:bg-slate-700 my-1"></div>
                            <button data-action="exportAll" class="w-full px-3 py-2 text-left text-sm text-slate-500 dark:text-slate-400 hover:bg-gray-50 dark:hover:bg-slate-700 rounded-xl flex items-center gap-3 transition-colors">
                                <i data-lucide="database" class="w-4 h-4"></i> Backup Total
                            </button>
                        </div>
                    </div>

                    <div class="w-px h-6 bg-gray-200 dark:bg-slate-700 mx-2"></div>

                    <!-- Acciones Primarias -->
                    <div id="viewActions">
                        <button id="editBtn" class="flex items-center gap-2 px-5 py-2 text-sm text-white bg-slate-900 dark:bg-primary-600 hover:bg-slate-800 dark:hover:bg-primary-500 rounded-xl font-bold shadow-lg transition-all active:scale-95">
                            <i data-lucide="edit-3" class="w-4 h-4"></i> Editar
                        </button>
                    </div>
                    
                    <div id="editActions" class="hidden flex gap-2">
                        <button id="cancelBtn" class="px-4 py-2 text-sm font-bold text-slate-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-xl transition-colors">Cancelar</button>
                        <button id="saveBtn" class="flex items-center gap-2 px-5 py-2 text-sm bg-primary-600 text-white hover:bg-primary-700 rounded-xl font-bold shadow-lg shadow-primary-500/30 transition-all active:scale-95">
                            <i data-lucide="save" class="w-4 h-4"></i> Guardar
                        </button>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 md:p-10 relative scroll-smooth bg-gray-50/50 dark:bg-slate-900" id="mainScroll">
                <div class="max-w-5xl mx-auto h-full flex flex-col">
                    
                    <article id="viewMode" class="fade-in flex-1 flex flex-col">
                        <div class="mb-8 flex items-center gap-3 opacity-75">
                             <span id="viewCategory" class="px-3 py-1 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs font-bold uppercase tracking-wider rounded-lg border border-gray-200 dark:border-slate-700 shadow-sm">General</span>
                             <span id="viewDate" class="text-xs font-medium text-slate-400">Actualizado hoy</span>
                        </div>

                        <!-- CONTAINERS (Views) -->
                        <div id="markdownContainer" class="hidden bg-white dark:bg-slate-800 p-12 rounded-3xl shadow-sm border border-gray-100 dark:border-slate-700 min-h-[500px]">
                            <div id="viewBody" class="prose prose-slate dark:prose-invert prose-lg max-w-none"></div>
                        </div>

                        <div id="pdfContainer" class="hidden flex-col items-center w-full bg-slate-100 dark:bg-slate-950 rounded-3xl border border-gray-200 dark:border-slate-700 p-8 shadow-inner min-h-[600px]">
                            <div class="flex items-center gap-2 bg-white dark:bg-slate-800 px-4 py-2 rounded-2xl shadow-xl mb-8 sticky top-0 z-20 border border-gray-100 dark:border-slate-600 ring-1 ring-black/5">
                                <button id="prevPage" class="hover:bg-gray-100 dark:hover:bg-slate-700 p-2 rounded-xl dark:text-white transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                                <span class="text-sm font-mono font-bold dark:text-white mx-3">P谩g <span id="pageNum">1</span> / <span id="pageCount">-</span></span>
                                <button id="nextPage" class="hover:bg-gray-100 dark:hover:bg-slate-700 p-2 rounded-xl dark:text-white transition-colors"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                                <div class="w-px h-5 bg-gray-200 dark:bg-slate-600 mx-2"></div>
                                <button id="zoomOut" class="hover:bg-gray-100 dark:hover:bg-slate-700 p-2 rounded-xl dark:text-white transition-colors"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                <button id="zoomIn" class="hover:bg-gray-100 dark:hover:bg-slate-700 p-2 rounded-xl dark:text-white transition-colors"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                <span id="zoomLevel" class="text-xs font-mono font-bold text-slate-500 dark:text-slate-300 ml-2">120%</span>
                            </div>
                            <canvas id="the-canvas" class="shadow-2xl border border-gray-200 dark:border-slate-600 bg-white rounded-lg"></canvas>
                        </div>

                        <div id="jsonContainer" class="hidden bg-[#0f172a] p-8 rounded-3xl shadow-2xl border border-slate-700 text-slate-300 font-mono text-sm overflow-x-auto min-h-[500px]">
                            <pre id="jsonContent" class="leading-relaxed"></pre>
                        </div>

                        <div id="codeContainer" class="hidden bg-[#1e293b] p-8 rounded-3xl shadow-2xl border border-slate-700 text-blue-100 font-mono text-sm overflow-x-auto min-h-[500px]">
                            <pre class="leading-relaxed whitespace-pre-wrap"></pre>
                        </div>

                        <div id="excelContainer" class="hidden bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-gray-200 dark:border-slate-700 overflow-hidden min-h-[500px]">
                            <div class="px-8 py-4 bg-green-50 dark:bg-green-900/20 border-b border-green-100 dark:border-green-800/30 flex justify-between items-center">
                                <span class="text-sm font-bold text-green-800 dark:text-green-400 flex items-center gap-2">
                                    <div class="bg-green-100 dark:bg-green-800 p-1 rounded"><i data-lucide="sheet" class="w-4 h-4"></i></div>
                                    Vista Previa de Datos
                                </span>
                            </div>
                            <div id="excelContent" class="excel-table-wrapper overflow-x-auto p-0 dark:text-gray-300"></div>
                        </div>

                        <div id="imageContainer" class="hidden flex-col items-center justify-center bg-white dark:bg-slate-800 rounded-3xl shadow-sm border border-gray-200 dark:border-slate-700 p-8 min-h-[500px]">
                            <img id="imageViewer" src="" alt="Vista previa" class="max-w-full max-h-[70vh] rounded-xl shadow-2xl ring-1 ring-black/5 object-contain">
                        </div>
                    </article>

                    <!-- EDIT MODE -->
                    <div id="editMode" class="hidden h-full flex flex-col fade-in bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl border border-gray-100 dark:border-slate-700">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">T铆tulo</label>
                                <input type="text" id="editTitleInput" class="w-full text-2xl font-black text-slate-800 dark:text-white border-b-2 border-gray-100 dark:border-slate-600 focus:border-primary-500 outline-none py-2 bg-transparent transition-colors placeholder-gray-300">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Etiqueta</label>
                                <input type="text" id="editCategoryInput" class="w-full text-sm font-bold text-slate-600 dark:text-slate-200 bg-gray-50 dark:bg-slate-700 border border-gray-200 dark:border-slate-600 rounded-xl px-4 py-3 focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900 focus:border-primary-500 outline-none transition-all">
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Contenido</label>
                            <textarea id="editContentInput" class="flex-1 w-full p-6 text-base font-mono bg-gray-50 dark:bg-slate-700/30 border border-gray-200 dark:border-slate-600 rounded-2xl focus:ring-4 focus:ring-primary-50 dark:focus:ring-primary-900 focus:border-primary-400 outline-none resize-none leading-relaxed text-slate-700 dark:text-slate-200 transition-all"></textarea>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Footer Informativo -->
            <footer class="h-10 bg-white dark:bg-slate-800 border-t border-gray-100 dark:border-slate-700 flex items-center justify-between px-8 text-[10px] uppercase font-bold text-gray-400 dark:text-slate-500 shrink-0 select-none">
                <div id="footerLeft" class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span> Listo
                </div>
                <div class="flex gap-6">
                    <span id="footerWords" class="hidden md:inline">0 Palabras</span>
                    <span id="footerSize">0 KB</span>
                </div>
            </footer>
        </div>
    </main>

    <script>
        marked.use({ breaks: true, gfm: true });

        const DOC_TYPES = { TEXT: 'text', MD: 'markdown', JSON: 'json', PDF: 'pdf', EXCEL: 'excel', IMAGE: 'image', HTML: 'html', CODE: 'code' };

        const state = {
            docs: [],
            selectedId: null,
            isEditing: false,
            searchQuery: '',
            filterType: 'all',
            pdf: { doc: null, pageNum: 1, pageRendering: false, pageNumPending: null, scale: 1.2, canvas: null, ctx: null }
        };
        
        // --- TOAST NOTIFICATIONS ---
        const Toast = {
            show(msg, type = 'info') {
                const container = document.getElementById('toastContainer');
                const el = document.createElement('div');
                let icon = type === 'success' ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>' : 
                           type === 'error' ? '<i data-lucide="alert-circle" class="w-5 h-5 text-red-400"></i>' : 
                           '<i data-lucide="info" class="w-5 h-5 text-blue-400"></i>';
                
                el.className = `toast px-5 py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-2xl shadow-2xl flex items-center gap-4 border border-slate-700/50 min-w-[300px] font-medium backdrop-blur-md`;
                el.innerHTML = `${icon} <span>${msg}</span>`;
                
                container.appendChild(el);
                lucide.createIcons();
                el.offsetHeight; // Force reflow
                el.classList.add('show');
                setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 400); }, 3000);
            }
        };

        // --- THEME & ACCENT LOGIC ---
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const savedAccent = localStorage.getItem('accent') || 'indigo';
            
            // Set Dark/Light
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            
            // Set Accent
            document.documentElement.setAttribute('data-accent', savedAccent);
        }

        function setThemeMode(mode) {
            if (mode === 'dark') {
                document.documentElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        }

        function setAccentColor(color) {
            document.documentElement.setAttribute('data-accent', color);
            localStorage.setItem('accent', color);
            Toast.show(`Color cambiado a ${color}`, 'success');
        }

        // --- STORAGE STATS ---
        function updateStorageStats() {
            const totalBytes = new Blob([JSON.stringify(state.docs)]).size;
            const maxBytes = 5 * 1024 * 1024; // 5MB approx limit
            const percent = Math.min((totalBytes / maxBytes) * 100, 100).toFixed(1);
            
            document.getElementById('storageBar').style.width = `${percent}%`;
            document.getElementById('storageText').textContent = `${(totalBytes/1024).toFixed(0)}KB / 5MB`;
            
            if(percent > 90) document.getElementById('storageBar').classList.add('bg-red-500');
            else document.getElementById('storageBar').classList.remove('bg-red-500');
        }

        const DocRepo = {
            add(doc) {
                state.docs.unshift(doc);
                saveToStorage();
                Toast.show('Archivo creado con 茅xito', 'success');
                updateStorageStats();
            },
            update(id, changes) {
                const idx = state.docs.findIndex(d => d.id === id);
                if (idx === -1) return;
                state.docs[idx] = { ...state.docs[idx], ...changes, lastModified: new Date().toISOString() };
                saveToStorage();
                Toast.show('Cambios guardados', 'success');
                updateStorageStats();
            },
            remove(id) {
                state.docs = state.docs.filter(d => d.id !== id);
                saveToStorage();
                Toast.show('Documento eliminado', 'info');
                updateStorageStats();
            }
        };

        window.DocRepo = DocRepo;

        const INITIAL_DOCS = [
            {
                id: '1',
                title: 'Bienvenido a Linked Visor',
                category: 'Inicio',
                type: DOC_TYPES.MD,
                content: `#  Versi贸n 3.0\n\nBienvenido a la experiencia definitiva.\n\n### Novedades:\n-  **Personalizaci贸n Total**: Cambia colores y temas.\n-  **Estad铆sticas**: Controla tu almacenamiento local.\n-  **Interfaz Premium**: Nuevo dise帽o visual Glassmorphism.\n\nVe a **Ajustes** (abajo a la izquierda) para probar los colores.`,
                lastModified: new Date().toISOString(),
                size: 1024
            }
        ];

        function initApp() {
            initTheme();
            try {
                const saved = localStorage.getItem('linked-visor-db');
                state.docs = saved ? JSON.parse(saved) : INITIAL_DOCS;
            } catch (e) {
                state.docs = INITIAL_DOCS;
            }
            
            state.pdf.canvas = document.getElementById('the-canvas');
            state.pdf.ctx = state.pdf.canvas.getContext('2d');

            if (state.docs.length > 0) selectDoc(state.docs[0].id);
            else renderSidebar();
            
            updateUI();
            updateStorageStats();
        }

        function saveToStorage() {
            try {
                localStorage.setItem('linked-visor-db', JSON.stringify(state.docs));
            } catch (e) {
                if (e.name === 'QuotaExceededError') Toast.show('锔 Espacio lleno. Borra archivos.', 'error');
            }
        }

        // --- FILE PROCESSING ---
        function processFile(file) {
            if (!file) return;
            const reader = new FileReader();
            const ext = file.name.split('.').pop().toLowerCase();
            const mime = file.type || '';
            
            const isPdf = mime.includes('pdf') || ext === 'pdf';
            const isJson = mime.includes('json') || ext === 'json';
            const isExcel = ['xlsx', 'xls', 'csv'].includes(ext) || mime.includes('sheet') || mime.includes('csv');
            const isImage = mime.startsWith('image/') || ['png', 'jpg', 'jpeg', 'webp', 'gif'].includes(ext);
            const isMd = ['md', 'markdown'].includes(ext);
            const isHtml = ['html', 'htm'].includes(ext);
            const isCode = ['css', 'js', 'xml', 'ts'].includes(ext);

            if (isPdf || isExcel || isImage) reader.readAsDataURL(file);
            else reader.readAsText(file);

            reader.onload = function(e) {
                let content = e.target.result;
                const baseName = file.name.replace(/\.[^/.]+$/, "");
                let docType = DOC_TYPES.TEXT;

                if (isJson) {
                    try { content = JSON.stringify(JSON.parse(content), null, 2); docType = DOC_TYPES.JSON; }
                    catch (err) { docType = DOC_TYPES.TEXT; }
                } else if (isPdf) docType = DOC_TYPES.PDF;
                else if (isExcel) docType = DOC_TYPES.EXCEL;
                else if (isImage) docType = DOC_TYPES.IMAGE;
                else if (isHtml) docType = DOC_TYPES.HTML;
                else if (isCode) docType = DOC_TYPES.CODE;
                else if (isMd) docType = DOC_TYPES.MD;

                const newDoc = {
                    id: crypto.randomUUID(),
                    title: baseName.charAt(0).toUpperCase() + baseName.slice(1),
                    category: 'Importado',
                    type: docType,
                    content: content,
                    rawDataUrl: (isPdf || isExcel || isImage) ? content : null, //  nuevo
                    lastModified: new Date().toISOString(),
                    size: file.size
                };
                DocRepo.add(newDoc);
                selectDoc(newDoc.id);
                renderSidebar();
            };
        }

        // --- DOWNLOAD & EXPORT ---
        function downloadDoc() {
             const doc = state.docs.find(d => d.id === state.selectedId);
             if(!doc) return;
             const link = document.createElement('a');
             let ext = '.txt';
             if(doc.type === DOC_TYPES.HTML) ext = '.html';
             if(doc.type === DOC_TYPES.CODE) ext = '.js';
             if(doc.type === DOC_TYPES.MD) ext = '.md';
             
             if(doc.type===DOC_TYPES.PDF || doc.type===DOC_TYPES.EXCEL || doc.type===DOC_TYPES.IMAGE) link.href = doc.content;
             else link.href = URL.createObjectURL(new Blob([doc.content], {type: doc.type===DOC_TYPES.JSON?'application/json':(doc.type===DOC_TYPES.HTML?'text/html':'text/plain')}));
             
             link.download = doc.title + (doc.type === DOC_TYPES.IMAGE ? '.png' : (doc.type === DOC_TYPES.EXCEL ? '.csv' : ext));
             link.click();
        }

        // --- RENDERERS ---
        function syntaxHighlight(json) {
            if (typeof json !== 'string') json = JSON.stringify(json, undefined, 2);
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
                let cls = 'json-number';
                if (/^"/.test(match)) cls = /:$/.test(match) ? 'json-key' : 'json-string';
                else if (/true|false/.test(match)) cls = 'json-boolean';
                else if (/null/.test(match)) cls = 'json-null';
                return `<span class="${cls}">${match}</span>`;
            });
        }

        async function loadExcelFromData(content) {
        try {
            let workbook;

            // Caso 1: DataURL base64 (local)
            if (typeof content === "string" && content.startsWith("data:")) {
            const cleanBase64 = content.split(",")[1];
            workbook = XLSX.read(cleanBase64, { type: "base64" });
            }
            // Caso 2: URL (Supabase signed URL)
            else if (typeof content === "string" && /^https?:\/\//.test(content)) {
            const res = await fetch(content);
            if (!res.ok) throw new Error("No se pudo descargar el Excel desde Supabase");
            const buf = await res.arrayBuffer();
            workbook = XLSX.read(buf, { type: "array" });
            }
            // Caso 3: texto csv plano u otro
            else {
            workbook = XLSX.read(content, { type: "string" });
            }

            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const html = XLSX.utils.sheet_to_html(worksheet, { id: "excelTable", editable: false });
            document.getElementById("excelContent").innerHTML = html;
        } catch (e) {
            console.error(e);
            document.getElementById("excelContent").innerHTML =
            `<p class="text-red-500 p-4">Error al leer Excel.</p>`;
        }
        }


        function renderPdfPage(num) {
            state.pdf.pageRendering = true;
            state.pdf.doc.getPage(num).then(page => {
                const viewport = page.getViewport({scale: state.pdf.scale});
                state.pdf.canvas.height = viewport.height;
                state.pdf.canvas.width = viewport.width;
                page.render({ canvasContext: state.pdf.ctx, viewport }).promise.then(() => {
                    state.pdf.pageRendering = false;
                    if (state.pdf.pageNumPending !== null) {
                        renderPdfPage(state.pdf.pageNumPending);
                        state.pdf.pageNumPending = null;
                    }
                });
            });
            document.getElementById('pageNum').textContent = num;
        }
        function loadPdfFromData(data) {
            pdfjsLib.getDocument(data).promise.then(pdf => {
                state.pdf.doc = pdf;
                document.getElementById('pageCount').textContent = pdf.numPages;
                renderPdfPage(1);
            });
        }
        function queueRenderPage(num) { state.pdf.pageRendering ? state.pdf.pageNumPending = num : renderPdfPage(num); }
        document.getElementById('prevPage').onclick = () => state.pdf.pageNum > 1 && queueRenderPage(--state.pdf.pageNum);
        document.getElementById('nextPage').onclick = () => state.pdf.pageNum < state.pdf.doc.numPages && queueRenderPage(++state.pdf.pageNum);
        document.getElementById('zoomIn').onclick = () => { if (state.pdf.scale < 3) { state.pdf.scale += 0.2; queueRenderPage(state.pdf.pageNum); document.getElementById('zoomLevel').textContent = Math.round(state.pdf.scale*100)+'%'; }};
        document.getElementById('zoomOut').onclick = () => { if (state.pdf.scale > 0.5) { state.pdf.scale -= 0.2; queueRenderPage(state.pdf.pageNum); document.getElementById('zoomLevel').textContent = Math.round(state.pdf.scale*100)+'%'; }};

        function selectDoc(id) {
            state.selectedId = id;
            state.isEditing = false;
            updateUI();
            if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
        }

        // --- NEW DOC LOGIC ---
        function createNewDocFromModal(e) {
            e.preventDefault();
            const title = document.getElementById('newDocTitleInput').value || 'Sin T铆tulo';
            const type = document.querySelector('input[name="docType"]:checked').value;
            const nowIso = new Date().toISOString();
            
            let content = '';
            let docType = DOC_TYPES.TEXT;

            if (type === 'markdown') { content = `# ${title}\n`; docType = DOC_TYPES.MD; }
            else if (type === 'html') { content = `<h1>${title}</h1>`; docType = DOC_TYPES.HTML; }
            else if (type === 'code') { content = `// C贸digo`; docType = DOC_TYPES.CODE; }
            else if (type === 'json') { content = `{\n  "id": "${crypto.randomUUID()}"\n}`; docType = DOC_TYPES.JSON; }
            else if (type === 'excel') { content = `Data1,Data2\nVal1,Val2`; docType = DOC_TYPES.EXCEL; }

            const newDoc = {
                id: crypto.randomUUID(),
                title: title,
                category: 'Borrador',
                type: docType,
                content: content,
                lastModified: nowIso,
                size: content.length
            };

            DocRepo.add(newDoc);
            selectDoc(newDoc.id);
            state.isEditing = true;
            updateUI();
            renderSidebar();
            document.getElementById('newDocModal').close();
            document.getElementById('newDocForm').reset();
        }

        function deleteDoc() {
            if (!confirm('驴Eliminar documento definitivamente?')) return;
            DocRepo.remove(state.selectedId);
            state.selectedId = state.docs.length > 0 ? state.docs[0].id : null;
            renderSidebar();
            updateUI();
        }

        function updateDoc() {
            const doc = state.docs.find(d => d.id === state.selectedId);
            if (!doc) return;
            
            const title = document.getElementById('editTitleInput').value;
            const category = document.getElementById('editCategoryInput').value;
            let content = document.getElementById('editContentInput').value;

            if (doc.type === DOC_TYPES.JSON) {
                try { content = JSON.stringify(JSON.parse(content), null, 2); }
                catch(e) { return Toast.show("JSON Inv谩lido", 'error'); }
            }
            
            DocRepo.update(state.selectedId, { title, category, content });
            state.isEditing = false;
            renderSidebar();
            updateUI();
        }

        function renderSidebar() {
            const list = document.getElementById('docList');
            list.innerHTML = '';
            
            const filtered = state.docs.filter(doc => {
                const matchesSearch = (doc.title+doc.category).toLowerCase().includes(state.searchQuery.toLowerCase());
                if (state.filterType === 'all') return matchesSearch;
                if (state.filterType === 'code') return matchesSearch && (doc.type === DOC_TYPES.HTML || doc.type === DOC_TYPES.CODE || doc.type === DOC_TYPES.JSON);
                return matchesSearch && doc.type === state.filterType;
            });

            filtered.forEach(doc => {
                const active = doc.id === state.selectedId;
                let icon = 'file-text';

                if (doc.type === DOC_TYPES.PDF) icon = 'file';
                else if (doc.type === DOC_TYPES.EXCEL) icon = 'sheet';
                else if (doc.type === DOC_TYPES.JSON) icon = 'code-2';
                else if (doc.type === DOC_TYPES.MD) icon = 'file-code';
                else if (doc.type === DOC_TYPES.IMAGE) icon = 'image';
                else if (doc.type === DOC_TYPES.HTML) icon = 'file-code';
                else if (doc.type === DOC_TYPES.CODE) icon = 'code';

                const el = document.createElement('div');
                // Uso de clases de tema para sidebar items
                el.className = `flex items-center gap-3 p-3 rounded-2xl cursor-pointer transition-all mb-1 border ${active ? 'bg-primary-50 dark:bg-primary-900/20 border-primary-100 dark:border-primary-800 shadow-sm' : 'hover:bg-gray-50 dark:hover:bg-slate-700/50 border-transparent'}`;
                el.onclick = () => selectDoc(doc.id);
                el.innerHTML = `
                    <div class="${active ? 'text-primary-600 dark:text-primary-400' : 'text-gray-400 dark:text-gray-500'} transition-colors"><i data-lucide="${icon}" class="w-5 h-5"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-sm text-slate-700 dark:text-slate-200 truncate ${active ? 'text-primary-900 dark:text-primary-100' : ''}">${doc.title}</div>
                        <div class="flex items-center gap-2 mt-0.5">
                            <span class="text-xs text-gray-400 dark:text-gray-500 truncate">${doc.category}</span>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        function updateUI() {
            const doc = state.docs.find(d => d.id === state.selectedId);
            const els = {
                empty: document.getElementById('emptyState'),
                content: document.getElementById('contentArea'),
                header: document.getElementById('headerTitle'),
                viewMode: document.getElementById('viewMode'),
                editMode: document.getElementById('editMode'),
                editActions: document.getElementById('editActions'),
                viewActions: document.getElementById('viewActions'),
                footerLeft: document.getElementById('footerLeft'),
                footerWords: document.getElementById('footerWords'),
                footerSize: document.getElementById('footerSize'),
                containers: [
                    document.getElementById('markdownContainer'),
                    document.getElementById('pdfContainer'),
                    document.getElementById('jsonContainer'),
                    document.getElementById('excelContainer'),
                    document.getElementById('imageContainer'),
                    document.getElementById('codeContainer')
                ]
            };

            if (!doc) {
                els.empty.classList.remove('hidden');
                els.content.classList.add('hidden');
                return;
            }

            els.empty.classList.add('hidden');
            els.content.classList.remove('hidden');
            els.content.classList.add('flex');
            els.header.textContent = doc.title;

            // Footer info
            els.footerSize.textContent = doc.size ? (doc.size / 1024).toFixed(1) + ' KB' : '0 KB';
            if ([DOC_TYPES.TEXT, DOC_TYPES.MD, DOC_TYPES.HTML, DOC_TYPES.CODE].includes(doc.type)) {
                els.footerWords.textContent = (doc.content.match(/\S+/g) || []).length + ' Palabras';
            } else {
                els.footerWords.textContent = '';
            }

            if (state.isEditing) {
                els.viewMode.classList.add('hidden');
                els.editMode.classList.remove('hidden');
                els.viewActions.classList.add('hidden');
                els.editActions.classList.remove('hidden');
                
                document.getElementById('editTitleInput').value = doc.title;
                document.getElementById('editCategoryInput').value = doc.category;
                document.getElementById('editContentInput').value = doc.content;
            } else {
                els.viewMode.classList.remove('hidden');
                els.editMode.classList.add('hidden');
                els.viewActions.classList.remove('hidden');
                els.editActions.classList.add('hidden');

                document.getElementById('viewCategory').textContent = doc.category;
                document.getElementById('viewDate').textContent = new Date(doc.lastModified).toLocaleDateString();

                els.containers.forEach(c => { c.classList.add('hidden'); c.classList.remove('flex'); });

                const editBtn = document.getElementById('editBtn');
                
                if (doc.type === DOC_TYPES.PDF) {
                    els.containers[1].classList.remove('hidden');
                    els.containers[1].classList.add('flex');
                    editBtn.style.display = 'none';
                    loadPdfFromData(doc.content);
                } else if (doc.type === DOC_TYPES.EXCEL) {
                    els.containers[3].classList.remove('hidden');
                    editBtn.style.display = 'flex'; 
                    loadExcelFromData(doc.content);
                } else if (doc.type === DOC_TYPES.IMAGE) {
                    els.containers[4].classList.remove('hidden');
                    els.containers[4].classList.add('flex');
                    editBtn.style.display = 'none';
                    document.getElementById('imageViewer').src = doc.content;
                } else if (doc.type === DOC_TYPES.JSON) {
                    els.containers[2].classList.remove('hidden');
                    editBtn.style.display = 'flex';
                    document.getElementById('jsonContent').innerHTML = syntaxHighlight(doc.content);
                } else if (doc.type === DOC_TYPES.HTML || doc.type === DOC_TYPES.CODE) {
                    els.containers[5].classList.remove('hidden');
                    editBtn.style.display = 'flex';
                    document.querySelector('#codeContainer pre').textContent = doc.content;
                } else {
                    els.containers[0].classList.remove('hidden');
                    editBtn.style.display = 'flex';
                    document.getElementById('viewBody').innerHTML = marked.parse(doc.content);
                }
            }
            lucide.createIcons();
        }

        function exportAllDocs() {
        const payload = {
            exportedAt: new Date().toISOString(),
            docs: state.docs
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `linked-visor-backup-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        }

        function importAllDocs(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
            const json = JSON.parse(e.target.result);
            const docs = Array.isArray(json?.docs) ? json.docs : (Array.isArray(json) ? json : null);
            if (!docs) throw new Error("Formato de backup inv谩lido");

            state.docs = docs;
            saveToStorage();
            renderSidebar();
            if (state.docs[0]) selectDoc(state.docs[0].id);
            updateUI();
            updateStorageStats();
            Toast.show("Backup importado ", "success");
            } catch (err) {
            Toast.show(err.message || "Error importando backup", "error");
            }
        };
        reader.readAsText(file);
        }


        /* =========================
   SUPABASE (AUTH + STORAGE + DB + SYNC) - FINAL
   ========================= */

const SUPABASE_URL = "https://TU-PROYECTO.supabase.co";
const SUPABASE_ANON_KEY = "TU_ANON_KEY";
const SUPABASE_BUCKET = "docs";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let sbUser = null;

/* ---------- Utils ---------- */
function isDataUrl(v){ return typeof v === "string" && v.startsWith("data:"); }

function dataUrlToBlob(dataUrl){
  const [header, base64] = dataUrl.split(",");
  const mime = header.match(/data:(.*?);base64/)?.[1] || "application/octet-stream";
  const bytes = atob(base64);
  const arr = new Uint8Array(bytes.length);
  for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
  return new Blob([arr], { type: mime });
}

function extFromDoc(doc){
  const t = doc?.type;
  if (t === "pdf") return "pdf";
  if (t === "excel") return "xlsx";
  if (t === "image") return "png";
  if (t === "json") return "json";
  if (t === "markdown") return "md";
  if (t === "html") return "html";
  if (t === "code") return "txt";
  return "txt";
}

function isBinaryType(doc){
  return doc?.type === "pdf" || doc?.type === "excel" || doc?.type === "image";
}

function isBinaryDoc(doc){
  return isDataUrl(doc?.content) && isBinaryType(doc);
}

function setAuthUI(logged){
  const btnAuth = document.getElementById("btnAuth");
  const btnLogout = document.getElementById("btnLogout");
  if (!btnAuth || !btnLogout) return;

  if (logged) {
    btnAuth.innerHTML = `<span class="inline-flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> Cuenta</span>`;
    btnLogout.classList.remove("hidden");
  } else {
    btnAuth.innerHTML = `<span class="inline-flex items-center gap-1"><i data-lucide="log-in" class="w-3 h-3"></i> Iniciar sesi贸n</span>`;
    btnLogout.classList.add("hidden");
  }
  lucide.createIcons();
}

/* ---------- Storage ---------- */
async function uploadBinaryToStorage(doc){
  const blob = dataUrlToBlob(doc.content);
  const path = `${sbUser.id}/${doc.id}.${extFromDoc(doc)}`;

  const { error } = await sb.storage.from(SUPABASE_BUCKET).upload(path, blob, {
    upsert: true,
    contentType: blob.type
  });
  if (error) throw error;
  return path;
}

async function removeBinaryFromStorage(storagePath){
  if (!storagePath) return;
  const { error } = await sb.storage.from(SUPABASE_BUCKET).remove([storagePath]);
  if (error) console.warn("Storage remove:", error.message);
}

async function signedUrl(storagePath, seconds = 3600){
  const { data, error } = await sb.storage.from(SUPABASE_BUCKET).createSignedUrl(storagePath, seconds);
  if (error) throw error;
  return data.signedUrl;
}

/* ---------- DB ---------- */
async function upsertDocToDB(doc){
  if (!sbUser) return;

  let content = doc.content ?? "";
  let storage_path = doc.storage_path || null;

  if (isBinaryDoc(doc)) {
    storage_path = await uploadBinaryToStorage(doc);
    content = null;
  }

  if (isBinaryType(doc) && storage_path && !isDataUrl(doc.content)) {
    content = null;
  }

  const payload = {
    id: doc.id,
    user_id: sbUser.id,
    title: doc.title || "Sin t铆tulo",
    category: doc.category || "General",
    type: doc.type,
    content,
    storage_path,
    size: doc.size || (typeof doc.content === "string" ? doc.content.length : 0),
    updated_at: doc.lastModified || new Date().toISOString()
  };

  const { error } = await sb.from("documents").upsert(payload, { onConflict: "id" });
  if (error) throw error;

  if (storage_path && doc.storage_path !== storage_path) {
    const idx = state.docs.findIndex(d => d.id === doc.id);
    if (idx !== -1) state.docs[idx].storage_path = storage_path;
    saveToStorage();
  }
}

async function deleteDocFromDB(doc){
  if (!sbUser || !doc) return;

  if (doc.storage_path) await removeBinaryFromStorage(doc.storage_path);

  const { error } = await sb
    .from("documents")
    .delete()
    .eq("id", doc.id)
    .eq("user_id", sbUser.id);

  if (error) throw error;
}

async function fetchAllDocsFromDB(){
  const { data, error } = await sb
    .from("documents")
    .select("*")
    .eq("user_id", sbUser.id)
    .order("updated_at", { ascending: false });

  if (error) throw error;
  return data || [];
}

/* ---------- Sync Down ---------- */
async function syncDown(){
  if (!sbUser) return;

  Toast.show("Sincronizando con Supabase", "info");

  const rows = await fetchAllDocsFromDB();
  const mapped = [];

  for (const r of rows) {
    let content = r.content ?? "";
    if (r.storage_path) content = await signedUrl(r.storage_path, 3600);

    mapped.push({
      id: r.id,
      title: r.title,
      category: r.category,
      type: r.type,
      content,
      storage_path: r.storage_path,
      lastModified: r.updated_at,
      size: r.size || 0
    });
  }

  state.docs = mapped;
  saveToStorage();
  renderSidebar();
  if (state.docs[0]) selectDoc(state.docs[0].id);
  updateUI();
  updateStorageStats();

  Toast.show("Sincronizaci贸n lista ", "success");
}

/* ---------- Patch DocRepo ---------- */
(function patchDocRepo(){
  if (!window.DocRepo) return;

  const _add = DocRepo.add.bind(DocRepo);
  const _update = DocRepo.update.bind(DocRepo);
  const _remove = DocRepo.remove.bind(DocRepo);

  DocRepo.add = function(doc){
    _add(doc);
    if (sbUser) upsertDocToDB(doc).catch(e => Toast.show(e.message || "Error subiendo", "error"));
  };

  DocRepo.update = function(id, changes){
    _update(id, changes);
    const doc = state.docs.find(d => d.id === id);
    if (sbUser && doc) upsertDocToDB(doc).catch(e => Toast.show(e.message || "Error actualizando", "error"));
  };

  DocRepo.remove = function(id){
    const doc = state.docs.find(d => d.id === id);
    _remove(id);
    if (sbUser && doc) deleteDocFromDB(doc).catch(e => Toast.show(e.message || "Error eliminando", "error"));
  };
})();

/* ---------- Auth ---------- */
async function refreshSession(){
  const { data } = await sb.auth.getSession();
  sbUser = data.session?.user || null;
  setAuthUI(!!sbUser);
  return sbUser;
}

async function signIn(email, pass){
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  if (error) throw error;
  await refreshSession();
  await syncDown();
}

async function signUp(email, pass){
  const { error } = await sb.auth.signUp({ email, password: pass });
  if (error) throw error;
  Toast.show("Registro OK. Si pide confirmaci贸n, mira tu email.", "info");
  await refreshSession();
  if (sbUser) await syncDown();
}

async function signOut(){
  await sb.auth.signOut();
  sbUser = null;
  setAuthUI(false);
  Toast.show("Sesi贸n cerrada", "info");
}

/* ======================
   DOMContentLoaded (NICO)  AL FINAL
   ====================== */
document.addEventListener("DOMContentLoaded", async () => {
  initApp();

  // ... (TU BLOQUE DE LISTENERS TAL CUAL)

  sb.auth.onAuthStateChange((_event, session) => {
    sbUser = session?.user || null;
    setAuthUI(!!sbUser);
  });

  await refreshSession();
  if (sbUser) await syncDown();

  lucide.createIcons();
});

    document.addEventListener("DOMContentLoaded", async () => {
  /* ======================
     INIT APP
  ====================== */
  initApp();

  /* ======================
     UI  AJUSTES / FILTROS
  ====================== */
  document.getElementById('openSettingsBtn').onclick = () =>
    document.getElementById('settingsModal').showModal();

  document.getElementById('filterChips').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-filter]');
    if (!btn) return;
    state.filterType = btn.dataset.filter;
    renderSidebar();
  });

  /* ======================
     BACKUP IMPORT / EXPORT
  ====================== */
  document.getElementById('importAllInput').onchange = (e) => {
    const f = e.target.files?.[0];
    if (f) importAllDocs(f);
    e.target.value = '';
  };

  /* ======================
     DRAG & DROP
  ====================== */
  const overlay = document.getElementById('dropOverlay');
  let dragCount = 0;

  document.body.addEventListener('dragenter', (e) => {
    e.preventDefault();
    dragCount++;
    if (dragCount === 1) overlay.classList.remove('hidden');
  });

  document.body.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dragCount--;
    if (dragCount <= 0) {
      dragCount = 0;
      overlay.classList.add('hidden');
    }
  });

  document.body.addEventListener('dragover', e => e.preventDefault());

  document.body.addEventListener('drop', (e) => {
    e.preventDefault();
    dragCount = 0;
    overlay.classList.add('hidden');
    if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
  });

  document.getElementById('fileInput').onchange = (e) => {
    processFile(e.target.files[0]);
    e.target.value = '';
  };

  /* ======================
     NUEVO DOC / EDICIN
  ====================== */
  document.getElementById('openNewDocModalBtn').onclick = () =>
    document.getElementById('newDocModal').showModal();

  document.getElementById('newDocForm').onsubmit = createNewDocFromModal;

  document.getElementById('importDocBtn').onclick = () =>
    document.getElementById('fileInput').click();

  document.getElementById('saveBtn').onclick = updateDoc;
  document.getElementById('editBtn').onclick = () => { state.isEditing = true; updateUI(); };
  document.getElementById('cancelBtn').onclick = () => { state.isEditing = false; updateUI(); };

  /* ======================
     SEARCH / SIDEBAR
  ====================== */
  document.getElementById('searchInput').oninput = (e) => {
    state.searchQuery = e.target.value;
    renderSidebar();
  };

  document.getElementById('openSidebarBtn').onclick = () =>
    document.getElementById('sidebar').classList.remove('-translate-x-full');

  document.getElementById('closeSidebarBtn').onclick = () =>
    document.getElementById('sidebar').classList.add('-translate-x-full');

  /* ======================
     MENU CONTEXTUAL
  ====================== */
  const menuBtn = document.getElementById('menuBtn');
  const menuDropdown = document.getElementById('menuDropdown');

  menuBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    menuDropdown.classList.toggle('hidden');
  });

  document.addEventListener('click', () => menuDropdown.classList.add('hidden'));

  menuDropdown.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;

    const action = btn.dataset.action;
    if (action === 'exportDoc') downloadDoc();
    else if (action === 'exportAll') exportAllDocs();
    else if (action === 'importAll') document.getElementById('importAllInput').click();
    else if (action === 'delete') deleteDoc();

    menuDropdown.classList.add('hidden');
  });

  /* ======================
     SUPABASE  AUTH
  ====================== */
  document.getElementById("btnAuth")?.addEventListener("click", () => {
    document.getElementById("authModal")?.showModal();
  });

  document.getElementById("btnLogout")?.addEventListener("click", () => signOut());

  document.getElementById("btnSignIn")?.addEventListener("click", async () => {
    try {
      const email = document.getElementById("authEmail").value.trim();
      const pass = document.getElementById("authPass").value;
      await signIn(email, pass);
      document.getElementById("authModal").close();
      Toast.show("Sesi贸n iniciada ", "success");
    } catch (e) {
      Toast.show(e.message || "Error login", "error");
    }
  });

  document.getElementById("btnSignUp")?.addEventListener("click", async () => {
    try {
      const email = document.getElementById("authEmail").value.trim();
      const pass = document.getElementById("authPass").value;
      await signUp(email, pass);
      document.getElementById("authModal").close();
    } catch (e) {
      Toast.show(e.message || "Error registro", "error");
    }
  });

  sb.auth.onAuthStateChange((_event, session) => {
    sbUser = session?.user || null;
    setAuthUI(!!sbUser);
  });

  await refreshSession();
  if (sbUser) await syncDown();

  lucide.createIcons();
});

    </script>
</body>
</html>
